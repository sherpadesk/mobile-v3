function default_redirect(){window.location=isTech?"dashboard.html":"ticket_list.html"}function googleTag(){_gaq.push(["_setAccount","UA-998328-15"]),_gaq.push(["_trackPageview"]),function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()}function googleConversion(){var e=new Image,t=document.getElementById("body");e.onload=function(){t.appendChild(e)},e.src="http://www.googleadservices.com/pagead/conversion/1040470683/?value=1.00&currency_code=USD&label=KRf-CIfZrQQQm6WR8AM&guid=ON&script=0"}function ok(){}function fail(e){alert(e)}function initOrgPreferences(e){if(window.cordova){var t=plugins.appPreferences;if(t){var o=t.iosSuite("group.io.sherpadesk.mobile");o.store(ok,fail,"org",e)}}}function clearStorage(e){isPhonegap&&initOrgPreferences("");var t=localStorage.userName||"",o=localStorage.appVersion||"",i=localStorage.loadTicketNumber||"",i=localStorage.loadTicketNumber||"",a=localStorage.ios_action||"",s=localStorage.loadOrgKey||"",n=localStorage.isPhonegap||"",c=localStorage.userKey||"";window.dontClearCache||localStorage.clear(),localStorage.userKey="",localStorage.userOrgKey="",localStorage.userInstanceKey="",localStorage.setItem("userName",t),localStorage.appVersion=o,localStorage.loadTicketNumber=i,localStorage.ios_action=a,localStorage.loadOrgKey=s,localStorage.isPhonegap=n,e&&(localStorage.userKey=c),isExtension&&window.top.postMessage("logout","*")}function logout(e,t){clearStorage(),localStorage.is_google?(localStorage.removeItem("userName"),localStorage.removeItem("is_google"),GooglelogOut()):window.location="login.html".addUrlParam("f",t)}function getParameterByName(e){var t=RegExp("[?&]"+e+"=([^&]*)").exec(window.location.href);return t&&decodeURIComponent(t[1].replace(/\+/g," "))}function cleanQuerystring(){try{window.history.replaceState({},"",location.origin+location.pathname)}catch(e){}}function updatedFunction(){location.reload(!0)}function noop(){}function getDateTimeFormat(){return("1"!==localStorage.dateformat?"m/d/Y":"d/m/Y")+("1"!==localStorage.timeformat?" h:i A":" H:i")}function getDateTime(e){return new Date(e).dateFormat(getDateTimeFormat())}function getFullName(e,t,o,i){var a="";return i&&(a=i+" "),t&&(a+=t+" "),e&&(a+=e+" "),o&&o.indexOf("@")>0&&(a.trim()?i&&(a+=" ("+o+")"):a=o),a||"NoName"}function checkEmail(e){return null!==e.trim().match(/^[^@\s]+@[^@\s]+(\.[^@\s]+)+$/i)}function checkURL(e){return e?null!==e.trim().match(/(jpeg|jpg|gif|png)$/i):!1}function errorLine(e){var t="location.reload(false)";$("#scroller").hide(),$(".catch-error").length||$("body").prepend('<div class="catch-error"><div class="catch-error-description"><h2>&nbsp;</h2><h2>&nbsp;</h2><h2>Something went wrong...</h2><div id="ctl00_PageBody_StackTrace" class="return-button"><p /><p /><h4>'+e+'</h4><h4>&nbsp;<p>P.S.  Uh... a Yeti just attacked your  camp!</h4><center><button class=loginButton loginGoogle style="width: 200px;" onclick="'+t+'">Refresh</button></center></div></div>')}function offLine(){var e="redirectToPage()";isOnline=!1,$(".catch-error").length||window.dontClearCache||$("body").prepend('<div class="catch-error"><div class="catch-error-description"><h2>&nbsp;</h2><h2>&nbsp;</h2><h2>Check your internet connection!</h2><div id="ctl00_PageBody_StackTrace" class="return-button"><p /><p /><h4>P.S.  Uh... a Yeti just attacked your  camp!</h4><center><button class=loginButton loginGoogle style="width: 200px;" onclick="'+e+'">Refresh</button></center></div></div>')}function onLine(){isOnline||($(".catch-error").remove(),location.reload(!1)),isOnline=!0}function redirectToPage(){if(navigator.onLine)if(isPhonegap)onLine();else{var e=document.body.appendChild(document.createElement("img"));e.style.display="none",e.onload=function(){onLine()},e.onerror=function(){offLine()},e.src=MobileSite+"img/select_arrow.png?rand="+Math.random()}else offLine()}function onDeviceReady(){if(localStorage.isPhonegap="true",isPhonegap=!0,updateStatusBar){var e=document.getElementsByTagName("header")[0];e&&(e.style.paddingTop="13px",e.style.height="63px",$("body").css("margin-top",function(e,t){return parseInt(t,10)+18+"px"})),e=document.getElementById("ptr"),e&&(e.style.marginTop="18px"),"dashboard.html"==Page&&$("#techStat").css("padding-top","18px")}("login.html"==Page||"ticket_list.html"==Page&&!isTech||"dashboard.html"==Page)&&googleConversion()}function updateBadge(){window.cordova&&cordova.plugins.notification.badge&&(localStorage.badge>0?cordova.plugins.notification.badge.set(localStorage.badge):cordova.plugins.notification.badge.clear())}function isStorage(){var e="modernizr";try{return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(t){return errorLine("Please enable Cookies to work with site!"),!1}}function openURL(e){return window.open(e,"_blank","location=no,EnableViewPortScale=yes")}function openURLsystem(e){return window.open(e,"_system")}function reveal(){$("#loading").hide1(),$("input.search").length&&$("input.search").prop("readonly","")}function PullToRefresh(){"object"==typeof WebPullToRefresh&&WebPullToRefresh.init({loadingFunction:function(){"dash"===cacheName?(localStorage.setItem("storageQueues",""),localStorage.setItem("storageAccountList",""),localStorage.setItem("ticketsStat","")):localStorage.setItem(cacheName,""),location.reload(!1)}})}function loading(e){$("input.search").length&&$("input.search").prop("readonly","readonly"),(!noLoading||e)&&$("#loading").show1()}function GooglelogOut(e){if(isExtension||confirm("Do you want to stay logged in Google account?"))window.location="login.html"+e;else{document.location.href=MobileSite+"login.html".addUrlParam("f",e)}}function getInfo4Extension(){if(isExtension){var e="login?t="+localStorage.getItem("userKey")+"&o="+localStorage.getItem("userOrgKey")+"&i="+localStorage.getItem("userInstanceKey");window.top.postMessage(e,"*")}}function fullapplink(e,t){return isPhonegap?$("."+e).on("click",function(e){e.preventDefault(),openURLsystem(t)}):isExtension?$("."+e).on("click",function(e){e.preventDefault();var o=window.__proto__.open;o.apply(window,[t,"_blank"])}):($("."+e).attr("target","_blank"),$("."+e).attr("href",t)),t}function htmlEscape(e){return String(e).replace(/&/g,"&amp;amp;").replace(/&quot;/g,"&amp;quot;").replace(/&apos;/g,"&amp;apos;").replace(/&lt;/g,"&amp;lt;").replace(/&gt;/g,"&amp;gt;").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function symbolEscape(e){return String(e).replace(/&lt;br&gt;/gi,"\n").replace(/<br\s*[\/]?>/gi,"\n").replace(/\n/g,"<p></p>")}function filterList(e,t,o){$("body").attr("id","search_wrap"),o?o&&(o=o.split(",")):o=["blockNumber","responseText","TicketBlockNumber","user_name","ticketlocation","locationtick"];var i={listClass:e,item:"item",valueNames:o};return featureList=new List("search_wrap",i),t=t||$(".search").val(),t&&(featureList.search(t),$(".search").val(t)),featureList}function createSpan(e){var t=$(window).height(),o=$("#content").height();t>o+60&&(o=t-o-60,$("<p id=fill style='height:"+o+"px'>&nbsp;</p>").appendTo(e+""))}function showError(e){var t=e.data||(((e||{}).responseJSON||{}).ResponseStatus||{}).Message||e.statusText;setTimeout(function(){reveal(),userMessage.showMessage(!1,t||"Error. Please contact Administrator")},2e3)}function getApi(e,t,o){return userKey=localStorage.getItem("userKey"),userOrgKey=localStorage.getItem("userOrgKey"),userInstanceKey=localStorage.getItem("userInstanceKey"),userKey&&userOrgKey&&userInstanceKey&&32==userKey.length?(o||(o="GET"),$.ajax({type:o,beforeSend:function(e){e.withCredentials=!0,e.setRequestHeader("Authorization","Basic "+btoa(userOrgKey+"-"+userInstanceKey+":"+userKey))},url:ApiSite+e,cache:!0,data:t,dataType:"json"}).promise()):void console.log("Invalid organization!")}function handleOpenURL(e){var t=e.substring(13).replace("#","?");t=t.replace("#","?"),console.log("main url: "+t+" loc:"+location.href.substring(location.origin.length+1)),location.href.substring(location.origin.length+1)!=t&&(localStorage.setItem("ios_action",t||""),t&&location.reload(!0))}var _gaq=_gaq||[],isSD=!0,Site="sherpadesk.com/",MobileSite="http://m."+Site,AppSite="https://app."+Site,ApiSite="http://api."+Site;document.title=(localStorage.badge&&"0"!==localStorage.badge?"("+localStorage.badge+") ":"")+(isSD?"SherpaDesk":"HelpDesk");var year="2015",appVersion="35",Page=location.href.split("/").pop().split("?").shift(),isExtension=window.self!==window.top;isExtension&&localStorage.setItem("referrer",Page);var adMessage="Perfomance update",updateStatusBar=navigator.userAgent.match(/iphone|ipad|ipod/i)&&parseInt(navigator.appVersion.match(/OS (\d)/)[1],10)>=7,isTech=!1,isProject=!0,isTime=!0,isAccount=!0,isLevel=!0,isClass=!0,isLocation=!0,isFreshbook=!0,isExpenses=!0,isTravelCosts=!0,isInvoice=!0,is_MultipleOrgInst=!0,isLimitAssignedTkts=!0,isQueues=!0,formatDate=function(e){if(!e||e.length<12)return e;var t=e.substring(0,4),o=e.substring(5,7),i=e.substring(8,10);switch(o){case"01":o="Jan";break;case"02":o="Feb";break;case"03":o="Mar";break;case"04":o="Apr";break;case"05":o="May";break;case"06":o="Jun";break;case"07":o="Jul";break;case"08":o="Aug";break;case"09":o="Sep";break;case"10":o="Oct";break;case"11":o="Nov";break;case"12":o="Dec";break;default:o="nul"}return o+"&nbsp;"+i+(year!=t?"&nbsp;/&nbsp;"+t:"")};$.fn.show1=function(){this[0]&&(this[0].style.display="block")},$.fn.hide1=function(){this[0]&&(this[0].style.display="none")};var cacheName="",cacheTime=5e3;"function"!=typeof String.prototype.addUrlParam&&(String.prototype.addUrlParam=function(e,t){if(!t||!e)return this;var o=this.indexOf(e+"=");if(-1!=o)return this.slice(0,o+e.length)+"="+t;var i=this.indexOf("?")>0?"&":"?";return this+i+e+"="+t});var isPhonegap="true"===localStorage.isPhonegap,isOnline=!0;document.addEventListener("deviceready",onDeviceReady,!1),document.addEventListener("offline",offLine,!1),document.addEventListener("online",onLine,!1),$(document).ajaxStop(function(){setTimeout(function(){reveal(),$("body").show1()},1e3)}),$(document).ajaxError(function(e,t,o){(403==t.status&&o.url!==ApiSite+"organizations"||404==t.status&&o.url===ApiSite+"config")&&logout(o.url!==ApiSite+"login",t.statusText),setTimeout(function(){reveal(),$("body").show1(),console.log("ajaxError:"+t.statusText+" page: "+o.url),redirectToPage()},1e3)}),window.onerror=function(e,t,o,i,a){var s=i?"<p>column: "+i:"";s+=a?"<p>error: "+a:"",o>0&&setTimeout(function(){errorLine("<p onclick='$(\".err\").toggle();'>Click for Error Details:</p><div class=err style='display:none;'>"+e+"<p>page: "+location.href+"<p>url: "+t+"<p>line: "+o+s+"</div>"),reveal(),$("body").show1(),console.log("onerror:"+e+" page: "+location.href+" url: "+t+" line: "+o+s)},2e3);var n=!0;return n},window.addEventListener("load",PullToRefresh,!1);var noLoading=!1;window.onbeforeunload=loading;var userMessage={init:function(){this.showMessage()},setMessage:function(e,t,o){localStorage.setItem("userMessage",t),localStorage.setItem("isMessage",e?"truePos":"trueNeg"),"function"==typeof o&&setTimeout(o,1500)},showMessage:function(e,t,o){if(setTimeout(reveal,500),"undefined"==typeof e){var i=localStorage.getItem("isMessage");if("truePos"==i)e=!0,localStorage.setItem("isMessage","false");else{if("trueNeg"!=i)return;e=!1,localStorage.setItem("isMessage","false")}}t||(t=localStorage.getItem("userMessage"));var a=e?".errorMessagePos":".errorMessageNeg",s=$(a);return s.length?(s.html(t),s.slideDown(100),void setTimeout(function(){s.slideUp(100),"function"==typeof o&&o()},3500)):(isExtension||alert(t),void("function"==typeof o&&o()))}},FileUrlHelper={ReplaceAll:function(e,t,o){return e.split(t).join(o)},matchKey:function(e,t){for(var o in t)if(-1!=o.indexOf(e))return o;return""},addUrls:function(e,t){var o=t.length,i={};if(o){for(var a=e.match(/\[cid:[^\[\]]*]/g),s=0;o>s;s++){var n=t[s].name;e=FileUrlHelper.ReplaceAll(e," "+n,t[s].is_deleted?"":FileUrlHelper.getFileLink(t[s].url,n)),i['"'+n.substring(0,n.lastIndexOf("."))+'"']=t[s].url}if(a)for(var c=0;c<a.length;c++){var l=a[c].slice(5,-1);l.indexOf("_link_")>=0?l=l.replace("_link_",""):(l=FileUrlHelper.matchKey(l.slice(0,-3),i),l=l&&"undefined"!=typeof i[l]?i[l]:""),l.length&&(e=FileUrlHelper.ReplaceAll(e,a[c],FileUrlHelper.getFileLink(l,a[c].slice(5,-1))))}o>1&&(e=FileUrlHelper.ReplaceAll(e,"a>,","a>")),e=FileUrlHelper.ReplaceAll(e,"a>.","a>")}return e},getFileLink:function(e,t){var o="";return o=checkURL(e)||checkURL(t)?'<img class="attachment" src="'+e+'">':"<i class='ion-android-document ion-3x ionColor'></i> &nbsp;"+(t||decodeURIComponent(e.split("/").slice(-1)))+"<p></p>",'<p/><a class="comment_image_link"'+(isPhonegap?" href=# onclick='openURL(\""+e+"\")'>"+o+"</a>":' target="_blank" href="'+e+'">'+o+"</a>")}},featureList,featureList2,featureList3,featureList4,featureList5,userOrgKey="",userOrg="",userInstanceKey="",userKey="",accountDetailed="",selectedEditClass;$(document).ready(function(){function e(e,t,o,i,a,s,n,c,r){var u=$(""+t);if(!e||!e.length)return u.parent().hide(),0;var g,d=!1;a&&a.length>0&&(g=a.split(","),g.length>0&&(d=!0)),i=i||"",o=o||"",s=s||"",n=n||"";var m=o,h=0;for(h=0;h<e.length;h++){var p=e[h].id||e[h].user_id,f="";if(d){for(var v=g.length-1,k=0;v>k;k++){var _=e[h][g[k]];_&&(f+=" "+_)}var S=e[h][g[v]]||"";S&&S.indexOf("@")>0&&(f.trim()?f+=" ("+S+")":f=S)}else f=e[h].name;m+="<option value="+p+">"+i+(f||"NoName")+"</option>"}return h>0?($(""+s+m+n).appendTo(""+t),u.parent().show(),u.parent().parent().show(),r||u.select2(c||l)):u.parent().hide(),h}function t(t,o,i){return isClass?(e(t,o,i,"Class: "),void $(""+o).on("change",function(){$(".sub_class1, .sub_class2").is(":visible")&&($(".sub_class1, .sub_class2").hide(),$("#sub_class1, #sub_class2").empty());var i=$(o+" option:selected").val(),a=$.grep(t,function(e){return e.id==i});selectedEditClass=i,"undefined"!=typeof a[0]&&(null!==a[0].sub||a[0].sub>0)&&(e(a[0].sub,"#sub_class1","<option value="+selectedEditClass+">choose a sub class</option>","Sub class: "),$("select#sub_class1").on("change",function(){$(".sub_class2").is(":visible")&&($(".sub_class2").hide(),$("#sub_class2").empty());var t=$("select#sub_class1 option:selected").val(),o=$.grep(a[0].sub,function(e){return e.id==t});selectedEditClass=t,"undefined"!=typeof o[0]&&(o[0].sub>0||null!==o[0].sub)&&(e(o[0].sub,"#sub_class2","<option value="+selectedEditClass+">Sub Sub Class: ---</option>","Sub Sub Class: "),$("select#sub_class2").on("change",function(){var e=$("select#sub_class2 option:selected").val();selectedEditClass=e}))}))})):void $(""+o).parent().parent().hide()}function o(e){if(e&&(Page=e),"tech"===localStorage.getItem("userRole")?isTech=!0:$(".sideNavLinks").children(":not('.user')").hide(),"false"===localStorage.getItem("projectTracking")&&(isProject=!1),"false"===localStorage.getItem("timeTracking")&&(isTime=!1,$(".time").remove()),"false"===localStorage.getItem("accountManager")&&(isAccount=!1,$("#itemAccount").hide()),"false"===localStorage.getItem("ticketLevels")&&(isLevel=!1),"false"===localStorage.getItem("classTracking")&&(isClass=!1),"false"===localStorage.getItem("locationTracking")&&(isLocation=!1),"false"===localStorage.getItem("freshbooks")&&(isFreshbook=!1),"false"===localStorage.getItem("is_invoice")&&(isInvoice=!1,$("#itemInvoice").hide(),$("#itemUnInvoice").hide()),"false"===localStorage.getItem("is_expenses")&&(isExpenses=!1,$(".expense").hide()),"false"===localStorage.getItem("is_travel_costs")&&(isTravelCosts=!1),"false"===localStorage.getItem("is_limit_assigned_tkts")&&(isLimitAssignedTkts=!1),isQueues||$("#itemQueues").hide1(),"false"===localStorage.getItem("sd_is_MultipleOrgInst")?(is_MultipleOrgInst=!1,$("#switchOrg").hide()):$("#switchOrg").show(),isPhonegap&&setInterval(function(){x.queues(4,"")},12e4),fullapplink("fullapplink",AppSite+"?dept="+localStorage.getItem("userInstanceKey")+"&org="+localStorage.getItem("userOrgKey")),m.init(),d.init(),U(),localStorage.ticketNumber&&"ticket_list.html"==Page&&(Page="ticket_detail.html"),"ticket_list.html"==Page)return $(".ticket_detail").hide(),$(".ticket_list").show(),localStorage.DetailedAccount=localStorage.addAccountTicket="",void S.init();if("ticket_detail.html"==Page)return window.location.href.indexOf("ticket_detail")<0&&(window.backFunction=function(){localStorage.setItem("ticketNumber",""),o("ticket_list.html")}),$(".ticket_detail").show(),$(".ticket_list").hide(),b.init(),T.init(),w.init(),void I.init();if(isTech){if("dashboard.html"==Page){localStorage.DetailedAccount=localStorage.addAccountTicket="";var t=localStorage.getItem("userOrg");return t&&$("#indexTitle").html(t),E.init(),x.init("#DashBoradQueues",3),isAccount&&L.init("#activeList",1),void p.init()}if("Account_List.html"==Page&&isAccount)return localStorage.DetailedAccount=localStorage.addAccountTicket="",void L.init("#fullList");if("todos.html"==Page)return void O.init();if("allInvoice_List.html"==Page&&isTime&&isInvoice)return void P.init();if("Queues.html"==Page)return void x.init("#queuesPage");if("queueTickets.html"==Page)return void M.init();if("closedTickets.html"==Page)return void g.init();if("addTicketTime.html"==Page&&isTime)return void _.init();if($(document).on("click",".timelog",function(){localStorage.setItem("timeNumber",$(this).attr("data-info")),window.location="edit_time.html"}),"timelog.html"==Page&&isTime)return void N.init()}var i=Page+"_ref",a=localStorage.getItem(i);if(a&&a!==location.href||localStorage.setItem(i,document.referrer||localStorage.referrer||"login.html"),window.backFunction=function(){var e=localStorage.getItem(i);e?(localStorage.setItem(i,""),window.location.replace(e)):history.length<3?window.location="login.html":history.back()},isTech){if("account_details.html"==Page&&isAccount)return j.init(),void g.pageChange();if("accountTimes.html"==Page&&isTime&&isAccount)return void C.init();if("expen.html"==Page&&isTime)return void A.init();if("Invoice_List.html"==Page&&isTime&&isInvoice)return void P.init();if("unInvoice_List.html"==Page&&isTime&&isInvoice)return void P.init("unbilled");if("invoice.html"==Page&&isTime&&isInvoice)return void y.init();if("add_time.html"==Page&&isTime)return void _.init();if("add_user.html"==Page)return void k.init();if("addExpence.html"==Page&&isExpenses)return void f.init();if("adjustment.html"==Page)return void v.init();if("edit_time.html"==Page&&isTime)return void _.init(!0)}return"add_tickets.html"==Page?void h.init():void default_redirect(isTech)}var i=function(e){var t,o=!1;return function(){return o?t:(o=!0,t=e.apply(this,arguments),e=null,t)}},a=new Image;a.src=MobileSite+"img/error-background.png";var s,n,c,l={minimumResultsForSearch:25,width:"95%"},r={init:function(){if(isStorage()){var e=getParameterByName("t"),t=getParameterByName("e");if(e)return cleanQuerystring(),localStorage.setItem("is_google",!0),localStorage.setItem("userKey",e),localStorage.setItem("userName",t.replace("#","")),void(window.location="org.html");var o=getParameterByName("f");o&&(cleanQuerystring(),userMessage.showMessage(!1,o)),this.login()}},do_login:function(){var e=$("#userName").val(),t=$("#password").val();return""===e||""===t?void userMessage.showMessage(!1,"Please enter a valid Email or Password"):(localStorage.setItem("userName",e),void $.ajax({type:"POST",beforeSend:function(o){o.withCredentials=!0,o.setRequestHeader("Authorization","Basic "+btoa(e+":"+t))},url:ApiSite+"login",dataType:"json",success:function(t){localStorage.setItem("userKey",t.api_token),localStorage.setItem("userName",e),window.location="org.html"},complete:function(){},error:function(){e&&-1!=e.indexOf("@gmail.com")?userMessage.showMessage(!1,"Wrong Password, Google sign password is not neeeded"):(userMessage.showMessage(!1,"There was a problem with your login.  Please try again."),$("#password").val(""))}}))},login:function(){isSD||$(".sdonly").remove();var e=localStorage.getItem("userName");null!==e&&e.length>0&&$("#userName").val(e),$("#login_signup").on("click",function(e){e.preventDefault(),document.location.href="signup.html"}),$("form.google_openid").get(0).setAttribute("action",ApiSite+"auth/auth0"),$("#sign_in_with_google").on("click",function(e){if(e.preventDefault(),isPhonegap){var t=openURL($("form.google_openid").prop("action"));return void t.addEventListener("exit",function(){localStorage.lastclick="",window.location="dashboard.html"})}$("form.google_openid").get(0).submit()}),$("#loginButton").click(function(){r.do_login()}),$(document).on("keypress","#password, #userName",function(e){13==e.which&&r.do_login()})}},u={init:function(){var e=localStorage.getItem("userName");null!==e&&e.length>0&&$("#email").val(e),$("#signupButton").click(function(){u.add()}),$(document).on("change","#name",function(){var e=$("#name").val();e&&$("#url").val(e.toLowerCase().replace(/[^a-zA-Z0-9-]/g,""))}),$("#is_force_registration").prop("checked",!1),reveal()},add:function(){var e=$("#name").val().trim(),t=$("#email").val().trim(),o=$("#url").val().toLowerCase().replace(/[^a-zA-Z0-9-]/g,""),i=$("#firstname").val(),a=$("#lastname").val(),s=$("#password").val(),n=$("#password_confirm").val(),c=$("#how").val();if(""===e||""===t)return void userMessage.showMessage(!1,"Please enter name and email!");if(s){if(s!=n)return void userMessage.showMessage(!1,"Passwords do not match!");if(s.length<5)return void userMessage.showMessage(!1,"Password too weak! Must be more that 5 letters")}$.ajax({type:"POST",url:ApiSite+"organizations",dataType:"json",data:{name:e,email:t,url:o,is_force_registration:$("#is_force_registration").is(":checked"),firstname:i,lastname:a,password:s,password_confirm:n,how:c,note:isPhonegap?"registered by iPhone app":"registered from m.sherpadesk.com"},success:function(e){return e.api_token?e.organization&&e.instance?(localStorage.setItem("userKey",e.api_token),localStorage.setItem("userName",t),localStorage.setItem("userOrgKey",e.organization),localStorage.setItem("userInstanceKey",e.instance),localStorage.setItem("userRole","user"),void userMessage.showMessage(!0,"Thanks for registration! You are redirected to new org now ...",function(){D(e.organization,e.instance)})):void(window.location="org.html"):void(window.location="login.html")},error:function(e){return 409==e.status?(userMessage.showMessage(!1,"This email is already in use. Please choose action below"),localStorage.setItem("userName",$("#email").val()),$("#is_force_registration").prop("checked",!0),$("#signupButton").before("<center><h3 style='padding-top: 10px;'>This email is already in use. Would you like to</h3> <div class=loginButton loginGoogle onclick='window.location = \"login.html\"'>Login</div><h3>or</h3></center>"),void $("#signupButton").text("Create New Organization")):void userMessage.showMessage(!1,e.responseText)}})}},g={init:function(){"truePos"==localStorage.getItem("isMessage")&&userMessage.showMessage(!0),S.getTickets("closed"),this.pageChange()},pageChange:function(){g.pageChange=noop,$(".buttonShowClosedTickets").click(function(){window.location="closedTickets.html"})}},d={init:function(){this.logOut()},logOut:function(){$("#signOut").click(logout)}},m={init:function(){this.changeOrg()},changeOrg:function(){is_MultipleOrgInst&&$("#switchOrg").click(function(){clearStorage(!0),window.location="org.html"})}},h={init:function(){var e=function(e){localStorage.setItem("add_user_type",e?"tech":"");var t=$("#addTicketUser").val();t&&(localStorage.setItem("add_user_userid",t),localStorage.setItem("add_user_username",$("#addTicketUser").find(":selected").text()));var o=$("#addTicketTechs").val();o&&(localStorage.setItem("add_user_techid",o),localStorage.setItem("add_user_techname",$("#addTicketTechs").find(":selected").text()));var i=$("#timeAccounts").val();i&&(localStorage.setItem("add_user_accountid",i),localStorage.setItem("add_user_accountname",i)),window.location="add_user.html"};isTech&&(loading(),$("#userCreate").on("click",function(){e()}),$("#TechCreate").on("click",function(){e(!0)})),this.addTicket()},getSearch:function(t,o,i,a,s,n){if(n||loading(),"users"==o)return void h.getSearchAjax(t,o,i,a,s);var c=30,l=getApi((o+i).addUrlParam("limit",c)),r=0;l.done(function(n){if(r=n.length,c>r){var l="<option value=0 disabled "+(a?"":"selected ")+">choose "+o.toLowerCase().slice(0,-1)+"</option>";a&&!$.grep(n,function(e){return e.id===a}).length&&(l+="<option value="+a+" selected>"+s+"</option>"),e(n,t,l,"","name,firstname,lastname,email"),a&&$(""+t).val(a).trigger("change")}else h.getSearchAjax(t,o,i,a,s)})},getSearchAjax:function(e,t,o,i,a){var s=i?"<option value="+i+" selected>"+a+"</option>":"<option value=0 disabled selected>choose "+t.toLowerCase().slice(0,-1)+"</option>";$(""+e).append(s),$(e).select2({width:"95%",ajax:{beforeSend:function(e){e.withCredentials=!0,e.setRequestHeader("Authorization","Basic "+btoa(userOrgKey+"-"+userInstanceKey+":"+userKey))},url:ApiSite+t+o,dataType:"json",delay:800,data:function(e){return{search:e.term}},processResults:function(e){var t=[];return $.each(e,function(e,o){var i=getFullName(o.firstname,o.lastname,o.email,o.name);t.push({id:o.id,text:i})}),25==t.length&&t.push({id:-1,text:"input search for more...",disabled:!0}),{results:t}},error:function(){console.log("fail @ search on "+Page)},cache:!0},minimumInputLength:3}),i&&$(""+e).val(i).trigger("change")},getLocations:function(e,t,o,i){return isLocation?($("#ticket_Location").empty(),void h.getSearch("#ticket_Location","locations","?account="+e,t,o,i)):void $("#ticket_Location").parent().hide1()},addTicket:function(){$("#timeAccounts").empty();var e=localStorage.getItem("addAccountTicket"),o=Number(localStorage.getItem("add_user_accountid"))||Number(localStorage.getItem("account_id"))||-1;if(e=e?e:o,localStorage.setItem("addAccountTicket",""),isTech){if(isAccount)e&&localStorage.setItem("add_user_accountid",""),h.getSearch("#timeAccounts","accounts","?is_with_statistics=false",e,localStorage.userOrg),$("#timeAccounts").on("change",function(){var e=$("#timeAccounts").val();_.chooseProjects(e,0,0),h.getLocations(e)});else{$("#timeAccounts").parent().hide1();var i=Number(localStorage.getItem("account_id"))||-1;h.getLocations(i),_.chooseProjects(i,0,0)}var a=localStorage.getItem("add_user_userid");a?localStorage.setItem("add_user_userid",""):a=localStorage.getItem("userId");var s=localStorage.getItem("add_user_username");s?localStorage.setItem("add_user_username",""):s=localStorage.getItem("userFullName"),s.trim()||(s=localStorage.getItem("userName")),h.getSearch("#addTicketUser","users","?account="+e,a,s);var n=localStorage.getItem("add_user_techid"),c=localStorage.getItem("add_user_techname");n&&(localStorage.setItem("add_user_techid",""),localStorage.setItem("add_user_techname","")),h.getSearch("#addTicketTechs","technicians","",n,c);var l=getApi("classes");l.done(function(e){t(e,"#classTicketOptions","<option value=0 disabled selected>choose a class</option>")})}else $("#istech").hide1();$("#submitNewTicket").click(function(){loading(),console.log(1);var e=htmlEscape($("#addTicketSubject").val().trim()),t=htmlEscape($("#addTicketInitPost").val().trim());if(""===e||""===$("#addTicketTechs").val()||1>selectedEditClass)userMessage.showMessage(!1,"Please enter subject");else if(e.length>100)userMessage.showMessage(!1,"Subject should be less 100 chars!");else if(t.length>5e3)userMessage.showMessage(!1,"Details cannot be more than 5000 chars!");else{var o=getApi("tickets",{status:"open",subject:e,initial_post:t,class_id:selectedEditClass,account_id:$("#timeAccounts").val(),location_id:$("#ticket_Location").val(),user_id:isTech?$("#addTicketUser").val():localStorage.getItem("userId"),tech_id:$("#addTicketTechs").val()},"POST");o.then(function(){userMessage.setMessage(!0,"Ticket was Succesfully Created :)"),isTech?backFunction():location.replace("ticket_list.html")},function(e){showError(e),console.log("fail @ tickets")})}})}},p={init:function(){this.universalSearch()},universalSearch:function(){$(document).on("keypress","#searchThis",function(e){if(13==e.which){var t=$(".headerSearch").val().toLowerCase();return void(isNaN(t)?(localStorage.setItem("searchItem",t),localStorage.setItem("ticketPage",isLimitAssignedTkts?"tech":"all"),window.location="ticket_list.html"):(localStorage.setItem("ticketNumber",t),window.location="ticket_list.html"))}})}},f={init:function(){this.addExpence(getParameterByName("ticket"))},addExpence:function(e){var t=localStorage.DetailedAccount?localStorage.DetailedAccount:-1,o=0;!isAccount||e?($("#timeAccounts").parent().hide(),reveal()):(h.getSearch("#timeAccounts","accounts","?is_with_statistics=false",t,localStorage.userOrg),$("#timeAccounts").on("change",function(){_.chooseProjects(0,0,0)})),!isProject||e?($("#timeProjects").parent().hide(),reveal()):_.chooseProjects(t,o,0),$("#addexpenseButton").click(function(){$("#loading").show1();var t=$("#expenseAmount").val();if(!t)return void userMessage.showMessage(!1,"Please enter amount");var o=htmlEscape($("#expenseNote").val()).trim();return o.length<1?void userMessage.showMessage(!1,"Please enter note"):void getApi("expenses",{ticket_key:e?e:null,account_id:e?null:$("#timeAccounts").val(),project_id:e?null:$("#timeProjects").val(),tech_id:localStorage.getItem("user_id"),note:o,note_internal:$("#expenseInternal").val(),amount:t,is_billable:$(".innerCircle").hasClass("billFill"),vendor:$("#vendor").val()},"POST").then(function(){localStorage.setItem("isMessage","truePos"),localStorage.setItem("userMessage",'Expense was successfully added <i class="ion-cash"></i>'),backFunction()},function(e){showError(e),console.log("fail @ pickup")})})}},v={init:function(){this.Adjustment()},Adjustment:function(){$("#addAdjustment").click(function(){var e=$("#adjustVal").val();if(!e)return void userMessage.showMessage(!1,"Please enter amount");var t=htmlEscape($("#adjustNote").val()).trim();return t.length<1?void userMessage.showMessage(!1,"Please enter note"):void getApi("Adjustment",{note:t,adjustment:e,is_billable:$(".innerCircle").hasClass("billFill")},"POST").then(function(){localStorage.setItem("isMessage","truePos"),localStorage.setItem("userMessage",'Adjustment was successfully added <i class="ion-cash"></i>'),backFunction()},function(e){showError(e),console.log("fail @ pickup")})})}},k={init:function(){$(".innerCircle").click(function(){$(".innerCircle").hasClass("billFill")?($("#addTicketPassword").hide(),$("#addTicketConfirmPassword").hide()):($("#addTicketPassword").show(),$("#addTicketConfirmPassword").show())});var e=localStorage.getItem("add_user_type");localStorage.setItem("add_user_type",""),"tech"==e?($(".SherpaDesk").text("Add New Tech"),$(".greenButton").text("Add New Tech"),e="Tech"):e="User",$("#submitNewUser").click(function(){$("#loading").show1();var t=$("#addTicketEmail").val().trim();if(t.length<1)return void userMessage.showMessage(!1,"Please enter email");if(!checkEmail(t))return void userMessage.showMessage(!1,"Please correct email");var o=$("#addTicketFirstname").val().trim();if(o.length<1)return void userMessage.showMessage(!1,"Please enter Firstname");var i=$("#addTicketLastname").val().trim();return i.length<1?void userMessage.showMessage(!1,"Please enter Lastname"):void getApi("users",{Lastname:i,Firstname:o,email:t,role:e},"POST").then(function(a){userMessage.showMessage(!0,e+' was created <i class="ion-thumbsup"></i>',function(){localStorage.setItem("add_user_username",""),localStorage.setItem("add_user_techname",""),"Tech"==e?(localStorage.setItem("add_user_techid",a.id),localStorage.setItem("add_user_techname",getFullName(o,i,t," "))):(localStorage.setItem("add_user_userid",a.id),localStorage.setItem("add_user_username",getFullName(o,i,t," "))),backFunction()})},function(e){showError(e),console.log("fail @ pickup")})})}},_={init:function(e){this.addpicker(),loading(),this.inputTime(e)},addpicker:function(){jQuery("#date_start").datetimepicker({format:getDateTimeFormat(),mask:!1,step:5,onShow:function(){var e,t=jQuery("#date_end").val();
t&&(e=new Date(t),e.setDate(e.getDate())),this.setOptions({maxDate:t?e:!1})}}),jQuery("#date_end").datetimepicker({format:getDateTimeFormat(),mask:!1,step:5,onShow:function(){var e,t=jQuery("#date_start").val();t&&(e=new Date(t),e.setDate(e.getDate())),this.setOptions({minDate:t?e:!1})}})},getTaskTypes:function(t,o){if($("#taskTypes").length){o=o||0,$("#taskTypes").empty(),$("<option value=0 selected disabled>choose a task type</option>").appendTo("#taskTypes");var i=getApi("task_types",t);i.then(function(t){t.length>0&&($("#taskTypes").empty(),e(t,"#taskTypes","<option value=0 selected disabled>choose a task type</option>"),o>0&&$("#taskTypes").val(o).trigger("change"))},function(e){showError(e),console.log("fail @ task Types")})}},chooseProjects:function(t,o,i){"undefined"==typeof t&&(t=-1),o=o||0,i=i||0,t||(t=isAccount?$("#timeAccounts").val():-1),isProject?($("#timeProjects").empty(),$("<option value=0>choose a project</option>").appendTo("#timeProjects"),"0"!==t&&(loading(),getApi("projects".addUrlParam("account",t).addUrlParam("is_with_statistics","false")).then(function(t){$("#timeProjects").empty(),e(t,"#timeProjects","<option value=0>choose a project</option>"),$("#timeProjects").val(o).trigger("change")},function(e){$("#timeProjects").parent().hide1(),console.log(e),console.log("fail @ time Projects")}))):($("#timeProjects").parent().hide1(),_.getTaskTypes({account:t},i),_.chooseTickets(t,o,0))},chooseTickets:function(e,t,o){$("#timeTicket").length&&("undefined"==typeof e&&(e=-1),t=t||0,o=o||0,e||(e=isAccount?$("#timeAccounts").val():-1),$("#timeTicket").empty(),loading(),getApi("tickets?status=open&limit=100&account="+e+"&project="+t).then(function(e){$("#timeTicket").empty();var t=e.length;if(0>=t)$("<option disabled=disabled value=>no open tickets found</option>").appendTo("#timeTicket");else{for(var o="<option value=>choose a ticket</option>",i=0;t>i;i++)o+="<option value="+e[i].number+">#"+e[i].number+"&nbsp;:&nbsp;"+e[i].subject+"</option>";$(o).appendTo("#timeTicket"),$("#timeTicket").select2(l)}setTimeout(reveal,500)},function(e){showError(e),console.log("fail @ time Projects")}))},inputTime:function(e){var t=!0;if($("#submitTicketTime").click(function(){$("#loading").show1();var e=$("#addTimeTicket").val(),o=htmlEscape($("#noteTimeTicket").val().trim()),i=localStorage.getItem("techId"),a=$("#taskTypes").val(),s=localStorage.getItem("ticketNumber");if(o.length<1)return void userMessage.showMessage(!1,"Please enter note");if(o.length>5e3)return void userMessage.showMessage(!1,"Note cannot be more than 5000 chars!");if("0"==a)return void userMessage.showMessage(!1,"Choose a tasktype");if(0>=e)return void userMessage.showMessage(!1,"Oops not enough time");t=$(".innerCircle").hasClass("billFill")?!0:!1;var n,c=jQuery("#date_start").val();c&&(n=JSON.stringify(new Date(c)));var l,r=jQuery("#date_end").val();r&&(l=JSON.stringify(new Date(r))),getApi("time",{ticket_key:s,note_text:o,task_type_id:a,hours:e,is_billable:t,date:c?n:"",start_date:c?n:"",stop_date:r?l:"",tech_id:i},"POST").then(function(){localStorage.setItem("isMessage","truePos"),localStorage.setItem("userMessage",'Time was successfully added <i class="ion-thumbsup"></i>'),window.location.replace("ticket_list.html")},function(e){showError(e),console.log("fail @ pickup")})}),$("#submitTicketTime").length)_.getTaskTypes({ticket:localStorage.getItem("ticketNumber")},0);else{var o=0,i=localStorage.getItem("timeNumber");e&&i?(o=JSON.parse(i),o.billable||$(".innerCircle").removeClass("billFill"),$("#noteTime").val(o.note.replace(/&lt;br&gt;/gi,"\n").replace(/<br\s*[\/]?>/gi,"\n")),$("#addTimeTicket").val(o.hours||0),$(".title").html("Time #"+o.time_id+" by "+o.user_name+" @ "+getDateTime(o.date)),o.start_time&&$("#date_start").val(getDateTime(o.start_time)),o.stop_time&&$("#date_end").val(getDateTime(o.stop_time))):$("#timeTicket").parent().show1();var a=localStorage.DetailedAccount||-1,s=0,n=0,c="";o&&(a=o.account_id,s=o.project_id,n=o.task_type_id,c=o.ticket_number),isAccount?(h.getSearch("#timeAccounts","accounts","?is_with_statistics=false",a,localStorage.userOrg),$("#timeAccounts").on("change",function(){_.chooseProjects(0,s,n)})):($("#timeAccounts").parent().hide1(),_.chooseProjects(a,s,n)),isProject&&$("#timeProjects").on("change",function(){var e=isAccount?$("#timeAccounts").val():-1,t=$("#timeProjects").val();_.getTaskTypes({account:e,project:t},n),_.chooseTickets(e,t,0)}),$("#submitTime").click(function(){$("#loading").show1();var i=$("#addTimeTicket").val(),a=htmlEscape($("#noteTime").val().trim()),s=localStorage.getItem("userId"),n=$("#timeAccounts").val(),l=$("#timeProjects").val(),r=$("#taskTypes").val();t=$(".innerCircle").hasClass("billFill")?!0:!1;var u,g=jQuery("#date_start").val();g&&(u=JSON.stringify(new Date(g)));var d,m=jQuery("#date_end").val();return m&&(d=JSON.stringify(new Date(m))),0>=i?void userMessage.showMessage(!1,"Oops not enough time"):"0"==n&&isAccount?void userMessage.showMessage(!1,"Choose an account"):"0"==r?void userMessage.showMessage(!1,"Choose a tasktype"):0==a.length?void userMessage.showMessage(!1,"Enter note"):(c=c||$("#timeTicket").val(),void getApi("time"+(e?"/"+o.time_id:""),{tech_id:e?o.user_id:s,project_id:l,is_project_log:!c,ticket_key:c,account_id:n,note_text:a,task_type_id:r,hours:i,is_billable:t,date:g?u:"",start_date:g?u:"",stop_date:m?d:""},e?"PUT":"POST").then(function(){localStorage.setItem("isMessage","truePos"),localStorage.setItem("userMessage",'Time was successfully added <i class="ion-thumbsup"></i>'),backFunction()},function(e){showError(e),console.log("fail @ pickup")}))})}}},S={init:function(){var e=getParameterByName("tab")||localStorage.ticketPage;cleanQuerystring();var t=e;switch(e){case"all":t=isLimitAssignedTkts?"":"all";break;case"my":t=""}if(t&&isTech||(t=isTech?"tech":"user"),console.log(t),localStorage.ticketPage=t,displayPage(document.querySelector(".TicketTabs").parentElement,t),isTech){var o=localStorage.getItem("searchItem");$(".search").val(o),localStorage.setItem("searchItem","");var i=function(){for(var e=localStorage.ticketPage,t=["user","tech","alt","all"],i=0;4>i;i++)e!=t[i]&&S.getTickets(t[i],o)};this.getTickets(t,o),n=setTimeout(i,1500),isLimitAssignedTkts&&($("#tab_all").click(function(){return!1}),$("#tab_all").empty())}else this.getTickets("user"),$("#userContainer").css("padding-top","20px"),$(".TicketTabs").hide();$("maxSize").hide()},createTicketsList:function(e,t,o){localStorage.setItem("ticketNumber","");var i=$(t);if(i.empty(),!e||e.length<1)i.html('<h1 class="noTicketMessage">No Tickets</h1>');else{for(var a=[],s=e.length,n=0;s>n;n+=1){var c=$.md5(e[n].user_email),l=e[n].initial_post,r=e[n].subject;e[n].index=e[n].key+","+n;var u=e[n].key,g=e[n].is_new_tech_post&&e[n].technician_email!=localStorage.userName||e[n].is_new_user_post&&e[n].user_email!=localStorage.userName?"<i class='ion-ios-email-outline ionEmail'></i> ":"";l.length>400&&(l=l.substring(0,400)+"..."),l=symbolEscape(l);var d=e[n].user_firstname||e[n].user_lastname||e[n].user_email;a.push("<ul class='responseBlock item' id='thisBlock' data-id="+u+"><li><p class='blockNumber numberStyle'>#"+e[n].number+"</p><img src='http://www.gravatar.com/avatar/"+c+"?d=mm&s=80' class='TicketBlockFace'><span class=user_name>"+d+"</span></li><li class='responseText'><h4 class=dots>"+g+r+"</h4><div class ='initailPost'>"+l+"</div></li><li class='ticketLo ticketblok'><span class='ticketlocation'>"+e[n].location_name+"</span><p class='locationtick'>"+e[n].class_name+"</p></li></ul>"),s>10&&10==n&&(i.html(a.join("")),a=[])}i.append(a.join("")),createSpan(t)}o&&localStorage.setItem(o+"tickets",JSON.stringify(e))},getTickets:function(e,t,o){if("all"!=e||!isLimitAssignedTkts){var i="closed"!=e?e:"account"+localStorage.getItem("DetailedAccount")+e,a=e+"Container",n=localStorage.getItem(i+"tickets"),c=cacheTime;n&&(n=JSON.parse(n)),n&&0!=n.length?(S.createTicketsList(n,"#"+a),filterList(a,t)):(console.log("could not load local data"),c=10),s=setTimeout(function(){"ticket_list.html"==Page&&loading();var t="";switch(e){case"all":t="status=allopen&query=all";break;case"alt":t="status=open&role=alt_tech";break;case"user":t="status=open,onhold&role=user";break;case"closed":t="status=closed&account="+localStorage.getItem("DetailedAccount");break;default:t="status=open&role="+e}getApi("tickets?limit=100&"+t).then(function(e){S.createTicketsList(e,"#"+a,i),e.length&&filterList(a),"function"==typeof o&&o()},function(e){showError(e),console.log("fail @ "+a)})},c)}}},T={init:function(){T.init=noop,this.pick()},pick:function(){$("#pickUp").click(function(){$("#loading").show1(),getApi("tickets/"+localStorage.getItem("ticketNumber"),{action:"pickup",note_text:""},"PUT").then(function(){userMessage.showMessage(!0,'Ticket pickup was Succesfull <i class="ion-thumbsup"></i>',function(){o("ticket_detail.html")})},function(e){showError(e),console.log("fail @ pickup")})})}},w={init:function(){w.init=noop,this.closeIt(),this.reopenIt()},reopenIt:function(){$("#openIt").click(function(){getApi("tickets/"+localStorage.getItem("ticketNumber"),{status:"open",note_text:""},"PUT").then(function(){userMessage.showMessage(!0,'Ticket has been Reopened <i class="ion-thumbsup"></i>',function(){location.reload()})},function(e){showError(e),console.log("fail @ ticketNumber")})})},close:function(e){return e=htmlEscape(e).trim(),e.length<2?void userMessage.showMessage(!1,"Note cannot be empty!"):e.length>5e3?void userMessage.showMessage(!1,"Note cannot be more than 5000 chars!"):void getApi("tickets/"+localStorage.getItem("ticketNumber"),{status:"closed",note_text:e,is_send_notifications:!0,resolved:!0,dataType:"json",confirmed:!1,confirm_note:""},"PUT").then(function(){userMessage.showMessage(!0,'Ticket has been closed <i class="ion-thumbsup"></i>',function(){window.history.back()})},function(e){showError(e),console.log("fail @ ticket Number")})},closeIt:function(){$("#closeIt").click(function(){$("#closingMessage").slideDown(400,function(){$("#closeMessageButton").fadeIn(),$("html,body").animate({scrollTop:$("#closeMessageButton").offset().top},400)})}),$("#closeMessageButton").click(function(){$("#loading").show1(),w.close($("#closingMessage").val())}),$("#closeu").click(function(){$("#loading").show1(),w.close($("#commentText").val())})}},I={init:function(){I.init=noop,this.sendComment()},sendComment:function(){$("#reply").click(function(){$("#loading").show1();var e=htmlEscape($("#commentText").val().trim());return e?e.length>5e3?void userMessage.showMessage(!1,"Note cannot be more than 5000 chars!"):void getApi("tickets/"+localStorage.getItem("ticketNumber"),{note_text:e,action:"response"},"POST").then(function(){location.reload(!1)},function(e){showError(e),console.log("fail @ ticket Number")}):void userMessage.showMessage(!1,"Please enter note")})}},b={init:function(){if(window.clearTimeout(s),$("#comments").empty(),$(".orginalMessageContainer").empty(),isTech){$("#closeu").hide(),$("#classOptions").empty(),$("#ticketPriority").empty(),$("#ticketProject").empty(),$("#ticketLevel").empty(),$("#ticketTechs").empty(),$("#ticket_Location").empty(),displayPage(document.querySelector(".tabs").parentElement);var e=function(){e=noop,$("#transfer").click(function(){displayPage(document.querySelector(".tabs").parentElement,"info"),$("html, body").animate({scrollTop:$(document).height()},1e3),$("#ticketTechs").parent().addClass("selected"),$(".updateButton").html("Transfer"),userMessage.showMessage(!0,"Warning! Please update Tech in Info section!",function(){$("#ticketTechs").parent().removeClass("selected"),$(".updateButton").html("Update")})})};e()}else $(".tabs").hide(),$("#closeu").show();this.showTicket(),this.updateTicket()},updateTicket:function(){b.updateTicket=noop,$(".updateButton").click(function(){var e=selectedEditClass,t=$("#ticketLevel").val(),i=$("#ticketPriority").val(),a=$("#ticketProject").val(),s=$("#ticketLocation").val(),n=$("#ticketTechs").val(),c={class_id:e,level_id:t,priority_id:i,project_id:a,location_id:s,account_id:$("#inputAccountId").val(),tech_id:n};getApi("tickets/"+localStorage.getItem("ticketNumber"),c,"PUT").then(function(){userMessage.showMessage(!0,"Ticket was successfully updated <i class='ion-thumbsup'></i>",function(){o("ticket_detail.html")})})})},getCustomFields:function(e){if(e&&!(e.length<9)){var t=$.parseXML(e),o=$(t),i=o.find("field"),a=$("#customfields");a.empty(),$.each(i,function(){var e=$(this).find("caption"),t=$(this).find("value");a.append("<div class=styledSelect><span class='question'>"+e[0].textContent+":</span>&nbsp;&nbsp;&nbsp;<span class='replyTicket'>"+t[0].textContent+"</span></span></div>")})}},prepareTicket:function(o,i){var a="<a class=shareTicket href='#'>"+o.number+" <i class='ion-share shareFont'></i></a>";$("#ticketNumber").html(o.status+" | "+a),fullapplink("shareTicket",AppSite.addUrlParam("tkt",localStorage.getItem("ticketNumber")).addUrlParam("dept",userInstanceKey).addUrlParam("org",userOrgKey)),"Closed"==o.status?($("#closeIt").hide(),$("#closeu").hide()):$("#openIt").hide(),$("#inputAccountId").val(o.account_id),localStorage.setItem("ticketId",o.id),$("#ticketExpense").attr("href","addExpence.html?ticket="+o.id),"Closed"==o.status?($("#closeIt").hide(),$("#closeu").hide()):$("#openIt").hide();var s=o.tech_firstname||o.technician_firstname,n=o.tech_lastname||o.technician_lastname,l=o.tech_email||o.technician_email;c=getFullName(s,n,l),l==localStorage.getItem("userName")&&$("#pickUp").hide(),$("#ticketTech").html(c),$("#ticketSubject").html(o.subject),$("#ticketClass").html(o.class_name),$("#ticket_locations").html(o.location_name);var r=o.total_hours;0!==r?$("#ticketHours").html(r+" Hours"):$("#ticketHours").hide(),null===o.sla_complete_date?$("#ticketSLA").hide():$("#ticketSLA").html("SLA: "+getDateTime(o.sla_complete_date));var u=o.tech_id;if(localStorage.setItem("techId",u),isTech&&!i){var g=getApi("classes");g.done(function(e){selectedEditClass=o.class_id;var i="<option disabled=disabled value=0>Choose class</option>";selectedEditClass&&(i="<option data-classId="+selectedEditClass+" value="+selectedEditClass+">Class: "+o.class_name+"</option>"),t(e,"#classOptions",i)}),h.getLocations(o.account_id,o.location_id,o.location_name,!0);var d=getApi("priorities");if(d.done(function(t){return 0===t.length?void $("#ticketPriority").parent().hide1():(e(t,"#ticketPriority","<option disabled=disabled value=0>Choose priority</option>","Priority: "),void $("#ticketPriority").val(o.priority_id).trigger("change"))}),isProject){var m=getApi("projects");m.done(function(t){e(t,"#ticketProject","<option value='null' disabled=disabled>choose project</option>"),$("#ticketProject").val(o.project_id||"null").trigger("change")})}else $("#project").hide();isLevel?getApi("levels").done(function(t){e(t,"#ticketLevel","<option disabled=disabled value=0>Choose level</option>","Level: "),$("#ticketLevel").val(o.level).trigger("change")}):$("#ticketLevel").parent().hide(),h.getSearch("#ticketTechs","technicians","",u,"Tech: "+c,!0)}},showTicket:function(){"truePos"==localStorage.getItem("isMessage")&&userMessage.showMessage(!0),$("html,body").css("scrollTop","0");var e,t=localStorage.getItem("ticketNumber"),o=localStorage.getItem(localStorage.getItem("ticketPage")+"tickets");if(o){var i=new RegExp('"'+t+",(\\d+)").exec(o);i&&(o=JSON.parse(o),e=o[Number(i[1])])}e&&b.prepareTicket(e,!0),loading(!0),getApi("tickets/"+t).then(function(t){var o=t.daysold_in_minutes/-60;o=o>24?parseInt(o/24)+" days ago":parseInt(o)+" hours ago",$("#lastUpdate").html(o),t.misc_cost?$("#expenses").html("Expenses: "+localStorage.currency+Number(t.misc_cost).toFixed(2).toString()):$("#expenses").hide();var i=t.ticketlogs.length,a=t.attachments||[];a.sort(function(e,t){return t.name.length-e.name.length}),b.createLogs([t.ticketlogs.shift()],".orginalMessageContainer",a),i>1?b.createLogs(t.ticketlogs,"#comments",a):$("#comments").append('<p id="fill" style="height:200px">&nbsp;</p>'),b.prepareTicket(t,!!e),reveal(),isTech&&null!==t.customfields_xml&&t.customfields_xml.length>0&&b.getCustomFields(t.customfields_xml)},function(){console.log("fail @ Ticket Detail"),userMessage.showMessage(!1,"No ticket found. Going back to a list.",function(){localStorage.setItem("ticketNumber",""),history.length<3?window.location="ticket_list.html":history.back()})})},createLogs:function(e,t,o){for(var i=e.length,a=[],s=$(t),n=0;i>n;n++){var c=$.md5(e[n].user_email),l=e[n].log_type,r=e[n].user_firstname+" "+e[n].user_lastname,u=e[n].note.trim();u=symbolEscape(u);var g=formatDate(e[n].record_date);a[n]="<ul class='commentBlock'><li><img src='http://www.gravatar.com/avatar/"+c+"?d=mm&s=80' class='commentImg'></li><li class='commentText'><h3 class=dots>"+r+"</h3></li><li><span>"+g+"</span></li><li class='commentText'><p>"+u+"</p></li><li>"+l+"</li></ul>"}var d=FileUrlHelper.addUrls(a.join(""),o);s.html(d)}},y={init:function(){loading(),this.specifics()},specifics:function(){var e=localStorage.invoiceNumber;e||backFunction();var t={},o=-1!=e.indexOf(",");o?($("#sendInvoiceButton").html("Create Invoice"),$("#invoiceNumber").html("Create Invoice"),e=e.split(","),t={status:"unbilled",account:e[0],project:e[1]},e="invoices"):(t.action="sendEmail",e="invoices/"+e),t.is_detailed=!0;var i,a;getApi(e,t).then(function(e){localStorage.setItem("invoiceAccountId",e.account_id),localStorage.setItem("invoiceProjectId",e.project_id),i=e.start_date||(new Date).toJSON(),a=e.end_date||(new Date).toJSON(),$("#invoiceNumber").html(e.id?"Invoice  #"+e.id:"Create Invoice");var t=e.customer||e.account_name;$("#customerName").html(t);var o=(i!=a?formatDate(i)+"&nbsp;-&nbsp;":"")+formatDate(a);$("#invoiceDate").html(o),$("#invoiceHours").html(e.total_hours.toFixed(2)+"<span class='detail3Small'>hrs</span>");var s=e.amount.toFixed(2).toString().split(".");if($("#invoiceAmount").html(localStorage.getItem("currency")+s[0]+"<span class='detail3Small'>."+s[1]+"</span>"),isTravelCosts?(s=e.travel_cost.toFixed(2).toString().split("."),$("#invoiceTravel").html(localStorage.getItem("currency")+s[0]+"<span class='detail3Small'>."+s[1]+"</span>")):$("#invoiceTravel").parent().parent().hide(),isExpenses){var n=e.misc_cost.toFixed(2).toString().split(".");$("#invoiceExpenses").html(localStorage.getItem("currency")+n[0]+"<span class='detail3Small'>."+n[1]+"</span>")}else $("#invoiceExpenses").parent().parent().hide();$("#invoiceAdjustments").html(localStorage.getItem("currency")+"0<span class='detail3Small'>.00</span>"),s=Number(e.total_cost).toFixed(2).toString().split("."),$(".invoiceTotal").html(localStorage.getItem("currency")+s[0]+"<span class='detail3Small'>."+s[1]+"</span>"),$("#recipientList").empty();var c="",l=e.recipients,r=e.recipients.length;if(r>0){l.sort(function(e,t){return e.is_accounting_contact<t.is_accounting_contact?1:-1});for(var u=0;r>u;u++){var g=$.md5(l[u].email);c+="<li class=recipientParent><ul class='recipientDetail'><li><img src='http://www.gravatar.com/avatar/"+g+"?d=mm&s=80'></li><li><div class='recipient'><p class=dots>"+l[u].email+"</p>"+(l[u].is_accounting_contact?"<i class='plusIcon pcIcon ion-checkmark-circled circleInvoice' id=\""+l[u].email+'"></i>':"<i class='closeIcon pcIcon ion-close-circled circleInvoice' id=\""+l[u].email+'"></i>')+"</div></li></ul></li>"}$("#recipientList").html(c)}else $("<li><h3 class=noTicketMessage>No accounting contacts found.<p>&nbsp;</p></h3></li>").appendTo("#recipientList"),$("#sendInvoiceButton").remove();reveal()},function(e){showError(e),console.log("fail @ Invoice details")}),$("#sendInvoiceButton").click(function(){if($("#loading").show1(),$(".recipient").children(".plusIcon").length<1)return void userMessage.showMessage(!1,"No accounting contacts selected");var s="";$.each($(".recipient").children(".plusIcon"),function(){s+=$(this).attr("id")+","}),o&&(t.start_date=i,t.end_date=a),t.recipients=s,getApi(e,t,o?"POST":"PUT").then(function(){userMessage.setMessage(!0,"Hurray! Invoice sent"),backFunction()},function(e){showError(e),console.log("fail @ storage Account List")})})}},P={init:function(e){loading();var t=localStorage.DetailedAccount;e||$("#invoiceCreate").click(function(){window.location.replace("unInvoice_List.html")}),this.listInvoices(t,e),$(document).on("click",".invoiceRows",function(){localStorage.setItem("invoiceNumber",$(this).attr("data-id")),window.location="invoice.html"})},listInvoices:function(e,t){getApi("invoices",{status:t,account:e}).then(function(e){if($("#invoiceList").empty(),0==e.length)return $('<h3 class="noTicketMessage">no invoices at this time</h3>').prependTo("#invoiceList"),createSpan("#invoiceList"),void reveal();"undefined"==typeof e.length&&(e=[e]);for(var o="",i=0;i<e.length;i++){var a=e[i].customer||e[i].account_name,s=formatDate(e[i].end_date||e[i].date||(new Date).toJSON()),n=t?e[i].account_id+","+e[i].project_id:e[i].id;o+="<ul data-id="+n+" class='invoiceRows detailInvoice item'><li class='responseText'>"+s+"</li><li class='user_name dots'>"+a+"</li><li>$"+Number(e[i].total_cost).toFixed(2)+"</li></ul>"}$(o).appendTo("#invoiceList"),createSpan("#invoiceList"),reveal(),filterList("tabpageContainer")},function(e){showError(e),console.log("fail @ invoice List")})}},M={init:function(){$(".title").html("Tickets @ "+localStorage.getItem("currentQueueName")+" Queue"),this.queueTickets(),$("#ticketCreate").click(function(){localStorage.setItem("add_user_techid",localStorage.getItem("currentQueue")),window.location.replace("add_tickets.html")})},queueTickets:function(){var e=localStorage.getItem("currentQueue");e||(console.log("fail @ Queues tickets"),window.history.back()),getApi("queues/"+e).then(function(t){S.createTicketsList(t,"#queueTickets"),t.length&&filterList("queueTickets"),reveal();var o=localStorage.getItem("storageQueues");if(o){var i=new RegExp('"'+e+",(\\d+)").exec(o);i&&(o=JSON.parse(o),o[Number(i[1])].tickets_count=t.length,localStorage.setItem("storageQueues",JSON.stringify(o)))}},function(e){showError(e),console.log("fail @ queue Tickets")})}},x={init:function(e,t){return isQueues?(e&&$(document).on("click","#queue",function(){localStorage.setItem("currentQueue",$(this).attr("data-id")),localStorage.setItem("currentQueueName",$(this).find(".OptionTitle").text()),window.location="queueTickets.html"}),cacheName="storageQueues",void x.queues(t,e)):void $(e).parent().remove()},queues:function(e,t){var o=cacheTime;if(t){var i=localStorage.getItem("storageQueues");i&&(i=JSON.parse(i)),i&&0!=i.length?(x.createQueuesList(t,i,e),e||createSpan(t)):(console.log("could not load local data"),o=10)}else o=10;setTimeout(function(){getApi("queues",{sort_by:"tickets_count"}).then(function(o){for(var i=0,a=0;a<o.length;a+=1)0==o[a].fullname.toLowerCase().indexOf("new ticket")&&(i=o[a].tickets_count);localStorage.badge=i,updateBadge(),t&&(x.createQueuesList(t,o,e),localStorage.setItem("storageQueues",JSON.stringify(o)),reveal(),e||(createSpan(t),o.length&&filterList("OptionsList")))},function(e){showError(e),console.log("fail @ Queues List")})},o)},createQueuesList:function(e,t,o){if(!t||t.length<1)return void(o?$(e).parent().remove():$(e).html('<h2 class="noTicketMessage">No Queues</h2>'));for(var i=0,a=[],s=t.length,n=$(e),c=0;s>c;c+=1)t[c].index=t[c].id+","+c,o&&t[c].tickets_count<1||o&&i>=o||(a.push("<li class=item><div id='queue' data-id="+t[c].id+" class='OptionWrapper optionWrapper3'><h3 class='OptionTitle dots user_name'>"+t[c].fullname+"</h3></div><div class='NotificationWrapper notificatio'><h2>"+t[c].tickets_count+"</h2></div></li>"),s>10&&10==c&&n.html(a.join("")),i+=1);n.html(a.join(""))}},L={init:function(e,t){$(document).on("click",".tableRows, .listedAccount",function(){localStorage.setItem("DetailedAccount",$(this).attr("data-id")),window.location="account_details.html"}),cacheName="storageAccountList",L.listAccounts(e,t)},listAccounts:function(e,t){var o=cacheTime,i=localStorage.getItem("storageAccountList");i&&(i=JSON.parse(i)),i&&0!=i.length?(t?(cacheName="dash",L.createDashAccountsList(e,i)):L.createAccountsList(e,i),reveal()):(console.log("could not load local data"),o=10),setTimeout(function(){getApi("accounts?limit=500").then(function(o){t?L.createDashAccountsList(e,o):L.createAccountsList(e,o),localStorage.setItem("storageAccountList",JSON.stringify(o)),reveal()},function(e){showError(e),console.log("fail @ Account List")})},o)},createAccountsList:function(e,t){if(t.length<1){var o='<h1 class="noTicketMessage">No Accounts</h1>';$(o).html(e)}else{for(var i=[],a=t.length,s=$(e),n=0;a>n;n+=1){t[n].index=t[n].id+","+n;var c=t[n].account_statistics.ticket_counts.open,l=t[n].name;i.push("<ul class='listedAccount item' data-id="+t[n].id+"><li class=user_name>"+l+"</li><li><div class='tks tks2' "+(c>99?"style='height: 42px;'>99<sup>+</sup>":">"+c)+"</div></li></ul>"),a>10&&10==n&&s.html(i.join(""))}s.html(i.join("")),createSpan(e),a&&filterList("ActiveAccountsContainer")}},createDashAccountsList:function(e,t){var o=[],i=t.length,a=$(e);i>0&&(o=["<ul class='tableHeader'><li></li><li>Hours</li><li>Expenses</li><li>Tkts</li></ul>"]);for(var s=0;i>s;s+=1){t[s].index=t[s].id+","+s;var n=t[s].account_statistics.ticket_counts.open;if(!(1>n)){var c=t[s].name,l=Math.min(t[s].account_statistics.hours||0,999);o.push("<ul class='tableRows clickme' data-id="+t[s].id+"><li>"+c+"</li><li>"+l+"</li><li>"+localStorage.getItem("currency")+Number(t[s].account_statistics.expenses).toFixed(2)+"</li><li><div class='tks1 tks2 "+(n>99?"overflowTickets' style='height: 42px;'>99<sup>+</sup>":"'>"+n)+"</div></li></ul>"),i>10&&10==s&&a.html(o.join(""))}}a.html(o.join(""))}},A={init:function(){this.getLogs()},getLogs:function(){var e=localStorage.getItem("DetailedAccount");getApi("expenses",{account:e,limit:200}).then(function(e){$(".accountContainerExpen").empty();var t=!1;if(e.length>0)for(var o=0;o<e.length;o++)if(!e[o].invoice_id){t=!0;var i=$.md5(e[o].user_email),a=e[o].note,s=e[o].user_name||e[o].user_lastname||e[o].user_email,n="";n=e[o].amount.toString().indexOf(".")>0?e[o].amount.toFixed(2).toString():e[o].amount.toString();var c=formatDate(e[o].date),l="";l=e[o].ticket_number>0?"#"+e[o].ticket_number+": "+e[o].ticket_subject:e[o].project_id>0?"Project: "+e[o].project_name:"Account: "+e[o].account_name;var r='<li class="expenLi"><ul class="responseBlock item responseBlockExpen"> <li class="expen"><img class="TicketBlockFace expenImg" src="http://www.gravatar.com/avatar/'+i+'d=mm&amp;s=80"><span class="user_name">'+s+'</span></li><li class="textExpen"><h4><p class="subjectExpen dots">'+l+'</p></h4><div class="initailPost">'+a+'</div></li><li class="TicketBlockNumber expenE"><h3 class="feedTimeExpen"><span>$'+n+"</span></h3><span>"+c+"</span></li></ul></li>";$(r).appendTo(".accountContainerExpen"),9==o&&reveal()}t||$('<h1 class="noTicketMessage">No Expenses</h1>').appendTo(".accountContainerExpen"),createSpan("#accountContainerExpen"),reveal()},function(e){showError(e),console.log("fail @ time logs")})}},N={init:function(){this.getLogs()},getLogs:function(){getApi("time",{limit:200}).then(function(e){if($("#timelogs").empty(),e.length<1){var t='<h1 class="noTicketMessage">No Timelogs</h1>';$(t).appendTo("#timelogs")}else for(var o=0;o<e.length;o++){var i=$.md5(e[o].user_email),a=e[o].note,s=e[o].time_id,n=e[o].hours.toString(),c=e[o].user_name||e[o].user_email,l=formatDate(e[o].date);if(!e[o].is_project_log){var r="#"+e[o].ticket_number+": "+e[o].ticket_subject;""!=a&&(r="<span style='display: block;'>"+r+"</span>"),a+=r}-1==n.indexOf(".")&&(n+=".00");var u="<li class=item><ul class='timelog' data-id="+s+" data-info='"+JSON.stringify(e[o]).replace(/'/g,"")+"'> <li><img class='timelogProfile' src='http://www.gravatar.com/avatar/"+i+"?d=mm&s=80'></li><li><h2 class='feedName dots user_name'>"+c+"</h2><p class='taskDescription'>"+a+"</p></li><li class='feedClock ion-ios-clock-outline'</li><h3 class='feedTime'><span>"+n+"</span><p> "+l+"</p></h3></li></ul></li>";$(u).appendTo("#timelogs"),9==o&&reveal()}createSpan("#timelogs"),reveal(),e.length&&filterList("timelogs")},function(e){showError(e),console.log("fail @ time logs")})}},O={init:function(){this.getTodoList()},getTodoList:function(){getApi("todos",{limit:200}).then(function(e){if($("#todoList").empty(),e.length<1){var t='<h1 class="noTicketMessage">No Todos</h1>';$(t).appendTo("#todoList")}else for(var o=0;o<e.length;o++){var i=" ";i=e[o].ticket_id>0?"#"+e[o].ticket_id:e[o].project_id>0?e[o].project_id:" ";var a="";e[o].due_date>0&&(a=formatDate(e[o].due_date));var s="<ul id='recipHeader' class='lineTodos'><li>"+i+"</li><li id='addRecipient' class='detail3Short'><!--img class='addIcon' src='img/check.png'--></li></ul><div class='styleMain todosMainText'>"+e[o].name+"</div><ul id='recipientList' class='recipientTodos dots'><h4><p class='todos'><input class='timeTodos' type='checkbox' value=''>"+e[o].text+"</p></h4><p class='todosData'>"+e[o].assigned_name+" "+a+"</p></div></ul>";$(s).appendTo("#todoList"),9==o&&reveal()}createSpan("#todoList"),reveal(),e.length>1},function(e){showError(e),console.log("fail @ todos")})}},j={init:function(){var e=localStorage.getItem("DetailedAccount");localStorage.setItem("addAccountTicket",e),isExpenses||$("#expensesOption").parent().parent().remove(),isInvoice?$("#invoiceOption").click(function(){window.location="Invoice_List.html"}):$("#invoiceOption").parent().remove(),this.pageSetup(),this.slideDown()},slideDown:function(){$("#openTicketslink").click(function(){$("html,body").animate({scrollTop:$("#openTickets").offset().top},"400")})},createAccDetails:function(e){if(e&&e.account_statistics&&e.account_statistics.ticket_counts){e.account_statistics.ticket_counts.closed&&$(".buttonShowClosedTickets").show();var t=Math.min(e.account_statistics.hours,999),o=Math.min(e.account_statistics.ticket_counts.open,999),i=Math.min(e.account_statistics.invoices,999),a=Math.min(e.account_statistics.expenses,999);$("#AD").html(e.name),$("#ticketsOptionTicker").html(o),$("#invoiceOptionTicker").html(i),$("#timesOptionTicker").html(t),$("#expenseOptionTicker").html(localStorage.currency+Number(a).toFixed(2).toString())}},pageSetup:function(){var e,t,o=localStorage.getItem("DetailedAccount"),i=localStorage.getItem("account"+o+"tickets"),a=cacheTime,s=cacheTime,n=localStorage.getItem("storageAccountList");n&&(t=new RegExp('"'+o+",(\\d+)").exec(n),t&&(n=JSON.parse(n),e=n[Number(t[1])])),i?(i=JSON.parse(i),S.createTicketsList(i,".AccountDetailsTicketsContainer"),i.length&&filterList("AccountDetailsTicketsContainer")):(s=10,console.log("could not load local account tickets data")),e&&0!=e.length?j.createAccDetails(e):(console.log("could not load local account details data"),a=10),setTimeout(function(){getApi("accounts/"+o).then(function(o){j.createAccDetails(o),e&&(n[Number(t[1])].account_statistics=o.account_statistics,localStorage.setItem("storageAccountList",JSON.stringify(n)))},function(e){showError(e),console.log("fail @ storage Account List")})},a),setTimeout(function(){getApi("tickets?status=open&account="+o).then(function(e){S.createTicketsList(e,".AccountDetailsTicketsContainer","account"+o),e.length&&filterList("AccountDetailsTicketsContainer")},function(e){showError(e),console.log("fail @ Account")})},s)}},C={init:function(){$("#addTimeAccount").click(function(){window.location="add_time.html"}),this.getTimeLogs()},getTimeLogs:function(){var e=localStorage.getItem("DetailedAccount")||-1;getApi("time?account="+e).then(function(e){if($("#accountLogs").empty(),e.length<1){var t='<h1 class="noTicketMessage">No Timelogs</h1>';$(t).appendTo("#accountLogs")}else for(var o=0;o<e.length;o++){var i=$.md5(e[o].user_email),a=e[o].note,s=e[o].hours.toString();-1==s.indexOf(".")&&(s+=".00");var n=e[o].user_name||e[o].user_email,c="<li><ul class='timelog' data-info='"+JSON.stringify(e[o]).replace(/'/g,"")+"'> <li><img class='timelogProfile' src='http://www.gravatar.com/avatar/"+i+"?d=mm&s=80'></li><li><h2 class='feedName dots'>"+n+"</h2><p class='taskDescription'>"+a+"</p></li> <li class='feedClock ion-ios-clock-outline'</li><h3 class='feedTime'><span>"+s+"</span></h3></li></ul></li>";
$(c).appendTo("#accountLogs")}},function(e){showError(e),console.log("fail @ accountlogs")})}},E={init:function(){$("html,body").css("scrollTop","0");var e=10,t=localStorage.ticketsStat;t&&(t=JSON.parse(t)),t?E.setTicketCounts(t):console.log("no cache TicketsCounts"),setTimeout(function(){getApi("tickets/counts").then(function(e){E.setTicketCounts(e),reveal(),localStorage.setItem("ticketsStat",JSON.stringify(e))},function(e){showError(e),console.log("fail @ get TicketsCounts")})},e),$(document).on("click","#asUserStat",function(){localStorage.setItem("ticketPage","user"),window.location="ticket_list.html"}),$(document).on("click","#techStat",function(){localStorage.setItem("ticketPage","tech"),window.location="ticket_list.html"}),$(document).on("click","#asAltTechStat",function(){localStorage.setItem("ticketPage","alt"),window.location="ticket_list.html"}),isLimitAssignedTkts?$("#allTicketsStat").empty():$(document).on("click","#allTicketsStat",function(){localStorage.setItem("ticketPage","all"),window.location="ticket_list.html"})},setTicketCounts:function(e){var t=e.open_all;t>100?t="&nbsp;99<sup>+</sup>":$("#all").removeClass("headerOverflowTickets"),$("#all").html(t),$("#userStat").html(e.open_as_user),$("#techStat").html(e.open_as_tech),$("#altStat").html(e.open_as_alttech)}},D=function(e,t,o,i){"undefined"==typeof o&&(o=!0),e&&t||(e=localStorage.getItem("userOrgKey"),t=localStorage.getItem("userInstanceKey")),e&&t&&getApi("config").then(function(e){isPhonegap&&32===localStorage.getItem("userKey").length&&initOrgPreferences(localStorage.getItem("userOrgKey")+"-"+localStorage.getItem("userInstanceKey")+":"+localStorage.getItem("userKey")),localStorage.setItem("userRole",e.user.is_techoradmin?"tech":"user"),isTech=e.user.is_techoradmin,localStorage.setItem("projectTracking",e.is_project_tracking),localStorage.setItem("timeTracking",e.is_time_tracking),localStorage.setItem("accountManager",e.is_account_manager),localStorage.setItem("ticketLevels",e.is_ticket_levels),localStorage.setItem("classTracking",e.is_class_tracking),localStorage.setItem("locationTracking",e.is_location_tracking),localStorage.setItem("freshbooks",e.is_freshbooks),localStorage.setItem("is_invoice",e.is_invoice),localStorage.setItem("is_expenses",e.is_expenses),localStorage.setItem("is_travel_costs",e.is_travel_costs),localStorage.setItem("currency",e.currency),localStorage.setItem("dateformat",e.user.date_format),localStorage.setItem("timeformat",e.user.time_format),localStorage.setItem("userFullName",getFullName(e.user.firstname,e.user.lastname,localStorage.userName," ")),localStorage.setItem("userId",e.user.user_id),localStorage.setItem("account_id",e.user.account_id),localStorage.setItem("account_name",e.user.account_name),localStorage.setItem("is_limit_assigned_tkts",e.user.is_limit_assigned_tkts),i&&"function"==typeof i?i():getInfo4Extension(),o&&(window.location=isTech?"dashboard.html":"ticket_list.html")},function(e,t,o){showError(o),console.log("fail @ config")})},F={init:function(){return $(".instSelect").hide(),localStorage.setItem("userRole","user"),userOrgKey&&userInstanceKey?void D(userOrgKey,userInstanceKey):void this.getOrg()},getOrg:function(){$("body").show1(),loading(),$.ajax({type:"GET",beforeSend:function(e){e.withCredentials=!0,e.setRequestHeader("Authorization","Basic "+btoa("x:"+userKey))},url:ApiSite+"organizations/",async:!0,cache:!1,dataType:"json",success:function(e){if(e.length>1){localStorage.setItem("sd_is_MultipleOrgInst","true");for(var t=e,o=0;o<t.length;o++){var i="",a="";t[o].is_expired&&(i=" <font color=black>(Expired)</font>",a="expired");var s="<li class=item><div id='org' data-id="+o+" class='OptionWrapper1 optionWrapper3'><h3 class='OptionTitle dots user_name "+a+"'>"+t[o].name+i+"</h3></div></li>";$("#orgsPage").append(s)}$(document).on("click","#org",function(){var t=$(this).attr("data-id");if(userOrgKey=e[t].key,userOrg=e[t].name,$(this).find("h3.expired").length)return void userMessage.showMessage(!1,userOrg+" has expired. Contact SherpaDesk for assistance. Email: support@sherpadesk.com Phone: +1 (866) 996-1200, then press 2");var o=e[t].instances;if(localStorage.setItem("userOrgKey",userOrgKey),localStorage.setItem("userOrg",userOrg),0==o.length)return void userMessage.showMessage(!1,"You are not associated with any Instance in the Organization or your account is inactivated in the Instances.");if(1==o.length)userInstanceKey=o[0].key,localStorage.setItem("userInstanceKey",userInstanceKey),D(userOrgKey,userInstanceKey);else{$("#instsPage").empty(),$("div.OptionWrapper1[data-id!='"+t+"']").parent().remove();for(var i=0;i<o.length;i++){var a="",s="",n="<li class=item><div id='inst' data-id="+i+" class='OptionWrapper2 optionWrapper3'><h3 class='OptionTitle dots user_name"+s+"'>"+o[i].name+a+"</h3></div></li>";$("#instsPage").append(n)}$(".instSelect").show(),$(document).on("click","#inst",function(){if($(this).find("h3.expired").length)return void userMessage.showMessage(!1,o[$(this).attr("data-id")].name+" has expired. Contact SherpaDesk for assistance. Email: support@sherpadesk.com Phone: +1 (866) 996-1200, then press 2");var e=o[$(this).attr("data-id")].key;localStorage.setItem("userInstanceKey",e),localStorage.setItem("sd_is_MultipleOrgInst","true"),loading(),D(userOrgKey,e)})}})}if(1==e.length){userOrgKey=e[0].key,userOrg=e[0].name,localStorage.setItem("userOrgKey",userOrgKey),localStorage.setItem("sd_is_MultipleOrgInst","false"),localStorage.setItem("userOrg",userOrg);var s="<li class=item><div id='org' data-id=0 class='OptionWrapper1 optionWrapper3'><h3 class='OptionTitle dots user_name'>"+e[0].name+"</h3></div></li>";$("#orgsPage").append(s);var n=e[0].instances;if(1==n.length)userInstanceKey=n[0].key,localStorage.setItem("userInstanceKey",userInstanceKey),D(userOrgKey,userInstanceKey);else{$("#instsPage").empty();for(var o=0;o<n.length;o++){var i="",a="",s="<li class=item><div id='inst' data-id="+o+" class='OptionWrapper2 optionWrapper3'><h3 class='OptionTitle dots user_name"+a+"'>"+n[o].name+i+"</h3></div></li>";$("#instsPage").append(s)}$(".instSelect").show(),$(document).on("click","#inst",function(){if($(this).find("h3.expired").length)return void userMessage.showMessage(!1,n[$(this).attr("data-id")].name+" has expired. Contact SherpaDesk for assistance. Email: support@sherpadesk.com Phone: +1 (866) 996-1200, then press 2");var e=n[$(this).attr("data-id")].key;localStorage.setItem("userInstanceKey",e),localStorage.setItem("sd_is_MultipleOrgInst","true"),loading(),D(userOrgKey,e)})}}},complete:function(){userOrgKey=localStorage.getItem("userOrgKey"),userInstanceKey=localStorage.getItem("userInstanceKey"),userOrgKey&&userInstanceKey||reveal()},error:function(){console.log("fail @ getOrg"),logout()}})}},U=i(function(){$(document).on("click",".responseBlock",function(){localStorage.setItem("ticketNumber",$(this).attr("data-id")),Page.indexOf("ticket_")>=0?o("ticket_list.html"):document.location="ticket_detail.html"})});!function(){if("signup.html"==Page)return void u.init();if(userMessage.init(),window.dontClearCache&&localStorage.techtickets&&"login.html"!==Page&&"org.html"!==Page)return void o();localStorage.appVersion?localStorage.appVersion!==appVersion&&(localStorage.setItem("appVersion",appVersion),console.log("Version updated to "+appVersion),adMessage.length>1?setTimeout(function(){userMessage.showMessage(!0,adMessage,updatedFunction)},3e3):location.reload(!0)):localStorage.setItem("appVersion",appVersion);var e="login.html"==Page;if(userKey=localStorage.getItem("userKey"),userOrgKey=localStorage.getItem("userOrgKey"),userInstanceKey=localStorage.getItem("userInstanceKey"),!userOrgKey||!userInstanceKey)return userKey&&32==userKey.length?"org.html"!=Page?window.location="org.html":F.init():e?r.init():logout(),void googleTag();if(e)return void(window.location="tech"===localStorage.getItem("userRole")?"dashboard.html":"ticket_list.html");if("org.html"==Page)return F.init(),void googleTag();var t=localStorage.loadTicketNumber;if(t&&"undefined"!=t)return localStorage.loadTicketNumber="",localStorage.setItem("ticketNumber",t),void(window.location="ticket_list.html");var i=localStorage.getItem("ios_action");if(i&&"undefined"!==i)return localStorage.setItem("ios_action",""),void(window.location=i);if(i&&"undefined"!==i)return localStorage.setItem("ios_action",""),void(window.location=i);if(googleTag(),localStorage.lastclick){if(((new Date).valueOf()-Date.parse(localStorage.lastclick).valueOf())/60>1200)return localStorage.lastclick=new Date,void D("","",!1,o)}else localStorage.lastclick=new Date;o()}()});