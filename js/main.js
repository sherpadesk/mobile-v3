function updatedFunction(){location.reload(!0)}function HasProp(obj,prop){for(var p in obj)if(obj.hasOwnProperty(p)){if(p===prop)return obj;if(obj[p]instanceof Object&&HasProp(obj[p],prop))return obj[p]}return null}function checkEmail(email){return null!==email.trim().match(/^[^@\s]+@[^@\s]+(\.[^@\s]+)+$/i)}function checkURL(url){return null!==url.trim().match(/(jpeg|jpg|gif|png)$/i)}function onDeviceReady(){isPhonegap=!0,cordova.plugins.notification.badge&&(localStorage.badge>0?cordova.plugins.notification.badge.set(localStorage.badge):cordova.plugins.notification.badge.clear())}function openURL(urlString){window.open(urlString,"_blank","location=no,EnableViewPortScale=yes")}function openURLsystem(urlString){window.open(urlString,"_system")}function reveal(){$("#loading").hide()}function errorLine(message){var func="location.reload(false)";$("#scroller").hide(),$(".catch-error").length||$("body").prepend('<div class="catch-error"><div class="catch-error-description"><h2>&nbsp;</h2><h2>&nbsp;</h2><h2>Something went wrong...</h2><div id="ctl00_PageBody_StackTrace" class="return-button"><p /><p /><h4>'+message+'</h4><h4>&nbsp;<p>P.S.  Uh... a Yeti just attacked your  camp!</h4><center><button class=loginButton style="width: 200px;" onclick="'+func+'">Refresh</button></center></div></div>')}function offLine(){var func="redirectToPage()";isOnline=!1,$(".catch-error").length||$("body").prepend('<div class="catch-error"><div class="catch-error-description"><h2>&nbsp;</h2><h2>&nbsp;</h2><h2>Check your internet connection!</h2><div id="ctl00_PageBody_StackTrace" class="return-button"><p /><p /><h4>P.S.  Uh... a Yeti just attacked your  camp!</h4><center><button class=loginButton style="width: 200px;" onclick="'+func+'">Refresh</button></center></div></div>')}function onLine(){isOnline||($(".catch-error").remove(),location.reload(!1)),isOnline=!0}function redirectToPage(){if(navigator.onLine)if(isPhonegap)onLine();else{var img=document.body.appendChild(document.createElement("img"));img.style.display="none",img.onload=function(){onLine()},img.onerror=function(){offLine()},img.src=MobileSite+"img/select_arrow.png?rand="+Math.random()}else offLine()}function logout(isRedirect,mess){clearStorage(),localStorage.is_google?(localStorage.removeItem("userName"),localStorage.removeItem("is_google"),GooglelogOut()):window.location="index.html"+(mess?"?f="+mess:"")}function GooglelogOut(mess){if(mess=mess?"?f="+mess:"",window.self!==window.top||confirm("Do you want to stay logged in Google account?"))window.location="index.html"+mess;else{document.location.href=MobileSite+"index.html"+mess}}function clearStorage(){var userName=localStorage.userName,appVersion=localStorage.appVersion;localStorage.clear(),localStorage.setItem("userName",userName),localStorage.appVersion=appVersion,window.self!==window.top&&window.top.postMessage("logout","*")}function getInfo4Extension(){if(window.self!==window.top){var loginStr="login?t="+localStorage.getItem("userKey")+"&o="+localStorage.getItem("userOrgKey")+"&i="+localStorage.getItem("userInstanceKey");window.top.postMessage(loginStr,"*")}}function fullapplink(){var urlString=AppSite+"?dept="+localStorage.getItem("userInstanceKey")+"&org="+localStorage.getItem("userOrgKey");return isPhonegap?$(".fullapplink").on("click",function(e){e.preventDefault(),openURLsystem(urlString)}):window.self!==window.top?$(".fullapplink").on("click",function(e){e.preventDefault();var origOpenFunc=window.__proto__.open;origOpenFunc.apply(window,[urlString,"_blank"])}):($(".fullapplink").attr("target","_blank"),$(".fullapplink").attr("href",urlString)),urlString}function htmlEscape(str){return String(str).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function matchKey(search,array){for(var key in array)if(-1!=key.indexOf(search))return key;return""}function addUrls(note,files){var length=files.length,filearray={};if(length){for(var inlineImg=note.match(/\[cid:[^\[\]]*]/g),i=0;length>i;i++)note=note.replaceAll(" "+files[i].name,getFileLink(files[i].url)),filearray['"'+files[i].name.substring(0,files[i].name.lastIndexOf("."))+'"']=files[i].url;if(inlineImg)for(var j=0;j<inlineImg.length;j++){var filename=inlineImg[j].slice(5,-1);filename.indexOf("_link_")>=0?filename=filename.replace("_link_",""):(filename=matchKey(filename.slice(0,-3),filearray),filename=filename&&"undefined"!=typeof filearray[filename]?filearray[filename]:""),filename.length&&(note=note.replaceAll(inlineImg[j],getFileLink(filename)))}length>1&&(note=note.replaceAll("a>,","a>")),note=note.replaceAll("a>.","a>")}return note}function getFileLink(file){var img="";return img=checkURL(file)?'<img class="attachment" src="'+file+'">':"<img style='float:none;' src='img/file.png'>&nbsp;"+decodeURIComponent(file.split("/").slice(-1))+"<p></p>",'<a class="comment_image_link"'+(isPhonegap?" href=# onclick='openURL(\""+file+"\")'>"+img+"</a>":' target="_blank" href="'+file+'">'+img+"</a>")}function filterList(listClass,value_names,init_value){$("body").attr("id","search_wrap"),value_names?value_names&&(value_names=value_names.split(",")):value_names=["blockNumber","responseText","TicketBlockNumber","user_name"];var options={listClass:listClass,item:"item",valueNames:value_names};return featureList=new List("search_wrap",options),init_value&&(featureList.search(init_value),$(".search").val(init_value)),featureList.on("updated",function(){if(featureList.matchingItems.length>1){"There are "+featureList.matchingItems.length+" matching tickets."}else 0===featureList.matchingItems.length&&console.log("Bummer...  0 items found")}),featureList}function float2int(value){return 0|value}function createElipse(text,containerWidth,fontSize){var len=text.length;if(10>=len)return text;var windowWidth=$(window).width();windowWidth>650&&(windowWidth=650);var characterSpace;return containerWidth*=windowWidth,characterSpace=containerWidth/fontSize,characterSpace=float2int(characterSpace),len-2>characterSpace&&(text=text.substring(0,characterSpace)+"..."),text}function createSpan(elname){var windowH=$(window).height(),elH=$("#content").height();windowH>elH+60&&(elH=windowH-elH-60,$("<p id=fill style='height:"+elH+"px'>&nbsp;</p>").appendTo(elname+""))}var appVersion="23",adMessage="Add invoices functionality",Site="sherpadesk.com/",MobileSite="http://m."+Site,AppSite="https://app."+Site,ApiSite="http://api."+Site,Page=location.pathname.substr(1),isTech=!1,isProject=!0,isTime=!0,isAccount=!0,isLevel=!0,isClass=!0,isLocation=!0,isFreshbook=!0,isExpenses=!0,isTravelCosts=!0,isInvoice=!0,is_MultipleOrgInst=!0,formatDate=function(a){if(!a||a.length<12)return a;var e=a.substring(5,7),r=a.substring(8,10);switch(e){case"01":e="Jan";break;case"02":e="Feb";break;case"03":e="Mar";break;case"04":e="Apr";break;case"05":e="May";break;case"06":e="Jun";break;case"07":e="Jul";break;case"08":e="Aug";break;case"09":e="Sep";break;case"10":e="Oct";break;case"11":e="Nov";break;case"12":e="Dec";break;default:e="nul"}return e+" "+r};Object.toType=function(global){return function(obj){return obj===global?"global":{}.toString.call(obj).match(/\s([a-z|A-Z]+)/)[1].toLowerCase()}}(this);var cacheName="",cacheTime=5e3,isPhonegap=!1,isOnline=!0;document.addEventListener("deviceready",onDeviceReady,!1),document.addEventListener("offline",offLine,!1),document.addEventListener("online",onLine,!1),"function"!=typeof String.prototype.addUrlParam&&(String.prototype.addUrlParam=function(param,value){if(!value||!param)return this;var ch=this.indexOf("?")>0?"&":"?";return this+ch+param+"="+value}),$(document).ajaxError(function(event,request,settings){(403==request.status&&settings.url!==ApiSite+"organizations"||404==request.status&&settings.url===ApiSite+"config")&&logout(settings.url!==ApiSite+"login",request.statusText),setTimeout(function(){$("#loading").hide(),$(".page").show(),redirectToPage()},1e3)}),window.onerror=function(msg,url,line,col,error){var extra=col?"<p>column: "+col:"";extra+=error?"<p>error: "+error:"",line>0&&setTimeout(function(){errorLine("<p onclick='$(\".err\").toggle();'>Click for Error Details:</p><div class=err style='display:none;'>"+msg+"<p>page: "+location.href+"<p>url: "+url+"<p>line: "+line+extra+"</div>"),$("#loading").hide(),$(".page").show()},1e3);var suppressErrorAlert=!0;return suppressErrorAlert},window.onload=function(){"object"==typeof WebPullToRefresh&&WebPullToRefresh.init({loadingFunction:function(){"dash"===cacheName?(localStorage.setItem("storageQueues",""),localStorage.setItem("storageAccountList",""),localStorage.setItem("ticketsStat","")):localStorage.setItem(cacheName,""),location.reload(!1)}})},"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(suffix){return-1!==this.indexOf(suffix,this.length-suffix.length)}),String.prototype.replaceAll=function(find,replace){return this.split(find).join(replace)};var featureList,featureList2,featureList3,featureList4,featureList5;$(document).ready(function(){function getApi(method,data,type){var userKey=localStorage.getItem("userKey"),userOrgKey=localStorage.getItem("userOrgKey"),userInstanceKey=localStorage.getItem("userInstanceKey");return userKey&&userOrgKey&&userInstanceKey?(type||(type="GET"),$.ajax({type:type,beforeSend:function(xhr){xhr.withCredentials=!0,xhr.setRequestHeader("Authorization","Basic "+btoa(userOrgKey+"-"+userInstanceKey+":"+userKey))},url:ApiSite+method,cache:!0,data:data,dataType:"json"}).promise()):void console.log("Invalid organization!")}function getParameterByName(name){var match=RegExp("[?&]"+name+"=([^&]*)").exec(window.location.search);return match&&decodeURIComponent(match[1].replace(/\+/g," "))}function cleanQuerystring(){window.history.replaceState({},document.title,MobileSite+Page)}function showError(e){var error=(((e||{}).responseJSON||{}).ResponseStatus||{}).Message;userMessage.showMessage(!1,error||"Error. Please contact Administrator")}function fillSelect(returnData,element,initialValue,prefix,customValues,envelope_start,envelope_end){if(!returnData||!returnData.length)return $(""+element).parent().hide(),0;var names,isCustom=!1;customValues&&customValues.length>0&&(names=customValues.split(","),names.length>0&&(isCustom=!0)),prefix=prefix||"",initialValue=initialValue||"",envelope_start=envelope_start||"",envelope_end=envelope_end||"";var insert=initialValue,i=0;for(i=0;i<returnData.length;i++){var value=returnData[i].id,name="";if(isCustom){for(var len=names.length-1,j=0;len>j;j++)name+=" "+returnData[i][names[j]];var email=returnData[i][names[len]];name.trim()?name+=" ("+email+")":name=email}else name=returnData[i].name;insert+="<option value="+value+">"+prefix+name+"</option>"}return i>0?($(""+envelope_start+insert+envelope_end).appendTo(""+element),$(""+element).parent().show(),$(""+element).parent().parent().show()):$(""+element).parent().hide(),i}function fillClasses(classResults,element,initialValue){return isClass?(fillSelect(classResults,element,initialValue,"Class: "),void $(""+element).on("change",function(){$(".sub_class1, .sub_class2").is(":visible")&&($(".sub_class1, .sub_class2").hide(),$("#sub_class1, #sub_class2").empty());var classSelected0=$(element+" option:selected").val(),classSub=$.grep(classResults,function(a){return a.id==classSelected0});selectedEditClass=classSelected0,"undefined"!=typeof classSub[0]&&(null!==classSub[0].sub||classSub[0].sub>0)&&(fillSelect(classSub[0].sub,"#sub_class1","<option value="+selectedEditClass+">choose a sub class</option>","Sub class: "),$("select#sub_class1").on("change",function(){$(".sub_class2").is(":visible")&&($(".sub_class2").hide(),$("#sub_class2").empty());var classSelected1=$("select#sub_class1 option:selected").val(),classSub1=$.grep(classSub[0].sub,function(a){return a.id==classSelected1});selectedEditClass=classSelected1,"undefined"!=typeof classSub1[0]&&(classSub1[0].sub>0||null!==classSub1[0].sub)&&(fillSelect(classSub1[0].sub,"#sub_class2","<option value="+selectedEditClass+">Sub Sub Class: ---</option>","Sub Sub Class: "),$("select#sub_class2").on("change",function(){var classSelected2=$("select#sub_class2 option:selected").val();selectedEditClass=classSelected2}))}))})):void $(""+element).parent().parent().hide()}function routing(){if("tech"===localStorage.getItem("userRole")&&(isTech=!0),"false"===localStorage.getItem("projectTracking")&&(isProject=!1),"false"===localStorage.getItem("timeTracking")&&(isTime=!1),"false"===localStorage.getItem("accountManager")&&(isAccount=!1),"false"===localStorage.getItem("ticketLevels")&&(isLevel=!1),"false"===localStorage.getItem("classTracking")&&(isClass=!1),"false"===localStorage.getItem("locationTracking")&&(isLocation=!1),"false"===localStorage.getItem("freshbooks")&&(isFreshbook=!1),"false"===localStorage.getItem("is_invoice")&&(isInvoice=!1),"false"===localStorage.getItem("is_expenses")&&(isExpenses=!1),"false"===localStorage.getItem("is_travel_costs")&&(isTravelCosts=!1),"false"===localStorage.getItem("sd_is_MultipleOrgInst")?(is_MultipleOrgInst=!1,$("#switchOrg").hide()):$("#switchOrg").show(),isTime||$(".time").remove(),localStorage.appVersion!==appVersion&&(localStorage.setItem("appVersion",appVersion),console.log("Version updated to "+appVersion),adMessage.length>1?setTimeout(function(){userMessage.showMessage(!0,adMessage,updatedFunction)},3e3):location.reload(!0)),fullapplink(),"undefined"!=typeof navigator.splashscreen&&navigator.splashscreen.hide(),isTech||$(".sideNavLinks").children(":not('.user')").hide(),"ticket_list.html"==Page)return localStorage.DetailedAccount=localStorage.addAccountTicket="",void ticketList.init();if("ticket_detail.html"==Page)return detailedTicket.init(),pickUpTicket.init(),transferTicket.init(),closeTicket.init(),void postComment.init();if(isTech){if(isAccount||$("#itemAccount").parent().hide(),isInvoice||($("#itemInvoice").hide(),$("#invoiceFooter").hide()),isExpenses||$(".expense").hide(),"dashboard.html"==Page){localStorage.DetailedAccount=localStorage.addAccountTicket="";var orgName=localStorage.getItem("userOrg");return orgName&&$("#indexTitle").html(orgName),TicketsCounts.init(),getQueues.init("#DashBoradQueues",3),isAccount&&accountList.init("#activeList",1),void search.init()}if("Account_List.html"==Page&&isAccount)return localStorage.DetailedAccount=localStorage.addAccountTicket="",void accountList.init("#fullList");if("timelog.html"==Page&&isTime)return void timeLogs.init();if("allInvoice_List.html"==Page&&isTime&&isInvoice)return void invoiceList.init();if("Queues.html"==Page)return void getQueues.init("#queuesPage");if("queueTickets.html"==Page)return void getQueueTickets.init();if("closedTickets.html"==Page)return void closedTickets.init();if("addTicketTime.html"==Page&&isTime)return void addTime.init();var currPage=Page+"_ref";if(backFunction=function(){var reff=localStorage.getItem(currPage);reff?(localStorage.setItem(currPage,""),window.location.replace(reff)):history.back()},localStorage.getItem(currPage)||localStorage.setItem(currPage,document.referrer||localStorage.referrer||"index.html"),"account_details.html"==Page&&isAccount)return isInvoice||$("#invoiceOption").parent().remove(),accountDetailsPageSetup.init(),void closedTickets.pageChange();if("accountTimes.html"==Page&&isTime&&isAccount)return void accountTimeLogs.init();if("Invoice_List.html"==Page&&isTime&&isInvoice)return void invoiceList.init();if("unInvoice_List.html"==Page&&isTime&&isInvoice)return void invoiceList.init("unbilled");if("invoice.html"==Page&&isTime&&isInvoice)return void detailedInvoice.init();if("add_time.html"==Page&&isTime)return void addTime.init();if("add_user.html"==Page)return void addUser.init();if("addExpence.html"==Page&&isExpenses)return void addExpence.init();if("edit_time.html"==Page&&isTime)return void addTime.init(!0)}return"add_tickets.html"==Page?void newTicket.init():void(window.location=isTech?"dashboard.html":"ticket_list.html")}var img=new Image;img.src=MobileSite+"img/error-background.png";var selectedEditClass,userOrgKey="",userOrg="",userInstanceKey="",userKey="",UserLogin={init:function(){var loginPage=!0;if("index.html"!=Page&&""!=Page&&(loginPage=!1),userKey=localStorage.getItem("userKey"),userOrgKey=localStorage.getItem("userOrgKey"),userInstanceKey=localStorage.getItem("userInstanceKey"),!(userKey&&userOrgKey&&userInstanceKey||loginPage||"org.html"==Page||"signup.html"==Page))return void logout();if(loginPage){if(userKey&&userOrgKey&&userInstanceKey)return void getInstanceConfig(userOrgKey,userInstanceKey);if(userKey)return void(window.location="org.html");var key=getParameterByName("t"),email=getParameterByName("e");if(key)return cleanQuerystring(),localStorage.setItem("is_google",!0),localStorage.setItem("userKey",key),localStorage.setItem("userName",email),void(window.location="org.html");var error=getParameterByName("f");error&&(cleanQuerystring(),userMessage.showMessage(!1,error)),this.login()}},do_login:function(){var userName=$("#userName").val(),password=$("#password").val();return""===userName||""===password?void userMessage.showMessage(!1,"Please enter a valid Email or Password"):void $.ajax({type:"POST",beforeSend:function(xhr){xhr.withCredentials=!0,xhr.setRequestHeader("Authorization","Basic "+btoa(userName+":"+password))},url:ApiSite+"login",dataType:"json",success:function(returnData){localStorage.setItem("userKey",returnData.api_token),localStorage.setItem("userName",userName),window.location="org.html"},complete:function(){},error:function(){userName&&-1!=userName.indexOf("@gmail.com")?userMessage.showMessage(!1,"Wrong Password, Google sign password is not neeeded"):(userMessage.showMessage(!1,"There was a problem with your login.  Please try again."),$("#password").val(""))}})},login:function(){$(".page").show(),userKey=localStorage.getItem("userKey");var userName=localStorage.getItem("userName");null!==userName&&userName.length>0&&$("#userName").val(userName),$("#login_signup").on("click",function(e){e.preventDefault(),document.location.href="signup.html"}),$("form.google_openid").get(0).setAttribute("action",ApiSite+"auth/auth0"),$("#sign_in_with_google").on("click",function(e){e.preventDefault(),window.self!==window.top,$("form.google_openid").get(0).submit()}),$("#loginButton").click(function(){UserLogin.do_login()}),$(document).on("keypress","#password, #userName",function(e){13==e.which&&UserLogin.do_login()}),reveal()}},OrgSignup={init:function(){if("signup.html"==Page){var userName=localStorage.getItem("userName");null!==userName&&userName.length>0&&$("#email").val(userName),$("#signupButton").click(function(){OrgSignup.add()}),$(document).on("change","#name",function(){var t=$("#name").val();t&&$("#url").val(t.replace(/[^a-zA-Z 0-9]+|[\s]+/g,"").toLowerCase())}),$("#is_force_registration").prop("checked",!1),reveal()}},add:function(){var name=$("#name").val(),email=$("#email").val(),url=$("#url").val(),firstname=$("#firstname").val(),lastname=$("#lastname").val(),password=$("#password").val(),password_confirm=$("#password_confirm").val(),how=$("#how").val();return""===name||""===email||""===url||""===firstname||""===lastname||""===password||""===password_confirm?void userMessage.showMessage(!1,"Please enter all fields!"):password!=password_confirm?void userMessage.showMessage(!1,"Passwords do not match!"):void $.ajax({type:"POST",url:ApiSite+"organizations",dataType:"json",data:{name:name,email:email,url:url,is_force_registration:$("#is_force_registration").is(":checked"),firstname:firstname,lastname:lastname,password:password,password_confirm:password_confirm,how_did_you_hear_about_us:how,note:isPhonegap?"registered by iPhone":"registered from mobile site"},success:function(returnData){return returnData.api_token?returnData.organization&&returnData.instance?(localStorage.setItem("userKey",returnData.api_token),localStorage.setItem("userName",email),localStorage.setItem("userOrgKey",returnData.organization),localStorage.setItem("userInstanceKey",returnData.instance),localStorage.setItem("userRole","user"),void getInstanceConfig(returnData.organization,returnData.instance)):void(window.location="org.html"):void(window.location="index.html")},error:function(event){return 409==event.status?(userMessage.showMessage(!1,"This email is already in use. Please choose action below"),localStorage.setItem("userName",$("#email").val()),$("#is_force_registration").prop("checked",!0),$("#signupButton").before("<center><h3 style='padding-top: 10px;'>This email is already in use. Would you like to</h3> <div class=loginButton onclick='window.location = \"index.html\"'>Login</div><h3>or</h3></center>"),void $("#signupButton").text("Create New Organization")):void userMessage.showMessage(!1,event.statusText)}})}},closedTickets={init:function(){this.showClosedTickets(),this.pageChange()},pageChange:function(){$(".buttonShowClosedTickets").click(function(){window.location="closedTickets.html"})},showClosedTickets:function(){"truePos"==localStorage.getItem("isMessage")&&userMessage.showMessage(!0);var cacheName1="closed",retrievedObject=localStorage.getItem(cacheName1+"tickets"),time=cacheTime;retrievedObject&&(retrievedObject=JSON.parse(retrievedObject)),retrievedObject&&0!=retrievedObject.length?(ticketList.createTicketsList(retrievedObject,"#closedTickets"),filterList("closedTickets")):(console.log("could not load local data"),time=10),setTimeout(function(){getApi("tickets?status=closed&account="+localStorage.getItem("DetailedAccount")).then(function(returnData){ticketList.createTicketsList(returnData,"#closedTickets",cacheName1),filterList("closedTickets")},function(e){showError(e),console.log("fail @ closed accounts tickets")})},time)}},pickUpTicket={init:function(){this.pick()},pick:function(){$("#pickUp").click(function(){getApi("tickets/"+localStorage.getItem("ticketNumber"),{action:"pickup",note_text:""},"PUT").then(function(){userMessage.showMessage(!0,'Ticket pickup was Succesfull <i class="fa fa-thumbs-o-up"></i>'),window.location="ticket_detail.html"},function(e){showError(e),console.log("fail @ pickup")})})}},transferTicket={init:function(){this.transfer()},transfer:function(){$("#transfer").click(function(){$("#loading").removeAttr("style"),$("#loading").show(),$("#transfer").hide(),$("#transferSelect").show(),getApi("technicians?limit=200").then(function(returnData){var insert="<option value=0 disabled selected> Choose Tech</option>";$(insert).appendTo("#transferTechs");for(var i=0;i<returnData.length;i++){var value=returnData[i].id,name=returnData[i].firstname+" "+returnData[i].lastname;insert="<option value="+value+">"+name+"</option>",$(insert).appendTo("#transferTechs")}reveal()},function(e){showError(e),console.log("fail @ listTechs")}),$("#transferTechs").on("change",function(){var techId=$("#transferTechs").val();getApi("tickets/"+localStorage.getItem("ticketNumber"),{action:"transfer",note_text:" ",tech_id:techId,keep_attached:!1},"PUT").then(function(){location.reload(!1)},function(e){showError(e),console.log("fail @ transferTechs")})})})}},closeTicket={init:function(){this.closeIt(),this.reopenIt()},reopenIt:function(){$("#openIt").click(function(){getApi("tickets/"+localStorage.getItem("ticketNumber"),{status:"open",note_text:""},"PUT").then(function(){setTimeout(function(){userMessage.showMessage(!0,'Ticket has been Reopened <i class="fa fa-thumbs-o-up"></i>'),window.history.back()},1e3)},function(e){showError(e),console.log("fail @ ticketNumber")})})},close:function(closeTicketMessage){return closeTicketMessage=htmlEscape(closeTicketMessage).trim(),closeTicketMessage.length<2?void userMessage.showMessage(!1,"Note cannot be empty!"):closeTicketMessage.length>5e3?void userMessage.showMessage(!1,"Note cannot be more than 5000 chars!"):void getApi("tickets/"+localStorage.getItem("ticketNumber"),{status:"closed",note_text:closeTicketMessage,is_send_notifications:!0,resolved:!0,dataType:"json",confirmed:!1,confirm_note:""},"PUT").then(function(){setTimeout(function(){userMessage.showMessage(!0,'Ticket has been closed <i class="fa fa-thumbs-o-up"></i>'),window.history.back()},1e3),userMessage.setMessage(!0,"Ticket was Closed <i class='fa fa-thumbs-o-up'></i>")},function(e){showError(e),console.log("fail @ ticket Number")})},closeIt:function(){$("#closeIt").click(function(){$("#closingMessage").slideDown(400,function(){$("#closeMessageButton").fadeIn(),$("html,body").animate({scrollTop:$("#closeMessageButton").offset().top},400)})}),$("#closeMessageButton").click(function(){closeTicket.close($("#closingMessage").val())}),$("#closeu").click(function(){closeTicket.close($("#commentText").val())})}},signout={init:function(){this.logOut()},logOut:function(){$("#signOut").click(logout)}},switchOrg={init:function(){this.changeOrg()},changeOrg:function(){is_MultipleOrgInst&&$("#switchOrg").click(function(){var appVersion=localStorage.appVersion,userKey=localStorage.userKey,userName=localStorage.userName;localStorage.clear(),localStorage.userName=userName,localStorage.userKey=userKey,localStorage.appVersion=appVersion,window.location="org.html"})}},newTicket={init:function(){$("#userCreate").on("click",function(){var user=$("#addTicketUser").val();user&&localStorage.setItem("add_user_userid",user);var tech=$("#addTicketTechs").val();tech&&localStorage.setItem("add_user_techid",tech);var account=$("#addTicketAccounts").val();account&&localStorage.setItem("add_user_accountid",account),window.location="add_user.html"}),$("#TechCreate").on("click",function(){localStorage.setItem("add_user_type","tech");var user=$("#addTicketUser").val();user&&localStorage.setItem("add_user_userid",user);var tech=$("#addTicketTechs").val();tech&&localStorage.setItem("add_user_techid",tech);var account=$("#addTicketAccounts").val();account&&localStorage.setItem("add_user_accountid",account),window.location="add_user.html"}),this.addTicket()},addTicket:function(){$("#addTicketAccounts").empty();var accountset=localStorage.getItem("addAccountTicket");if(localStorage.setItem("addAccountTicket",""),isTech)if(isAccount){var accounts=getApi("accounts?limit=300",{is_with_statistics:!1});accounts.then(function(returnData){$("#addTicketAccounts").empty(),fillSelect(returnData,"#addTicketAccounts","<option value=0 disabled selected>choose an account</option>");var account=localStorage.getItem("add_user_accountid");accountset=accountset?accountset:account,accountset&&(localStorage.setItem("add_user_accountid",""),$("#addTicketAccounts").val(accountset)),reveal()},function(e){showError(e),console.log("fail @ ticket accounts")})}else $("#addTicketAccounts").parent().hide(),reveal();else $("#addTicketAccounts").parent().hide();if(isTech){var userid=localStorage.getItem("add_user_userid");userid?localStorage.setItem("add_user_userid",""):userid=localStorage.getItem("userId");var userName=localStorage.getItem("add_user_name");userName?localStorage.setItem("add_user_name",""):userName=localStorage.getItem("userFullName"),userName.trim()||(userName=localStorage.getItem("userName")),$("#addTicketUser").append("<option value="+userid+" selected>"+userName+"</option>");var users=getApi("users?limit=2000");users.then(function(returnData){fillSelect(returnData,"#addTicketUser","","","firstname,lastname,email"),$("#addTicketUser").val(userid)},function(e){showError(e),console.log("fail @ TicketUser")})}else $("#addTicketUser").parent().hide(),$("#userCreate").hide();if(isTech){var technicians=getApi("technicians?limit=200");technicians.then(function(returnData){fillSelect(returnData,"#addTicketTechs","<option value=0 disabled selected>choose a tech</option>","","firstname,lastname,email");var techid=localStorage.getItem("add_user_techid");techid&&(localStorage.setItem("add_user_techid",""),$("#addTicketTechs").val(techid))},function(e){showError(e),console.log("fail @ Ticket Techs")})}else $("#addTicketTechs").parent().hide(),$("#TechCreate").hide();if(isTech){var classes=getApi("classes");classes.done(function(classResults){fillClasses(classResults,"#classTicketOptions","<option value=0 disabled selected>choose a class</option>")})}else $(".add_class").hide();$("#submitNewTicket").click(function(){var subject=htmlEscape($("#addTicketSubject").val().trim()),post=htmlEscape($("#addTicketInitPost").val().trim());if(""===subject||""===$("#addTicketTechs").val()||1>selectedEditClass)userMessage.showMessage(!1,"Please enter subject");else if(subject.length>100)userMessage.showMessage(!1,"Subject should be less 100 chars!");else if(post.length>5e3)userMessage.showMessage(!1,"Details cannot be more than 5000 chars!");else{var addTicket=getApi("tickets",{status:"open",subject:subject,initial_post:post,class_id:selectedEditClass,account_id:$("#addTicketAccounts").val(),user_id:isTech?$("#addTicketUser").val():localStorage.getItem("userId"),tech_id:$("#addTicketTechs").val()},"POST");addTicket.then(function(){isTech?setTimeout(backFunction,1e3):location.replace("ticket_list.html"),userMessage.setMessage(!0,"Ticket was Succesfully Created :)")},function(e){showError(e),console.log("fail @ tickets")})}})}},postComment={init:function(){this.sendComment()},sendComment:function(){$("#reply").click(function(){var comment=htmlEscape($("#commentText").val().trim());return comment?comment.length>5e3?void userMessage.showMessage(!1,"Note cannot be more than 5000 chars!"):void getApi("tickets/"+localStorage.getItem("ticketNumber"),{note_text:comment,action:"response"},"POST").then(function(){location.reload(!1)},function(e){showError(e),console.log("fail @ ticket Number")}):void userMessage.showMessage(!1,"Please enter note")})}},search={init:function(){this.universalSearch()},universalSearch:function(){$(document).on("keypress","#searchThis",function(e){if(13==e.which){var searchItem=$(".headerSearch").val().toLowerCase();return localStorage.setItem("searchItem",searchItem),localStorage.setItem("ticketPage","asTech"),void(window.location="ticket_list.html")}})}},addExpence={init:function(){this.addExpence(getParameterByName("ticket"))},addExpence:function(ticket_id){var account_id=localStorage.DetailedAccount?localStorage.DetailedAccount:-1,project_id=0;if(!isAccount||ticket_id?($("#timeAccounts").parent().hide(),reveal()):getApi("accounts?limit=300",{is_with_statistics:!1}).then(function(returnData){for(var insert="<option value=0>choose an account</option>",i=0;i<returnData.length;i++)insert+="<option value="+returnData[i].id+">"+returnData[i].name+"</option>";$("#timeAccounts").html(insert),account_id&&$("#timeAccounts").val(account_id),$("#timeAccounts").on("change",function(){addTime.chooseProjects(0,0,0)}),reveal()},function(e){showError(e),console.log("fail @ time Accounts")}),!isProject||ticket_id)$("#timeProjects").parent().hide(),reveal();else{var chooseProject="<option value=0>choose a project</option>";$(chooseProject).appendTo("#timeProjects"),addTime.chooseProjects(account_id,project_id,0)}$("#addexpenseButton").click(function(){var money=$("#expenseAmount").val();if(!money)return void userMessage.showMessage(!1,"Please enter amount");var note=htmlEscape($("#expenseNote").val()).trim();return note.length<1?void userMessage.showMessage(!1,"Please enter note"):void getApi("expenses",{ticket_key:ticket_id?ticket_id:null,account_id:ticket_id?null:$("#timeAccounts").val(),project_id:ticket_id?null:$("#timeProjects").val(),tech_id:localStorage.getItem("user_id"),note:note,note_internal:$("#expenseInternal").val(),amount:money,is_billable:$(".innerCircle").hasClass("billFill"),vendor:$("#vendor").val()},"POST").then(function(){localStorage.setItem("isMessage","truePos"),localStorage.setItem("userMessage",'Expense was successfully added <i class="fa fa-money"></i>'),backFunction()},function(e){showError(e),console.log("fail @ pickup")})})}},addUser={init:function(){$(".innerCircle").click(function(){$(".innerCircle").hasClass("billFill")?($("#addTicketPassword").hide(),$("#addTicketConfirmPassword").hide()):($("#addTicketPassword").show(),$("#addTicketConfirmPassword").show())});var value=localStorage.getItem("add_user_type");"tech"==value?($(".SherpaDesk").text("Add New Tech"),$(".greenButton").text("Add New Tech"),value="Tech"):value="User",$("#submitNewUser").click(function(){var email=$("#addTicketEmail").val().trim();
if(email.length<1)return void userMessage.showMessage(!1,"Please enter email");if(!checkEmail(email))return void userMessage.showMessage(!1,"Please correct email");var Firstname=$("#addTicketFirstname").val().trim();return Firstname.length<1?void userMessage.showMessage(!1,"Please enter Firstname"):(Lastname=$("#addTicketLastname").val().trim(),Lastname.length<1?void userMessage.showMessage(!1,"Please enter Lastname"):void getApi("users",{Lastname:Lastname,Firstname:Firstname,email:email,role:value},"POST").then(function(d){userMessage.showMessage(!0,value+' was created <i class="fa fa-thumbs-o-up"></i>',function(){localStorage.setItem("add_user_name",""),"Tech"==value?localStorage.setItem("add_user_techid",d.id):(localStorage.setItem("add_user_userid",d.id),localStorage.setItem("add_user_name",Firstname+" "+Lastname)),backFunction()})},function(e){showError(e),console.log("fail @ pickup")}))})}},addTime={init:function(isEdit){this.addpicker(),this.inputTime(isEdit)},addpicker:function(){jQuery("#date_start").datetimepicker({mask:!1,step:5,onShow:function(){var dat,dat1=jQuery("#date_end").val();dat1&&(dat=new Date(dat1),dat.setDate(dat.getDate())),this.setOptions({maxDate:dat1?dat:!1})}}),jQuery("#date_end").datetimepicker({mask:!1,step:5,onShow:function(){var dat,dat1=jQuery("#date_start").val();dat1&&(dat=new Date(dat1),dat.setDate(dat.getDate())),this.setOptions({minDate:dat1?dat:!1})}})},getTaskTypes:function(data,task_type_id){task_type_id=task_type_id||0,$("#taskTypes").empty(),$("<option value=0>choose a task type</option>").appendTo("#taskTypes");var taskTypes=getApi("task_types",data);taskTypes.then(function(returnData){$("#taskTypes").empty(),fillSelect(returnData,"#taskTypes","<option value=0>choose a task type</option>"),task_type_id>0&&$("#taskTypes").val(task_type_id),reveal()},function(e){showError(e),console.log("fail @ task Types")})},chooseProjects:function(account,project_id,task_type_id){"undefined"==typeof account&&(account=-1),project_id=project_id||0,task_type_id=task_type_id||0,account||(account=isAccount?$("#timeAccounts").val():-1),isProject?($("#timeProjects").on("change",function(){var project=$("#timeProjects").val();addTime.getTaskTypes({account:account,project:project},task_type_id)}),$("#timeProjects").empty(),$("<option value=0>choose a project</option>").appendTo("#timeProjects"),"0"!==account?($("#loading").fadeIn(),getApi("accounts/"+account,{is_with_statistics:!1}).then(function(returnData){fillSelect(returnData.projects,"#timeProjects"),$("#timeProjects").val(project_id),addTime.getTaskTypes({account:account,project:project_id},task_type_id),reveal()},function(e){showError(e),console.log("fail @ time Projects")})):$("#timeProjects").parent().show()):addTime.getTaskTypes({account:account},task_type_id)},inputTime:function(isEdit){{var ticketKey=localStorage.getItem("ticketNumber"),isBillable=!0;(new Date).toJSON().slice(0,10)}if($("#submitTicketTime").click(function(){var time=$("#addTimeTicket").val(),note=htmlEscape($("#noteTimeTicket").val().trim()),tech=localStorage.getItem("techId"),task_type=$("#ticketTaskTypes").val();if(note.length<1)return void userMessage.showMessage(!1,"Please enter note");if(note.length>5e3)return void userMessage.showMessage(!1,"Note cannot be more than 5000 chars!");isBillable=$(".innerCircle").hasClass("billFill")?!0:!1;var sdat,dat1=jQuery("#date_start").val();dat1&&(sdat=JSON.stringify(new Date(dat1)));var edat,dat2=jQuery("#date_end").val();dat2&&(edat=JSON.stringify(new Date(dat2))),getApi("time",{ticket_key:ticketKey,note_text:note,task_type_id:task_type,hours:time,is_billable:isBillable,date:dat1?sdat:"",start_date:dat1?sdat:"",stop_date:dat2?edat:"",tech_id:tech},"POST").then(function(){localStorage.setItem("isMessage","truePos"),localStorage.setItem("userMessage",'Time was successfully added <i class="fa fa-thumbs-o-up"></i>'),window.location.replace("ticket_detail.html")},function(e){showError(e),console.log("fail @ pickup")})}),$("#submitTicketTime").length)addTime.getTaskTypes({ticket:ticketKey},0);else{var timeLog=0,timeEntry=localStorage.getItem("timeNumber");isEdit&&timeEntry&&(timeLog=JSON.parse(timeEntry),timeLog.billable||$(".innerCircle").removeClass("billFill"),$("#noteTime").val(timeLog.note),$("#addTimeTicket").val(timeLog.hours),$(".title").html("Time #"+timeLog.time_id+" by "+timeLog.user_name+" @ "+new Date(timeLog.date).dateFormat("Y/m/d H:i")),timeLog.start_time&&$("#date_start").val(new Date(timeLog.start_time).dateFormat("Y/m/d H:i")),timeLog.stop_time&&$("#date_end").val(new Date(timeLog.stop_time).dateFormat("Y/m/d H:i")));var account_id=localStorage.DetailedAccount?localStorage.DetailedAccount:-1,project_id=0,task_type_id=0;if(timeLog&&(account_id=timeLog.account_id,project_id=timeLog.project_id,task_type_id=timeLog.task_type_id),isAccount?(getApi("accounts?limit=300",{is_with_statistics:!1}).then(function(returnData){$("#timeAccounts").empty();var chooseAccount="<option value=0>choose an account</option>";$(chooseAccount).appendTo("#timeAccounts");for(var insert="",i=0;i<returnData.length;i++)insert+="<option value="+returnData[i].id+">"+returnData[i].name+"</option>";$(insert).appendTo("#timeAccounts"),$("#timeAccounts").val(account_id),reveal()},function(){showError(e),console.log("fail @ time accounts")}),$("#timeAccounts").on("change",function(){addTime.chooseProjects(0,project_id,task_type_id)})):$("#timeAccounts").parent().hide(),isProject){var chooseProject="<option value=0>choose a project</option>";$(chooseProject).appendTo("#timeProjects"),addTime.chooseProjects(account_id,project_id,task_type_id),reveal()}else $("#timeProjects").parent().hide();$("#taskTypes").empty(),$("<option value=0>choose a task type</option>").appendTo("#taskTypes"),isAccount||isProject||addTime.getTaskTypes({account:account_id,project:project_id},task_type_id),$("#submitTime").click(function(){var time=$("#addTimeTicket").val(),note=htmlEscape($("#noteTime").val().trim()),tech=localStorage.getItem("userId"),accountId=$("#timeAccounts").val(),projectId=$("#timeProjects").val(),taskId=$("#taskTypes").val();isBillable=$(".innerCircle").hasClass("billFill")?!0:!1;var sdat,dat1=jQuery("#date_start").val();dat1&&(sdat=JSON.stringify(new Date(dat1)));var edat,dat2=jQuery("#date_end").val();return dat2&&(edat=JSON.stringify(new Date(dat2))),0===time?void userMessage.showMessage(!1,"Oops not enough time"):"0"==accountId&&isAccount?void userMessage.showMessage(!1,"choose an account"):(ticketKey=parseInt(isEdit?timeLog.ticket_id:ticketKey),void getApi("time"+(isEdit?"/"+timeLog.time_id:""),{tech_id:isEdit?timeLog.user_id:tech,project_id:projectId,is_project_log:!ticketKey,ticket_id:ticketKey,account_id:accountId,note_text:note,task_type_id:taskId,hours:time,is_billable:isBillable,date:dat1?sdat:"",start_date:dat1?sdat:"",stop_date:dat2?edat:""},isEdit?"PUT":"POST").then(function(){localStorage.setItem("isMessage","truePos"),localStorage.setItem("userMessage",'Time was successfully added <i class="fa fa-thumbs-o-up"></i>'),backFunction()},function(e){showError(e),console.log("fail @ pickup")}))})}}},detailedTicket={init:function(){isTech?$("#closeu").hide():($(".tabs").hide(),$("#closeu").show()),this.showTicket(),this.updateTicket()},updateTicket:function(){$(".updateButton").click(function(){var ticketClass=selectedEditClass,ticketLevel=$("#ticketLevel").val(),ticketPriority=$("#ticketPriority").val(),ticketProject=$("#ticketProject").val(),response={class_id:ticketClass,level_id:ticketLevel,priority_id:ticketPriority,project_id:ticketProject};getApi("tickets/"+localStorage.getItem("ticketId"),response,"PUT").then(function(){console.log("Then Complete"),userMessage.setMessage(!0,"Ticket was successfully updated <i class='fa fa-thumbs-o-up'></i>"),window.location="ticket_detail.html",userMessage.showMessage(!0)})})},showTicket:function(){"truePos"==localStorage.getItem("isMessage")&&userMessage.showMessage(!0),$("html,body").css("scrollTop","0"),getApi("tickets/"+localStorage.getItem("ticketNumber")).then(function(returnData){var daysOld=returnData.daysold_in_minutes/-60;localStorage.setItem("techId",returnData.tech_id),localStorage.setItem("ticketId",returnData.id),$("#ticketExpense").attr("href","addExpence.html?ticket="+returnData.id),daysOld=daysOld>24?parseInt(daysOld/24)+" days ago":parseInt(daysOld)+" hours ago","Closed"==returnData.status?($("#closeIt").hide(),$("#closeu").hide()):$("#openIt").hide();var ticketHours=returnData.total_hours;$("#ticketNumber").html(returnData.status+" | "+returnData.number),$("#ticketSubject").html(returnData.subject),$("#ticketClass").html(returnData.class_name),$("#ticketTech").html(returnData.tech_firstname),$("#lastUpdate").html(daysOld),returnData.misc_cost?$("#expenses").html("Expenses: "+localStorage.currency+Number(returnData.misc_cost).toFixed(2).toString()):$("#expenses").hide(),0!==ticketHours?$("#ticketHours").html(ticketHours+" Hours"):$("#ticketHours").hide(),null===returnData.sla_complete_date?$("#ticketSLA").hide():$("#ticketSLA").html("SLA: "+returnData.sla_complete_date.toString().substring(0,10));var ticketTech=returnData.tech_email;ticketTech==localStorage.getItem("userName")&&$("#pickUp").hide();var classes=getApi("classes"),priorities=getApi("priorities");$("#ticketLevel").empty(),isLevel?getApi("levels").done(function(levelResults){fillSelect(levelResults,"#ticketLevel","","Level: ")>0&&$("#ticketLevel").val(returnData.level)}):$("#ticketLevel").parent().hide(),$("#classOptions").empty(),classes.done(function(classResults){selectedEditClass=returnData.class_id,fillClasses(classResults,"#classOptions","<option data-classId="+returnData.class_id+" value="+returnData.class_id+">Class: "+returnData.class_name+"</option>")}),$("#ticketPriority").empty(),priorities.done(function(prioritiesResults){for(var priorityInsert="",b=0;b<prioritiesResults.length;b++)priorityInsert+="<option value="+prioritiesResults[b].id+">Priority: "+prioritiesResults[b].priority_level+" - "+prioritiesResults[b].name+"</option>";$(priorityInsert).appendTo("#ticketPriority"),$("#ticketPriority").val(returnData.priority_id)}),$("#ticketTechs").empty();for(var insert="",b=0;b<returnData.technicians.length;b++)insert+="<option value="+returnData.technicians[b].user_id+">"+returnData.technicians[b].user_fullname+"</option>";if($(insert).appendTo("#ticketTechs"),$("#location").remove(),isProject){var projects=getApi("projects");projects.done(function(projectResults){fillSelect(projectResults,"#ticketProject",""==returnData.project_name?"<option value='null' disabled selected>Project</option>":"")>0&&""!=returnData.project_name&&$("#ticketProject").val(returnData.project_id)})}else $("#project").hide();var logslen=returnData.ticketlogs.length,files=returnData.attachments||[];files.sort(function(a,b){return b.name.length-a.name.length}),$(".orginalMessageContainer").empty(),detailedTicket.createLogs([returnData.ticketlogs.shift()],".orginalMessageContainer",files),logslen>1&&($("#comments").empty(),detailedTicket.createLogs(returnData.ticketlogs,"#comments",files)),reveal()},function(e){showError(e),console.log("fail @ Ticket Detail"),setTimeout(function(){window.location="ticket_list.html"},2e3)})},createLogs:function(logs,parent,files){for(var len=logs.length,insert=[],$table=$(parent),c=0;len>c;c++){var email=$.md5(logs[c].user_email),type=logs[c].log_type,userName=logs[c].user_firstname+" "+logs[c].user_lastname,note=logs[c].note,date=formatDate(logs[c].record_date);insert[c]="<ul class='commentBlock'><li><img src='http://www.gravatar.com/avatar/"+email+"?d=mm&s=80' class='commentImg'></li><li class='commentText'><h3>"+userName+"</h3></li><li><span>"+date+"</span></li><li class='commentText'><p>"+$("<span />",{html:note.replace(/<br\s*[\/]?>/gi,"\n")}).text().replace(/\n/g,"<p></p>")+"</p></li><li>"+type+"</li></ul>"}var notes=addUrls(insert.join(""),files);$table.html(notes)}},detailedInvoice={init:function(){-1!=localStorage.invoiceNumber.indexOf(",")&&($("#sendInvoiceButton").html("Create Invoice"),$("#invoiceNumber").html("Create Invoice")),this.specifics()},specifics:function(){var data=localStorage.invoiceNumber;-1!=data.indexOf(",")?(data=data.split(","),data="?status=unbilled&account="+data[0]+"&project="+data[1]):data="/"+data;var start_date,end_date;getApi("invoices"+data).then(function(returnData){localStorage.setItem("invoiceAccountId",returnData.account_id),localStorage.setItem("invoiceProjectId",returnData.project_id),start_date=returnData.start_date||(new Date).toJSON(),end_date=returnData.end_date||(new Date).toJSON(),$("#invoiceNumber").html(returnData.id?"Invoice  #"+returnData.id:"Create Invoice");var nameCheck=createElipse(returnData.customer,.9,12);$("#customerName").html(nameCheck);var date=formatDate(returnData.date);$("#invoiceDate").html(date),$("#invoiceHours").html(returnData.total_hours+"<span class='detail3Small'>hrs</span>");var amount=Number(returnData.amount).toFixed(2).toString(),change=amount.substring(amount.length-3,amount.length),amount=amount.substring(0,amount.length-3);if($("#invoiceAmount").html(localStorage.getItem("currency")+amount+"<span class='detail3Small'>"+change+"</span>"),isTravelCosts?$("#invoiceTravel").html(localStorage.getItem("currency")+returnData.travel_cost+"<span class='detail3Small'>.00</span>"):$("#invoiceTravel").parent().parent().hide(),isExpenses){var expenses=0;if(null!=returnData.expenses)for(var i=0;i<returnData.expenses.length;i++)expenses+=returnData.expenses[i].total;$("#invoiceExpenses").html(localStorage.getItem("currency")+expenses+"<span class='detail3Small'>.00</span>")}else $("#invoiceExpenses").parent().parent().hide();if($("#invoiceAdjustments").html(localStorage.getItem("currency")+"0<span class='detail3Small'>.00</span>"),amount=Number(returnData.total_cost).toFixed(2).toString(),change=amount.substring(amount.length-3,amount.length),amount=amount.substring(0,amount.length-3),$(".invoiceTotal").html(localStorage.getItem("currency")+amount+"<span class='detail3Small'>"+change+"</span>"),$("#recipientList").empty(),returnData.recipients&&returnData.recipients.length>0){returnData.recipients.sort(function(a,b){return a.is_accounting_contact<b.is_accounting_contact?1:-1});for(var x=0;x<returnData.recipients.length;x++){var email=$.md5(returnData.recipients[x].email),insert="<li class=recipientParent><ul class='recipientDetail'><li><img src='http://www.gravatar.com/avatar/"+email+"?d=mm&s=80'></li><li><div class='recipient'><p>"+createElipse(returnData.recipients[x].email,.9,12)+"</p>"+(returnData.recipients[x].is_accounting_contact?"<img class='plusIcon' id=\""+returnData.recipients[x].email+"\"  src='img/check.png'> ":'<img class=closeIcon id="'+returnData.recipients[x].email+"\" src='img/error.png'>")+"</div></li></ul></li>";$(insert).appendTo("#recipientList")}}else{var insert="<li><h3 class=noDataMessage>No accounting contacts found.<p>&nbsp;</p></h3></li>";$(insert).appendTo("#recipientList"),$("#sendInvoiceButton").remove()}reveal()},function(e){showError(e),console.log("fail @ Invoice details")}),$("#sendInvoiceButton").click(function(){if($(".recipient").children(".plusIcon").length<1)return void userMessage.showMessage(!1,"No accounting contacts added");var emails="";$.each($(".recipient").children(".plusIcon"),function(){emails+=$(this).attr("id")+","});var data,number=localStorage.invoiceNumber,isUnbilled=-1!=number.indexOf(",");isUnbilled?(number=number.split(","),data={status:"unbilled",account:number[0],project:number[1],start_date:start_date,end_date:end_date},number="invoices"):(data={action:"sendEmail"},number="invoices/"+number),data.recipients=emails,getApi(number,data,isUnbilled?"POST":"PUT").then(function(){setTimeout(function(){backFunction()},1e3),userMessage.setMessage(!0,"Hurray! Invoice sent")},function(e){showError(e),console.log("fail @ storage Account List")})})}},invoiceList={init:function(is_unbilled){var accountid=localStorage.DetailedAccount;is_unbilled||$("#invoiceCreate").click(function(){window.location.replace("unInvoice_List.html")}),this.listInvoices(accountid,is_unbilled)},listInvoices:function(accountid,is_unbilled){getApi("invoices",{status:is_unbilled,account:accountid}).then(function(returnData){if($("#invoiceList").empty(),0==returnData.length)return $('<h3 class="noDataMessage">no invoices at this time</h3>').prependTo("#invoiceList"),createSpan("#invoiceList"),void reveal();"undefined"==typeof returnData.length&&(returnData=[returnData]);for(var insert="",i=0;i<returnData.length;i++){var customer=createElipse(returnData[i].customer,.33,12),date=formatDate(returnData[i].date||returnData[i].end_date||(new Date).toJSON()),id=returnData[i].id;is_unbilled&&(id=returnData[i].account_id+","+returnData[i].project_id),insert+="<ul data-id="+id+" class='invoiceRows item'><li class=user_name>"+customer+"</li><li class=responseText>"+date+"</li><li>$"+Number(returnData[i].total_cost).toFixed(2)+"</li></ul>"}$(insert).appendTo("#invoiceList"),createSpan("#invoiceList"),reveal(),filterList("tabpageContainer")},function(e){showError(e),console.log("fail @ invoice List")})}},getQueueTickets={init:function(){$(".title").html("Tickets @ "+localStorage.getItem("currentQueueName")+" Queue"),this.queueTickets(),$("#ticketCreate").click(function(){localStorage.setItem("add_user_techid",localStorage.getItem("currentQueue")),localStorage.setItem("add_user_accountid",account),window.location.replace("add_tickets.html")})},queueTickets:function(){var queueId=localStorage.getItem("currentQueue");queueId||(console.log("fail @ Queues tickets"),window.history.back()),getApi("queues/"+queueId).then(function(returnData){ticketList.createTicketsList(returnData,"#queueTickets"),filterList("queueTickets"),reveal();var retrievedObject,test=localStorage.getItem("storageQueues");test&&(match=new RegExp('"'+queueId+",(\\d+)").exec(test),match&&(test=JSON.parse(test),retrievedObject=test[Number(match[1])],retrievedObject&&(test[Number(match[1])].tickets_count=returnData.length,localStorage.setItem("storageQueues",JSON.stringify(test)))))},function(e){showError(e),console.log("fail @ queue Tickets")})}},getQueues={init:function(parent,limit){cacheName="storageQueues",getQueues.queues(limit,parent)},queues:function(limit,parent){var retrievedObject=localStorage.getItem("storageQueues"),time=cacheTime;retrievedObject&&(retrievedObject=JSON.parse(retrievedObject)),retrievedObject&&0!=retrievedObject.length?(getQueues.createQueuesList(parent,retrievedObject,limit),limit||createSpan(parent)):(console.log("could not load local data"),time=10),setTimeout(function(){getApi("queues",{sort_by:"tickets_count"}).then(function(returnData){getQueues.createQueuesList(parent,returnData,limit),localStorage.setItem("storageQueues",JSON.stringify(returnData)),reveal(),limit||(createSpan(parent),filterList("OptionsList"))},function(e){showError(e),console.log("fail @ Queues List")})},time)},createQueuesList:function(parent,returnData,limit){for(var badge=0,activeQueues=0,textToInsert=[],length=returnData.length,$table=$(parent),i=0;length>i;i+=1)0==returnData[i].fullname.toLowerCase().indexOf("new ticket")&&(badge=returnData[i].tickets_count),returnData[i].index=returnData[i].id+","+i,limit&&returnData[i].tickets_count<1||limit&&activeQueues>=limit||(textToInsert.push("<li class=item><div id='queue' data-id="+returnData[i].id+" class='OptionWrapper'><h3 class='OptionTitle user_name'>"+returnData[i].fullname+"</h3></div><div class='NotificationWrapper'><h2>"+returnData[i].tickets_count+"</h2></div></li>"),length>10&&10==i&&$table.html(textToInsert.join("")),activeQueues+=1);$table.html(textToInsert.join("")),localStorage.badge=badge}},ticketList={init:function(){isTech?(this.userTickets(),this.techTickets(),this.altTickets(),this.allTickets()):(this.userTickets(),$("#userContainer").css("padding-top","20px"),$("#tabpage_reply").fadeIn())},createTicketsList:function(returnData,parent,cachePrefix){var $table=$(parent);if($table.empty(),!returnData||returnData.length<1)$table.html('<h1 class="noTicketMessage">No Tickets</h1>');else{for(var textToInsert=[],length=returnData.length,i=0;length>i;i+=1){var email=$.md5(returnData[i].user_email),initialPost=returnData[i].initial_post,subject=returnData[i].subject;returnData[i].index=returnData[i].key+","+i;var data=returnData[i].key;subject=createElipse(subject,.7,12);var newMessage=returnData[i].is_new_tech_post&&returnData[i].technician_email!=localStorage.userName||returnData[i].is_new_user_post&&returnData[i].user_email!=localStorage.userName?"<i class='fa fa-envelope-o' style='color: #25B0E6;'></i> ":"";initialPost.length>150&&(initialPost=initialPost.substring(0,150)+"..."),initialPost=$("<span />",{html:initialPost.replace(/<br\s*[\/]?>/gi,"\n")}).text(),textToInsert.push("<ul class='responseBlock item' id='thisBlock' data-id="+data+"><li><p class='blockNumber numberStyle'>#"+returnData[i].number+"</p><img src='http://www.gravatar.com/avatar/"+email+"?d=mm&s=80' class='TicketBlockFace'><span class=user_name>"+returnData[i].user_firstname+"</span></li><li class='responseText'><h4>"+newMessage+subject+"</h4><p class ='initailPost'>"+initialPost+"</p></li><li><p class='TicketBlockNumber'>"+returnData[i].class_name+"</p></li></ul>"),length>10&&10==i&&($table.html(textToInsert.join("")),textToInsert=[])}$table.append(textToInsert.join("")),createSpan(parent),cachePrefix&&localStorage.setItem(cachePrefix+"tickets",JSON.stringify(returnData))}},techTickets:function(){var cacheName1="tech",retrievedObject=localStorage.getItem(cacheName1+"tickets"),time=cacheTime;retrievedObject&&(retrievedObject=JSON.parse(retrievedObject)),retrievedObject&&0!=retrievedObject.length?(ticketList.createTicketsList(retrievedObject,"#techContainer"),featureList2=filterList("techContainer","",localStorage.getItem("searchItem"))):(console.log("could not load local data"),time=10),setTimeout(function(){getApi("tickets?status=open&limit=100&role=tech").then(function(returnData){ticketList.createTicketsList(returnData,"#techContainer",cacheName1),featureList2=filterList("techContainer","",localStorage.getItem("searchItem"))},function(e){showError(e),console.log("fail @ tech Container")})},time)},allTickets:function(){var cacheName1="all",retrievedObject=localStorage.getItem(cacheName1+"tickets"),time=cacheTime;retrievedObject&&(retrievedObject=JSON.parse(retrievedObject)),retrievedObject&&0!=retrievedObject.length?(ticketList.createTicketsList(retrievedObject,"#allContainer"),featureList3=filterList("allContainer","",localStorage.getItem("searchItem"))):(console.log("could not load local data"),time=10),setTimeout(function(){getApi("tickets?status=allopen&limit=100&query=all").then(function(returnData){ticketList.createTicketsList(returnData,"#allContainer",cacheName1),featureList3=filterList("allContainer","",localStorage.getItem("searchItem")),localStorage.setItem("searchItem",""),reveal()},function(e){showError(e),console.log("fail @ all ticket List")})},time)},altTickets:function(){var cacheName1="alt",retrievedObject=localStorage.getItem(cacheName1+"tickets"),time=cacheTime;retrievedObject&&(retrievedObject=JSON.parse(retrievedObject)),retrievedObject&&0!=retrievedObject.length?(ticketList.createTicketsList(retrievedObject,"#altContainer"),featureList4=filterList("altContainer","",localStorage.getItem("searchItem"))):(console.log("could not load local data"),time=10),setTimeout(function(){getApi("tickets?status=open&limit=100&role=alt_tech").then(function(returnData){ticketList.createTicketsList(returnData,"#altContainer",cacheName1),featureList4=filterList("altContainer","",localStorage.getItem("searchItem"))},function(e){showError(e),console.log("fail @ all ticket List")})},time)},userTickets:function(){$("maxSize").hide();var cacheName1="user",retrievedObject=localStorage.getItem(cacheName1+"tickets"),time=cacheTime;retrievedObject&&(retrievedObject=JSON.parse(retrievedObject)),retrievedObject&&0!=retrievedObject.length?(ticketList.createTicketsList(retrievedObject,"#userContainer"),featureList5=filterList("userContainer","",localStorage.getItem("searchItem"))):(console.log("could not load local data"),time=10),setTimeout(function(){getApi("tickets?status=open,onhold&limit=100&role=user").then(function(returnData){ticketList.createTicketsList(returnData,"#userContainer",cacheName1),featureList5=filterList("userContainer","",localStorage.getItem("searchItem"))},function(e){showError(e),console.log("fail @ user Container")})},time)}};String.format=function(format){var args=Array.prototype.slice.call(arguments,1);return format.replace(/{(\d+)}/,function(match,number){return"undefined"!=typeof args[number]?args[number]:match})};var accountList={init:function(parent,limit){cacheName="storageAccountList",accountList.listAccounts(parent,limit)},listAccounts:function(parent,limit){var time=cacheTime,retrievedObject=localStorage.getItem("storageAccountList");retrievedObject&&(retrievedObject=JSON.parse(retrievedObject)),retrievedObject&&0!=retrievedObject.length?(limit?(cacheName="dash",accountList.createDashAccountsList(parent,retrievedObject)):accountList.createAccountsList(parent,retrievedObject),reveal()):(console.log("could not load local data"),time=10),setTimeout(function(){getApi("accounts?limit=300").then(function(returnData){limit?accountList.createDashAccountsList(parent,returnData):accountList.createAccountsList(parent,returnData),localStorage.setItem("storageAccountList",JSON.stringify(returnData)),reveal()},function(e){showError(e),console.log("fail @ Account List")})},time)},createAccountsList:function(parent,returnData){if(returnData.length<1){var insert='<h1 class="noTicketMessage">No Accounts</h1>';$(insert).html(parent)}else{for(var textToInsert=[],length=returnData.length,$table=$(parent),i=0;length>i;i+=1){returnData[i].index=returnData[i].id+","+i;var openTks=returnData[i].account_statistics.ticket_counts.open,nameCheck=returnData[i].name;nameCheck=createElipse(nameCheck,.75,12),textToInsert.push("<ul class='listedAccount item' data-id="+returnData[i].id+"><li class=user_name>"+nameCheck+"</li><li><div class='tks' "+(openTks>99?"style='height: 42px;'>99<sup>+</sup>":">"+openTks)+"</div></li></ul>"),length>10&&10==i&&$table.html(textToInsert.join(""))}$table.html(textToInsert.join("")),createSpan(parent),filterList("ActiveAccountsContainer")}},createDashAccountsList:function(parent,returnData){for(var textToInsert=["<ul class='tableHeader'><li></li><li>Hours</li><li>Expenses</li><li>Tkts</li></ul>"],length=returnData.length,$table=$(parent),i=0;length>i;i+=1){returnData[i].index=returnData[i].id+","+i;var openTks=returnData[i].account_statistics.ticket_counts.open;if(!(1>openTks)){var nameCheck=returnData[i].name;nameCheck=createElipse(nameCheck,.3,12);var openHours=returnData[i].account_statistics.hours;openHours>999&&(openHours=999),textToInsert.push("<ul class='tableRows clickme' data-id="+returnData[i].id+"><li>"+nameCheck+"</li><li>"+openHours+"</li><li>"+localStorage.getItem("currency")+Number(returnData[i].account_statistics.expenses).toFixed(2)+"</li><li><div class='tks1 "+(openTks>99?"overflowTickets' style='height: 42px;'>99<sup>+</sup>":"'>"+openTks)+"</div></li></ul>"),length>10&&10==i&&$table.html(textToInsert.join(""))}}$table.html(textToInsert.join(""))}};$(document).on("click",".timelog",function(){localStorage.setItem("timeNumber",$(this).attr("data-info")),window.location="edit_time.html"});var timeLogs={init:function(){this.getLogs()},getLogs:function(){getApi("time",{limit:200}).then(function(returnData){if($("#timelogs").empty(),returnData.length<1){var insert='<h1 class="noTicketMessage">No Timelogs</h1>';$(insert).appendTo("#timelogs")}else for(var i=0;i<returnData.length;i++){var email=$.md5(returnData[i].user_email),text=returnData[i].note,id=returnData[i].time_id,hours=returnData[i].hours;hours=hours.toString();var nameCheck=returnData[i].user_name;text=createElipse(text,.5,8),hours.indexOf(".")>=0||(hours+=".00"),nameCheck=createElipse(nameCheck,.5,12);var log="<li class=item><ul class='timelog' data-id="+id+" data-info='"+JSON.stringify(returnData[i]).replace(/'/g,"")+"'> <li><img class='timelogProfile' src='http://www.gravatar.com/avatar/"+email+"?d=mm&s=80'></li><li><h2 class='feedName user_name'>"+nameCheck+"</h2><p class='taskDescription responseText'>"+text+"</p></li><li><img class='feedClock'src='img/clock_icon_small.png'><h3 class='feedTime'><span>"+hours+"</span></h3></li></ul></li>";$(log).appendTo("#timelogs"),9==i&&reveal()}createSpan("#timelogs"),reveal(),returnData.length>1&&filterList("timelogs")},function(e){showError(e),console.log("fail @ time logs")})}},accountDetailsPageSetup={init:function(){var ticketAccount=localStorage.getItem("DetailedAccount");localStorage.setItem("addAccountTicket",ticketAccount),this.pageSetup()},createAccDetails:function(returnData){var accountHours=returnData.account_statistics.hours,accountTickets=returnData.account_statistics.ticket_counts.open,accountInvoices=returnData.account_statistics.invoices;$("#AD").html(returnData.name),$("#ticketsOptionTicker").html(accountTickets>999?999:accountTickets),$("#invoiceOptionTicker").html(accountInvoices>999?999:accountInvoices),$("#timesOptionTicker").html(accountHours>999?999:accountHours)},pageSetup:function(){var retrievedObject,match,currentDetailedAccount=localStorage.getItem("DetailedAccount"),retrievedObjectTickets=localStorage.getItem("account"+currentDetailedAccount+"tickets"),time=cacheTime,timeTickets=cacheTime,test=localStorage.getItem("storageAccountList");test&&(match=new RegExp('"'+currentDetailedAccount+",(\\d+)").exec(test),match&&(test=JSON.parse(test),retrievedObject=test[Number(match[1])])),retrievedObjectTickets?(retrievedObjectTickets=JSON.parse(retrievedObjectTickets),ticketList.createTicketsList(retrievedObjectTickets,".AccountDetailsTicketsContainer"),filterList("AccountDetailsTicketsContainer")):(timeTickets=10,console.log("could not load local account tickets data")),retrievedObject&&0!=retrievedObject.length?(accountDetailsPageSetup.createAccDetails(retrievedObject),reveal()):(console.log("could not load local account details data"),time=10),setTimeout(function(){getApi("accounts/"+currentDetailedAccount).then(function(returnData){accountDetailsPageSetup.createAccDetails(returnData),retrievedObject&&(test[Number(match[1])].account_statistics=returnData.account_statistics,localStorage.setItem("storageAccountList",JSON.stringify(test)))},function(e){showError(e),console.log("fail @ storage Account List")})},time),setTimeout(function(){getApi("tickets?status=open&account="+currentDetailedAccount).then(function(returnData){ticketList.createTicketsList(returnData,".AccountDetailsTicketsContainer","account"+currentDetailedAccount),filterList("AccountDetailsTicketsContainer")},function(e){showError(e),console.log("fail @ Account")})},timeTickets)}},accountTimeLogs={init:function(){$("#addTimeAccount").click(function(){window.location="add_time.html"}),this.getTimeLogs()},getTimeLogs:function(){var accountId=localStorage.getItem("DetailedAccount")||-1;getApi("time?account="+accountId).then(function(returnData){$("#accountLogs").empty();for(var i=0;i<returnData.length;i++){var email=$.md5(returnData[i].user_email),text=returnData[i].note,hours=returnData[i].hours;hours=hours.toString(),hours.indexOf(".")<0&&(hours+=".00"),text=createElipse(text,.5,8);var nameCheck=returnData[i].user_name;nameCheck=createElipse(nameCheck,.5,12);var log="<li><ul class='timelog' data-info='"+JSON.stringify(returnData[i]).replace(/'/g,"")+"'> <li><img class='timelogProfile' src='http://www.gravatar.com/avatar/"+email+"?d=mm&s=80'></li><li><h2 class='feedName'>"+nameCheck+"</h2><p class='taskDescription'>"+text+"</p></li><li><img class='feedClock'src='img/clock_icon_small.png'><h3 class='feedTime'><span>"+hours+"</span></h3></li></ul></li>";$(log).appendTo("#accountLogs")}},function(e){showError(e),console.log("fail @ accountlogs")})}},TicketsCounts={init:function(){$("html,body").css("scrollTop","0");
var time=10,cachedTickets=localStorage.ticketsStat;cachedTickets&&(cachedTickets=JSON.parse(cachedTickets)),cachedTickets?TicketsCounts.setTicketCounts(cachedTickets):console.log("no cache TicketsCounts"),setTimeout(function(){getApi("tickets/counts").then(function(returnData){TicketsCounts.setTicketCounts(returnData),reveal(),localStorage.setItem("ticketsStat",JSON.stringify(returnData))},function(e){showError(e),console.log("fail @ get TicketsCounts")})},time)},setTicketCounts:function(returnData){var allTickets=returnData.open_all;allTickets>100?allTickets="99<sup>+</sup>":$("#all").removeClass("headerOverflowTickets"),$("#all").html(allTickets),$("#userStat").html(returnData.open_as_user),$("#techStat").html(returnData.open_as_tech),$("#altStat").html(returnData.open_as_alttech)}},getInstanceConfig=function(_userOrgKey,_userInstanceKey,is_redirect,paramFunc){"undefined"==typeof is_redirect&&(is_redirect=!0),_userOrgKey&&_userInstanceKey||(_userOrgKey=localStorage.getItem("userOrgKey"),_userInstanceKey=localStorage.getItem("userInstanceKey")),_userOrgKey&&_userInstanceKey&&getApi("config").then(function(returnData){localStorage.setItem("userRole",returnData.user.is_techoradmin?"tech":"user"),isTech=returnData.user.is_techoradmin,localStorage.setItem("projectTracking",returnData.is_project_tracking),localStorage.setItem("timeTracking",returnData.is_time_tracking),localStorage.setItem("accountManager",returnData.is_account_manager),localStorage.setItem("ticketLevels",returnData.is_ticket_levels),localStorage.setItem("classTracking",returnData.is_class_tracking),localStorage.setItem("locationTracking",returnData.is_location_tracking),localStorage.setItem("freshbooks",returnData.is_freshbooks),localStorage.setItem("is_invoice",returnData.is_invoice),localStorage.setItem("is_expenses",returnData.is_expenses),localStorage.setItem("is_travel_costs",returnData.is_travel_costs),localStorage.setItem("currency",returnData.currency),localStorage.setItem("userFullName",returnData.user.firstname+" "+returnData.user.lastname),localStorage.setItem("userId",returnData.user.user_id),paramFunc&&"function"==typeof paramFunc?paramFunc():getInfo4Extension(),is_redirect&&(window.location=isTech?"dashboard.html":"ticket_list.html")},function(j,t,e){showError(e),console.log("fail @ config")})},org={init:function(){return"org.html"==Page?($(".instSelect").hide(),(userKey=localStorage.getItem("userKey"))?(userOrgKey=localStorage.getItem("userOrgKey"),userInstanceKey=localStorage.getItem("userInstanceKey"),localStorage.setItem("userRole","user"),userOrgKey&&userInstanceKey?void getInstanceConfig(userOrgKey,userInstanceKey):void this.getOrg()):void(window.location="index.html")):void 0},getOrg:function(){$(".page").show(),$("#loading").show(),userKey=localStorage.getItem("userKey"),$.ajax({type:"GET",beforeSend:function(xhr){xhr.withCredentials=!0,xhr.setRequestHeader("Authorization","Basic "+btoa("x:"+userKey))},url:ApiSite+"organizations/",async:!0,cache:!1,dataType:"json",success:function(results){if(results.length>1){localStorage.setItem("sd_is_MultipleOrgInst","true");for(var orglistitem=results,i=0;i<orglistitem.length;i++){var insert="<li class=item><div id='org' data-id="+i+" class='OptionWrapper1'><h3 class='OptionTitle user_name'>"+orglistitem[i].name+"</h3></div></li>";$("#orgsPage").append(insert)}$(document).on("click","#org",function(){var index_number=$(this).attr("data-id");userOrgKey=results[index_number].key,userOrg=results[index_number].name;var instances=results[index_number].instances;if(localStorage.setItem("userOrgKey",userOrgKey),localStorage.setItem("userOrg",userOrg),0==instances.length)return void userMessage.showMessage(!1,"You are not associated with any Instance in the Organization or your account is inactivated in the Instances.");if(1==instances.length)userInstanceKey=instances[0].key,localStorage.setItem("userInstanceKey",userInstanceKey),getInstanceConfig(userOrgKey,userInstanceKey);else{$("#instsPage").empty(),$("div.OptionWrapper1[data-id!='"+index_number+"']").parent().remove();for(var i=0;i<instances.length;i++){var insert="<li class=item><div id='inst' data-id="+i+" class='OptionWrapper2'><h3 class='OptionTitle user_name'>"+instances[i].name+"</h3></div></li>";$("#instsPage").append(insert)}$(".instSelect").show(),$(document).on("click","#inst",function(){var userInstanceKey=instances[$(this).attr("data-id")].key;localStorage.setItem("userInstanceKey",userInstanceKey),localStorage.setItem("sd_is_MultipleOrgInst","true"),$("#loading").show(),getInstanceConfig(userOrgKey,userInstanceKey)})}})}if(1==results.length){userOrgKey=results[0].key,userOrg=results[0].name,localStorage.setItem("userOrgKey",userOrgKey),localStorage.setItem("sd_is_MultipleOrgInst","false"),localStorage.setItem("userOrg",userOrg);var insert="<li class=item><div id='org' data-id=0 class='OptionWrapper1'><h3 class='OptionTitle user_name'>"+results[0].name+"</h3></div></li>";$("#orgsPage").append(insert);var instances=results[0].instances;if(1==instances.length)userInstanceKey=instances[0].key,localStorage.setItem("userInstanceKey",userInstanceKey),getInstanceConfig(userOrgKey,userInstanceKey);else{$("#instsPage").empty();for(var i=0;i<instances.length;i++){var insert="<li class=item><div id='inst' data-id="+i+" class='OptionWrapper2'><h3 class='OptionTitle user_name'>"+instances[i].name+"</h3></div></li>";$("#instsPage").append(insert)}$(".instSelect").show(),$(document).on("click","#inst",function(){var userInstanceKey=instances[$(this).attr("data-id")].key;localStorage.setItem("userInstanceKey",userInstanceKey),localStorage.setItem("sd_is_MultipleOrgInst","true"),$("#loading").show(),getInstanceConfig(userOrgKey,userInstanceKey)})}}},complete:function(){userOrgKey=localStorage.getItem("userOrgKey"),userInstanceKey=localStorage.getItem("userInstanceKey"),userOrgKey&&userInstanceKey||reveal()},error:function(){console.log("fail @ getOrg"),logout()}})}},miscClicks={init:function(){this.justClicked()},justClicked:function(){$createButton=$("#ticketCreate"),$createButton&&$createButton.click(function(){window.location.replace("add_tickets.html")}),$("#invoiceOption").click(function(){window.location="Invoice_List.html"}),$("#allInvoice").click(function(){window.location="allInvoice_List.html"}),$(document).on("click",".invoiceRows",function(){localStorage.setItem("invoiceNumber",$(this).attr("data-id")),window.location="invoice.html"}),$(document).on("click",".tableRows, .listedAccount",function(){localStorage.setItem("DetailedAccount",$(this).attr("data-id")),window.location="account_details.html"}),$(document).on("click",".responseBlock",function(){localStorage.setItem("ticketNumber",$(this).attr("data-id")),window.location="ticket_detail.html"}),$(document).on("click","#queue",function(){localStorage.setItem("currentQueue",$(this).attr("data-id")),localStorage.setItem("currentQueueName",$(this).find(".OptionTitle").text()),window.location="queueTickets.html"}),$(document).on("click","#asUserStat",function(){localStorage.setItem("ticketPage","asUser"),window.location="ticket_list.html"}),$(document).on("click","#techStat",function(){localStorage.setItem("ticketPage","asTech"),window.location="ticket_list.html"}),$(document).on("click","#asAltTechStat",function(){localStorage.setItem("ticketPage","asAltTech"),window.location="ticket_list.html"}),$(document).on("click","#allTicketsStat",function(){localStorage.setItem("ticketPage","allTickets"),window.location="ticket_list.html"})},menuFunctions:function(){var techTicketStats=localStorage.getItem("techStat");null==techTicketStats?$(".menuTicketsStat").hide():(techTicketStats>100&&(techTicketStats=99),$(".menuTicketStatNumber").html(techTicketStats))}},userMessage={init:function(){this.showMessage()},setMessage:function(isPos,messageText){localStorage.setItem("userMessage",messageText),localStorage.setItem("isMessage",isPos?"truePos":"trueNeg")},showMessage:function(isPos,messageText,func){if("undefined"==typeof isPos){var isMessage=localStorage.getItem("isMessage");if("truePos"==isMessage)isPos=!0,localStorage.setItem("isMessage","false");else{if("trueNeg"!=isMessage)return;isPos=!1,localStorage.setItem("isMessage","false")}}messageText||(messageText=localStorage.getItem("userMessage"));var messageEl=isPos?".errorMessagePos":".errorMessageNeg";$(messageEl).html(messageText),$(messageEl).slideDown(100),setTimeout(function(){$(messageEl).slideUp(100),"function"==typeof func&&func()},3500)}};!function(){if(userMessage.init(),UserLogin.init(),org.init(),OrgSignup.init(),switchOrg.init(),"index.html"!=Page&&""!=Page&&"org.html"!=Page){var updateStatusBar=navigator.userAgent.match(/iphone|ipad|ipod/i)&&parseInt(navigator.appVersion.match(/OS (\d)/)[1],10)>=7;if(updateStatusBar){var t=document.getElementsByTagName("header")[0];t&&(t.style.paddingTop="10px",t.style.height="63px",$("body").css("margin-top",function(index,curValue){return parseInt(curValue,10)+10+"px"})),t=document.getElementById("ptr"),t&&(t.style.marginTop="10px")}if(signout.init(),miscClicks.init(),localStorage.lastclick){if(((new Date).valueOf()-Date.parse(localStorage.lastclick).valueOf())/60>1200)return localStorage.lastclick=new Date,void getInstanceConfig("","",!1,routing)}else localStorage.lastclick=new Date;routing()}}()});