function updatedFunction(){location.reload(!0)}function checkEmail(e){return null!==e.trim().match(/^[^@\s]+@[^@\s]+(\.[^@\s]+)+$/i)}function checkURL(e){return null!==e.trim().match(/\.(jpeg|jpg|gif|png)$/i)}function onDeviceReady(){isPhonegap=!0,cordova.plugins.notification.badge&&(localStorage.badge>0?cordova.plugins.notification.badge.set(localStorage.badge):cordova.plugins.notification.badge.clear())}function openURL(e){window.open(e,"_blank","location=no,EnableViewPortScale=yes")}function openURLsystem(e){window.open(e,"_system")}function getPage(){var e=location.href.match(/(.+\w\/)(.+)/);return e?e:["","",""]}function reveal(){$("#loading").fadeOut()}function errorLine(e){var t="location.reload(false)";$("#scroller").hide(),$(".catch-error").length||$("body").prepend('<div class="catch-error"><div class="catch-error-description"><h2>&nbsp;</h2><h2>&nbsp;</h2><h2>Something went wrong...</h2><div id="ctl00_PageBody_StackTrace" class="return-button"><p /><p /><h4>'+e+'</h4><h4>&nbsp;<p>P.S.  Uh... a Yeti just attacked your  camp!</h4><center><button class=loginButton style="width: 200px;" onclick="'+t+'">Refresh</button></center></div></div>')}function offLine(){var e="redirectToPage()";isOnline=!1,$(".catch-error").length||$("body").prepend('<div class="catch-error"><div class="catch-error-description"><h2>&nbsp;</h2><h2>&nbsp;</h2><h2>Check your internet connection!</h2><div id="ctl00_PageBody_StackTrace" class="return-button"><p /><p /><h4>P.S.  Uh... a Yeti just attacked your  camp!</h4><center><button class=loginButton style="width: 200px;" onclick="'+e+'">Refresh</button></center></div></div>')}function onLine(){isOnline||($(".catch-error").remove(),location.reload(!1)),isOnline=!0}function redirectToPage(){if(navigator.onLine)if(isPhonegap)onLine();else{var e=document.body.appendChild(document.createElement("img"));e.style.display="none",e.onload=function(){onLine()},e.onerror=function(){offLine()},e.src=MobileSite+"img/select_arrow.png?rand="+Math.random()}else offLine()}function logout(e,t){"undefined"==typeof e&&(e=!0),clearStorage(),localStorage.is_google?(localStorage.removeItem("userName"),localStorage.removeItem("is_google"),GooglelogOut()):e&&(window.location="index.html"+("undefined"==typeof t?"":"?f="+t))}function GooglelogOut(e){if(window.self!==window.top||confirm("Do you want to stay logged in Google account?"))window.location="index.html"+("undefined"==typeof isRedirect?"":"?f="+e);else{document.location.href=getPage()[1]+"index.html"+("undefined"==typeof e?"":"?f="+e)}}function clearStorage(){var e=localStorage.userName,t=localStorage.appVersion;localStorage.clear(),localStorage.removeItem("userOrgKey"),localStorage.removeItem("userOrg"),localStorage.removeItem("userInstanceKey"),localStorage.removeItem("userKey"),localStorage.setItem("userName",e),localStorage.appVersion=t,window.self!==window.top&&window.top.postMessage("logout","*")}function getInfo4Extension(){if(window.self!==window.top){var e="login?t="+localStorage.getItem("userKey")+"&o="+localStorage.getItem("userOrgKey")+"&i="+localStorage.getItem("userInstanceKey");window.top.postMessage(e,"*")}}function fullapplink(){var e=AppSite+"?dept="+localStorage.getItem("userInstanceKey")+"&org="+localStorage.getItem("userOrgKey");return isPhonegap?$(".fullapplink").on("click",function(t){t.preventDefault(),openURLsystem(e)}):window.self!==window.top?$(".fullapplink").on("click",function(t){t.preventDefault();var i=window.__proto__.open;i.apply(window,[e,"_blank"])}):($(".fullapplink").attr("target","_blank"),$(".fullapplink").attr("href",e)),e}function htmlEscape(e){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function filterList(e,t,i){$("body").attr("id","search_wrap"),"undefined"!=typeof t&&t?t&&(t=t.split(",")):t=["blockNumber","responseText","TicketBlockNumber","user_name"];var a={listClass:e,item:"item",valueNames:t};return featureList=new List("search_wrap",a),"undefined"!=typeof i&&i&&(featureList.search(i),$(".search").val(i)),featureList.on("updated",function(){if(featureList.matchingItems.length>1){"There are "+featureList.matchingItems.length+" matching tickets."}else 0===featureList.matchingItems.length&&console.log("Bummer...  0 items found")}),featureList}function float2int(e){return 0|e}function createElipse(e,t,i){var a=e.length;if(10>=a)return e;var o=$(window).width();o>650&&(o=650);var n;return t*=o,n=t/i,n=float2int(n),a-2>n&&(e=e.substring(0,n)+"..."),e}function createSpan(e){var t=$(window).height(),i=$("#content").height();t>i+60&&(i=t-i-60,$("<p id=fill style='height:"+i+"px'>&nbsp;</p>").appendTo(e+""))}var appVersion="21",adMessage="Invite new user feature",Site="sherpadesk.com/",MobileSite="http://m."+Site,AppSite="https://app."+Site,ApiSite="http://api."+Site,isTech=!1,isProject=!0,isTime=!0,isAccount=!0,isLevel=!0,isClass=!0,isLocation=!0,isFreshbook=!0,isExpenses=!0,isTravelCosts=!0,isInvoice=!0,is_MultipleOrgInst=!0,cacheName="",cacheTime=5e3,isPhonegap=!1,isOnline=!0;document.addEventListener("deviceready",onDeviceReady,!1),document.addEventListener("offline",offLine,!1),document.addEventListener("online",onLine,!1),"function"!=typeof String.prototype.addUrlParam&&(String.prototype.addUrlParam=function(e,t){if(!t||!e)return this;var i=this.indexOf("?")>0?"&":"?";return this+i+e+"="+t}),$(document).ajaxError(function(e,t,i){(403==t.status&&i.url!==ApiSite+"organizations"||404==t.status&&i.url===ApiSite+"config")&&logout(i.url!==ApiSite+"login",t.statusText),setTimeout(function(){$("#loading").hide(),$(".page").show(),redirectToPage()},1e3)}),window.onerror=function(e,t,i,a,o){var n=a?"<p>column: "+a:"";n+=o?"<p>error: "+o:"",i>0&&setTimeout(function(){errorLine("<p onclick='$(\".err\").toggle();'>Click for Error Details:</p><div class=err style='display:none;'>"+e+"<p>page: "+location.href+"<p>url: "+t+"<p>line: "+i+n+"</div>"),$("#loading").hide(),$(".page").show()},1e3);var s=!0;return s},window.onload=function(){"object"==typeof WebPullToRefresh&&WebPullToRefresh.init({loadingFunction:function(){"dash"===cacheName?(localStorage.setItem("storageQueues",""),localStorage.setItem("storageAccountList",""),localStorage.setItem("ticketsStat","")):localStorage.setItem(cacheName,""),location.reload(!1)}})},"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(e){return-1!==this.indexOf(e,this.length-e.length)});var featureList,featureList2,featureList3,featureList4,featureList5;$(document).ready(function(){function e(e,t,i){var a=localStorage.getItem("userKey"),o=localStorage.getItem("userOrgKey"),n=localStorage.getItem("userInstanceKey");return a&&o&&n?(i||(i="GET"),$.ajax({type:i,beforeSend:function(e){e.withCredentials=!0,e.setRequestHeader("Authorization","Basic "+btoa(o+"-"+n+":"+a))},url:ApiSite+e,cache:!0,data:t,dataType:"json"}).promise()):void console.log("Invalid organization!")}function t(e){var t=RegExp("[?&]"+e+"=([^&]*)").exec(window.location.search);return t&&decodeURIComponent(t[1].replace(/\+/g," "))}function i(){var e=location.protocol+"//"+location.host+location.pathname;window.history.replaceState({},document.title,e)}function a(e,t,i,a,o,n,s){if("undefined"==typeof e||!e||!e.length)return $(""+t).parent().hide(),0;var c,l=!1;"undefined"!=typeof o&&o.length>0&&(c=o.split(","),c.length>0&&(l=!0)),"undefined"==typeof a&&(a=""),"undefined"==typeof i&&(i=""),"undefined"==typeof n&&(n=""),"undefined"==typeof s&&(s="");var r=""+i,u=0;for(u=0;u<e.length;u++){var d=e[u].id,m="";if(l)for(var g=0;g<c.length;g++)m+=" "+e[u][c[g]];else m=e[u].name;r+="<option value="+d+">"+a+m+"</option>"}return u>0?($(""+n+r+s).appendTo(""+t),$(""+t).parent().show(),$(""+t).parent().parent().show()):$(""+t).parent().hide(),u}function o(e,t,i){return isClass?(a(e,t,i,"Class: "),void $(""+t).on("change",function(){$(".sub_class1, .sub_class2").is(":visible")&&($(".sub_class1, .sub_class2").hide(),$("#sub_class1, #sub_class2").empty());var i=$(t+" option:selected").val(),o=$.grep(e,function(e){return e.id==i});c=i,"undefined"!=typeof o[0]&&(null!==o[0].sub||o[0].sub>0)&&(a(o[0].sub,"#sub_class1","<option value="+c+">choose a sub class</option>","Sub class: "),$("select#sub_class1").on("change",function(){$(".sub_class2").is(":visible")&&($(".sub_class2").hide(),$("#sub_class2").empty());var e=$("select#sub_class1 option:selected").val(),t=$.grep(o[0].sub,function(t){return t.id==e});c=e,"undefined"!=typeof t[0]&&(t[0].sub>0||null!==t[0].sub)&&(a(t[0].sub,"#sub_class2","<option value="+c+">Sub Sub Class: ---</option>","Sub Sub Class: "),$("select#sub_class2").on("change",function(){var e=$("select#sub_class2 option:selected").val();c=e}))}))})):void $(""+t).parent().parent().hide()}function n(){if("tech"===localStorage.getItem("userRole")&&(isTech=!0),"false"===localStorage.getItem("projectTracking")&&(isProject=!1),"false"===localStorage.getItem("timeTracking")&&(isTime=!1),"false"===localStorage.getItem("accountManager")&&(isAccount=!1),"false"===localStorage.getItem("ticketLevels")&&(isLevel=!1),"false"===localStorage.getItem("classTracking")&&(isClass=!1),"false"===localStorage.getItem("locationTracking")&&(isLocation=!1),"false"===localStorage.getItem("freshbooks")&&(isFreshbook=!1),"false"===localStorage.getItem("is_invoice")&&(isInvoice=!1),"false"===localStorage.getItem("is_expenses")&&(isExpenses=!1),"false"===localStorage.getItem("is_travel_costs")&&(isTravelCosts=!1),"false"===localStorage.getItem("sd_is_MultipleOrgInst")?(is_MultipleOrgInst=!1,$("#switchOrg").hide()):$("#switchOrg").show(),isTime||$(".time").remove(),localStorage.appVersion!==appVersion&&(localStorage.setItem("appVersion",appVersion),console.log("Version updated to "+appVersion),adMessage.length>1?setTimeout(function(){J.showMessage(!0,adMessage,updatedFunction)},3e3):location.reload(!0)),fullapplink(),"undefined"!=typeof navigator.splashscreen&&navigator.splashscreen.hide(),isTech){if(isAccount||$("#itemAccount").parent().hide(),isInvoice||($("#itemInvoice").hide(),$("#invoiceFooter").hide(),$("#invoiceFooter").next().hide()),location.pathname.endsWith("dashboard.html")){if(isTech){localStorage.DetailedAccount="";var e=localStorage.getItem("userOrg");e&&$("#indexTitle").html(e),K.init(),M.init("#DashBoradQueues",3),isAccount&&D.init("#activeList",1),b.init()}else window.location="ticket_list.html";return}if(location.pathname.endsWith("account_details.html"))return void(isAccount?(isInvoice||$("#invoiceOption").parent().remove(),B.init(),h.pageChange()):window.location="dashboard.html");if(location.pathname.endsWith("Account_List.html"))return void(isAccount?(localStorage.DetailedAccount="",D.init("#fullList")):window.location="dashboard.html");if(location.pathname.endsWith("timelog.html"))return void(isTime?E.init():window.location="dashboard.html");if(location.pathname.endsWith("accountTimes.html"))return void(isTime&&isAccount?U.init():window.location="dashboard.html");if(location.pathname.endsWith("allInvoice_List.html"))return void(isTime&&isInvoice?N.init():window.location="dashboard.html");if(location.pathname.endsWith("Invoice_List.html"))return void(isTime&&isInvoice?N.init(localStorage.getItem("DetailedAccount")):window.location="dashboard.html");if(location.pathname.endsWith("invoice.html"))return void(isTime&&isInvoice?(A.init(),S.init(),v.init()):window.location="dashboard.html");if(location.pathname.endsWith("Queues.html"))return void M.init("#queuesPage");if(location.pathname.endsWith("queueTickets.html"))return void C.init()}else $(".sideNavLinks").children(":not('.user')").hide();return location.pathname.endsWith("ticket_list.html")?void j.init():location.pathname.endsWith("ticket_detail.html")?(P.init(),p.init(),f.init(),k.init(),void y.init()):location.pathname.endsWith("closedTickets.html")?void h.init():($("#loading").show(),location.pathname.endsWith("addTicketTime.html")?void(isTime?O.init():window.location="dashboard.html"):location.pathname.endsWith("add_tickets.html")?void I.init():location.pathname.endsWith("add_time.html")?void(isTime?O.init():window.location="dashboard.html"):location.pathname.endsWith("add_user.html")?void(isTech?x.init():window.location="dashboard.html"):location.pathname.endsWith("addExpence.html")?void(isExpenses?L.init():window.location="dashboard.html"):location.pathname.endsWith("edit_time.html")?void(isTime?O.init(!0):window.location="dashboard.html"):void 0)}var s=new Image;s.src=MobileSite+"img/error-background.png";var c,l="",r="",u="",d="",m={init:function(){var e=!0;if(location.pathname.indexOf("index.html")<0&&"/"!=location.pathname&&(e=!1),d=localStorage.getItem("userKey"),l=localStorage.getItem("userOrgKey"),u=localStorage.getItem("userInstanceKey"),(!d||!l||!u)&&!e&&location.pathname.indexOf("org.html")<0&&location.pathname.indexOf("signup.html")<0)return void logout();if(e){if(d&&l&&u)return void F(l,u);if(d)return void(window.location="org.html");var a=t("t"),o=t("e");if(a)return i(),localStorage.setItem("is_google",!0),localStorage.setItem("userKey",a),localStorage.setItem("userName",o),void(window.location="org.html");var n=t("f");n&&(i(),J.showMessage(!1,n)),this.login()}},do_login:function(){var e=$("#userName").val(),t=$("#password").val();return""===e||""===t?void J.showMessage(!1,"Please enter a valid Email or Password"):void $.ajax({type:"POST",beforeSend:function(i){i.withCredentials=!0,i.setRequestHeader("Authorization","Basic "+btoa(e+":"+t))},url:ApiSite+"login",dataType:"json",success:function(t){localStorage.setItem("userKey",t.api_token),localStorage.setItem("userName",e),window.location="org.html"},complete:function(){},error:function(){e&&-1!=e.indexOf("@gmail.com")?J.showMessage(!1,"Wrong Password, Google sign password is not neeeded"):(J.showMessage(!1,"There was a problem with your login.  Please try again."),$("#password").val(""))}})},login:function(){$(".page").show(),d=localStorage.getItem("userKey");var e=localStorage.getItem("userName");null!==e&&e.length>0&&$("#userName").val(e),$("#login_signup").on("click",function(e){e.preventDefault(),document.location.href="signup.html"}),$("form.google_openid").get(0).setAttribute("action",ApiSite+"auth/auth0"),$("#sign_in_with_google").on("click",function(e){e.preventDefault(),window.self!==window.top,$("form.google_openid").get(0).submit()}),$("#loginButton").click(function(){m.do_login()}),$(document).on("keypress","#password, #userName",function(e){13==e.which&&m.do_login()}),reveal()}},g={init:function(){if(!(location.pathname.indexOf("signup.html")<0)){var e=localStorage.getItem("userName");null!==e&&e.length>0&&$("#email").val(e),$("#signupButton").click(function(){g.add()}),$(document).on("change","#name",function(e){var t=$("#name").val();t&&$("#url").val(t.replace(/[^a-zA-Z 0-9]+|[\s]+/g,"").toLowerCase())}),$("#is_force_registration").prop("checked",!1),reveal()}},add:function(){var e=$("#name").val(),t=$("#email").val(),i=$("#url").val(),a=$("#firstname").val(),o=$("#lastname").val(),n=$("#password").val(),s=$("#password_confirm").val(),c=$("#how").val();return""===e||""===t||""===i||""===a||""===o||""===n||""===s?void J.showMessage(!1,"Please enter all fields!"):n!=s?void J.showMessage(!1,"Passwords do not match!"):void $.ajax({type:"POST",url:ApiSite+"organizations",dataType:"json",data:{name:e,email:t,url:i,is_force_registration:$("#is_force_registration").is(":checked"),firstname:a,lastname:o,password:n,password_confirm:s,how_did_you_hear_about_us:c,note:isPhonegap?"registered by iPhone":"registered from mobile site"},success:function(e){return e.api_token?e.organization&&e.instance?(localStorage.setItem("userKey",e.api_token),localStorage.setItem("userName",t),localStorage.setItem("userOrgKey",e.organization),localStorage.setItem("userInstanceKey",e.instance),localStorage.setItem("userRole","user"),void F(e.organization,e.instance)):void(window.location="org.html"):void(window.location="index.html")},error:function(e){return 409==e.status?(J.showMessage(!1,"This email is already in use. Please choose action below"),localStorage.setItem("userName",$("#email").val()),$("#is_force_registration").prop("checked",!0),$("#signupButton").before("<center><h3 style='padding-top: 10px;'>This email is already in use. Would you like to</h3> <div class=loginButton onclick='window.location = \"index.html\"'>Login</div><h3>or</h3></center>"),void $("#signupButton").text("Create New Organization")):void J.showMessage(!1,e.statusText)}})}},h={init:function(){this.showClosedTickets(),this.pageChange()},pageChange:function(){$(".buttonShowClosedTickets").click(function(){window.location="closedTickets.html"})},showClosedTickets:function(){"truePos"==localStorage.getItem("isMessage")&&J.showMessage(!0);var t="closed",i=localStorage.getItem(t+"tickets"),a=cacheTime;i&&(i=JSON.parse(i)),void 0==i||null==i||0==i.length?(console.log("could not load local data"),a=10):(j.createTicketsList(i,"#closedTickets"),filterList("closedTickets")),setTimeout(function(){e("tickets?status=closed&account="+localStorage.getItem("DetailedAccount")).then(function(e){j.createTicketsList(e,"#closedTickets",t),filterList("closedTickets")},function(){console.log("fail @ closed accounts tickets")})},a)}},p={init:function(){this.pick()},pick:function(){$("#pickUp").click(function(){e("tickets/"+localStorage.getItem("ticketNumber"),{action:"pickup",note_text:""},"PUT").then(function(e){J.showMessage(!0,'Ticket pickup was Succesfull <i class="fa fa-thumbs-o-up"></i>'),window.location="ticket_detail.html"},function(e,t,i){alert(t)}),e("tickets/"+localStorage.getItem("ticketNumber"),{action:"pickup",note_text:""},"PUT").then(function(e){J.showMessage(!0,'Ticket pickup was Succesfull <i class="fa fa-thumbs-o-up"></i>'),window.location="ticket_detail.html"},function(e,t,i){alert(t)})})}},f={init:function(){this.transfer()},transfer:function(){$("#transfer").click(function(){$("#loading").removeAttr("style"),$("#loading").show(),$("#transfer").hide(),$("#transferSelect").show(),e("technicians?limit=200").then(function(e){var t="<option value=0 disabled selected> Choose Tech</option>";$(t).appendTo("#transferTechs");for(var i=0;i<e.length;i++){var a=e[i].id,o=e[i].firstname+" "+e[i].lastname;t="<option value="+a+">"+o+"</option>",$(t).appendTo("#transferTechs")}reveal()},function(){console.log("fail @ time accounts")}),$("#transferTechs").on("change",function(){var t=$("#transferTechs").val();e("tickets/"+localStorage.getItem("ticketNumber"),{action:"transfer",note_text:" ",tech_id:t,keep_attached:!1},"PUT").then(function(e){location.reload(!1)},function(e,t,i){alert(t)})})})}},v={init:function(){this.addEm()},addEm:function(){$(document).on("keypress","#addEm",function(e){if(13==e.which){var t=$(".headerSearch").val().toLowerCase();localStorage.setItem("searchItem",t);{$("headerSearch").val()}}})}},k={init:function(){this.closeIt(),this.reopenIt()},reopenIt:function(){$("#openIt").click(function(){e("tickets/"+localStorage.getItem("ticketNumber"),{status:"open",note_text:""},"PUT").then(function(e){setTimeout(function(){J.showMessage(!0,'Ticket has been Reopened <i class="fa fa-thumbs-o-up"></i>'),window.history.back()},1e3)},function(e,t,i){alert(t)})})},close:function(t){return t=htmlEscape(t).trim(),t.length<2?void J.showMessage(!1,"Note cannot be empty!"):t.length>5e3?void J.showMessage(!1,"Note cannot be more than 5000 chars!"):void e("tickets/"+localStorage.getItem("ticketNumber"),{status:"closed",note_text:t,is_send_notifications:!0,resolved:!0,dataType:"json",confirmed:!1,confirm_note:""},"PUT").then(function(e){setTimeout(function(){J.showMessage(!0,'Ticket has been closed <i class="fa fa-thumbs-o-up"></i>'),window.history.back()},1e3),J.setMessage(!0,"Ticket was Closed <i class='fa fa-thumbs-o-up'></i>")},function(e,t,i){})},closeIt:function(){$("#closeIt").click(function(){$("#closingMessage").slideDown(400,function(){$("#closeMessageButton").fadeIn(),$("html,body").animate({scrollTop:$("#closeMessageButton").offset().top},400)})}),$("#closeMessageButton").click(function(){k.close($("#closingMessage").val())}),$("#closeu").click(function(){k.close($("#commentText").val())})}},_=function(e){var t=e.substring(5,7),i=e.substring(8,10);switch(t){case"01":t="Jan";break;case"02":t="Feb";break;case"03":t="Mar";break;case"04":t="Apr";break;case"05":t="May";break;case"06":t="Jun";break;case"07":t="Jul";break;case"08":t="Aug";break;case"09":t="Sep";break;case"10":t="Oct";break;case"11":t="Nov";break;case"12":t="Dec";break;default:t="nul"}return t+" "+i},S={init:function(){this.submitInvoice()},submitInvoice:function(){$("#sendInvoiceButton").click(function(){if($(".recipient").children(".closeIcon").length<1)return void J.showMessage(!1,"No accounting contacts added");var e="";$.each($(".recipient").children(".closeIcon"),function(){e+=$(this).attr("id")+","}),getAp("invoices/"+localStorage.getItem("invoiceNumber"),{action:"sendEmail",recipients:e},"PUT").then(function(e){setTimeout(function(){window.history.back()},1e3),J.setMessage(!0,"Hurray! Invoice sent")},function(e,t,i){})})}},T={init:function(){this.logOut()},logOut:function(){$("#signOut").click(logout)}},w={init:function(){this.changeOrg()},changeOrg:function(){is_MultipleOrgInst&&$("#switchOrg").click(function(){var e=localStorage.appVersion,t=localStorage.userKey,i=localStorage.userName;localStorage.clear(),localStorage.userName=i,localStorage.userKey=t,localStorage.appVersion=e,window.location="org.html"})}},I={init:function(){backFunction=function(){I.back()};var e=t("page");e&&(localStorage.setItem("add_tickets.html_ref",t("page")),i()),$("#userCreate").on("click",function(){var e=$("#addTicketUser").val();e&&localStorage.setItem("add_user_userid",e);var t=$("#addTicketTechs").val();t&&localStorage.setItem("add_user_techid",t);var i=$("#addTicketAccounts").val();i&&localStorage.setItem("add_user_accountid",i),window.location="add_user.html".addUrlParam("page","add_tickets.html")}),$("#TechCreate").on("click",function(){localStorage.setItem("add_user_type","tech");var e=$("#addTicketUser").val();e&&localStorage.setItem("add_user_userid",e);var t=$("#addTicketTechs").val();t&&localStorage.setItem("add_user_techid",t);var i=$("#addTicketAccounts").val();i&&localStorage.setItem("add_user_accountid",i),window.location="add_user.html".addUrlParam("page","add_tickets.html")}),this.addTicket()},back:function(){var e=localStorage.getItem("add_tickets.html_ref");localStorage.setItem("add_tickets.html_ref",""),e||(e=isTech?"dashboard.html":"ticket_list.html"),localStorage.setItem("addAccountTicket",""),window.location.replace(e)},addTicket:function(){$("#addTicketAccounts").empty();var t=localStorage.getItem("addAccountTicket");if(isTech)if(isAccount){var i=e("accounts?limit=300",{is_with_statistics:!1});i.then(function(e){$("#addTicketAccounts").empty(),a(e,"#addTicketAccounts","<option value=0 disabled selected>choose an account</option>");var i=localStorage.getItem("add_user_accountid");t=t?t:i,t&&(localStorage.setItem("add_user_accountid",""),$("#addTicketAccounts").val(t))},function(){console.log("fail @ ticket accounts")})}else $("#addTicketAccounts").parent().hide(),reveal();else $("#addTicketAccounts").parent().hide();if(isTech){var n=e("users?limit=2000");n.then(function(e){a(e,"#addTicketUser","<option value=0 disabled selected>choose end user</option>","","firstname,lastname");var t=localStorage.getItem("add_user_userid");t?localStorage.setItem("add_user_userid",""):t=localStorage.getItem("userId"),$("#addTicketUser").val(t),reveal()},function(){console.log("fail @ ticket user")})}else $("#addTicketUser").parent().hide(),$("#userCreate").hide(),reveal();if(isTech){var s=e("technicians?limit=200");s.then(function(e){a(e,"#addTicketTechs","<option value=0 disabled selected>choose a tech</option>","","firstname,lastname");var t=localStorage.getItem("add_user_techid");t&&(localStorage.setItem("add_user_techid",""),$("#addTicketTechs").val(t))},function(){console.log("fail @ ticket tech")})}else $("#addTicketTechs").parent().hide(),reveal(),$("#TechCreate").hide();var l=e("classes");l.done(function(e){o(e,"#classTicketOptions","<option value=0 disabled selected>choose a class</option>")}),$("#submitNewTicket").click(function(){var t=htmlEscape($("#addTicketSubject").val().trim()),i=htmlEscape($("#addTicketInitPost").val().trim());if(""===t||""===$("#addTicketTechs").val()||1>c)J.showMessage(!1,"Please enter subject");else if(t.length>100)J.showMessage(!1,"Subject should be less 100 chars!");else if(i.length>5e3)J.showMessage(!1,"Details cannot be more than 5000 chars!");else{var a=e("tickets",{status:"open",subject:t,initial_post:i,class_id:c,account_id:$("#addTicketAccounts").val(),user_id:isTech?$("#addTicketUser").val():localStorage.getItem("userId"),tech_id:$("#addTicketTechs").val()},"POST");a.then(function(e){setTimeout(I.back,1e3),J.setMessage(!0,"Ticket was Succesfully Created :)")},function(e,t,i){alert(t)})}})}},y={init:function(){this.sendComment()},sendComment:function(){$("#reply").click(function(){var t=htmlEscape($("#commentText").val().trim());return t?t.length>5e3?void J.showMessage(!1,"Note cannot be more than 5000 chars!"):void e("tickets/"+localStorage.getItem("ticketNumber"),{note_text:t,action:"response"},"POST").then(function(e){location.reload(!1)},function(e,t,i){alert(t)}):void J.showMessage(!1,"Please enter note")})}},b={init:function(){this.universalSearch()},universalSearch:function(){$(document).on("keypress","#searchThis",function(e){if(13==e.which){var t=$(".headerSearch").val().toLowerCase();return localStorage.setItem("searchItem",t),localStorage.setItem("ticketPage","asTech"),void(window.location="ticket_list.html")}})}},L={init:function(e){this.addExpence(t("ticket"))},addExpence:function(t){var i=localStorage.DetailedAccount,a=0;if(!isProject||t)$("#timeProjects").parent().hide();else{var o="<option value=0>choose a project</option>";$(o).appendTo("#timeProjects")}!isAccount||t?($("#timeAccounts").parent().hide(),reveal()):e("accounts?limit=300",{is_with_statistics:!1}).then(function(e){$("#timeAccounts").empty();var t="<option value=0>choose an account</option>";$(t).appendTo("#timeAccounts");for(var o=0;o<e.length;o++){var n=e[o].id,s=e[o].name,c="<option value="+n+">"+s+"</option>";$(c).appendTo("#timeAccounts")}i&&($("#timeAccounts").val(i),O.chooseProjects(a,0)),reveal()},function(){console.log("fail @ time accounts")}),$("#timeAccounts").on("change",function(){O.chooseProjects(0,0)}),$("#addexpenseButton").click(function(){var i=$("#expenseAmount").val();if(!i)return void J.showMessage(!1,"Please enter amount");var a=htmlEscape($("#expenseNote").val()).trim();return a.length<1?void J.showMessage(!1,"Please enter note"):void e("expenses",{ticket_key:t?t:null,account_id:t?null:$("#timeAccounts").val(),project_id:t?null:$("#timeProjects").val(),tech_id:localStorage.getItem("user_id"),note:a,note_internal:$("#expenseInternal").val(),amount:i,is_billable:$(".innerCircle").hasClass("billFill"),vendor:$("#vendor").val()},"POST").then(function(e){localStorage.setItem("isMessage","truePos"),localStorage.setItem("userMessage",'Expense was successfully added <i class="fa fa-money"></i>'),window.history.back()},function(e,t,i){console.log(t)})})}},x={back:function(){localStorage.setItem("add_user_type","");var e=localStorage.getItem("add_user.html_ref");localStorage.setItem("add_user.html_ref",""),e?window.location.replace(e):history.back()},init:function(){backFunction=function(){x.back()};var a=t("page");a&&(localStorage.setItem("add_user.html_ref",t("page")),i()),$(".innerCircle").click(function(){$(".innerCircle").hasClass("billFill")?($("#addTicketPassword").hide(),$("#addTicketConfirmPassword").hide()):($("#addTicketPassword").show(),$("#addTicketConfirmPassword").show())});var o=localStorage.getItem("add_user_type");"tech"==o?($(".SherpaDesk").text("Add New Tech"),$(".greenButton").text("Add New Tech"),o="Tech"):o="User",$("#submitNewUser").click(function(){var t=$("#addTicketEmail").val().trim();if(t.length<1)return void J.showMessage(!1,"Please enter email");if(!checkEmail(t))return void J.showMessage(!1,"Please correct email");var i=$("#addTicketFirstname").val().trim();return i.length<1?void J.showMessage(!1,"Please enter Firstname"):(Lastname=$("#addTicketLastname").val().trim(),Lastname.length<1?void J.showMessage(!1,"Please enter Lastname"):void e("users",{Lastname:Lastname,Firstname:i,email:t,role:o},"POST").then(function(e){J.showMessage(!0,o+' was created <i class="fa fa-thumbs-o-up"></i>',function(){localStorage.setItem("Tech"==o?"add_user_techid":"add_user_userid",e.id),x.back()})},function(e){J.showMessage(!1,e.statusText)}))})}},O={init:function(e){this.addpicker(),this.inputTime(e)},addpicker:function(){jQuery("#date_start").datetimepicker({mask:!1,step:5,onShow:function(e){var t,i=jQuery("#date_end").val();i&&(t=new Date(i),t.setDate(t.getDate())),this.setOptions({maxDate:i?t:!1})}}),jQuery("#date_end").datetimepicker({mask:!1,step:5,onShow:function(e){var t,i=jQuery("#date_start").val();i&&(t=new Date(i),t.setDate(t.getDate())),this.setOptions({minDate:i?t:!1})}})},getTaskTypes:function(t,i){"undefined"==typeof i&&(i=0),$("#taskTypes").empty(),$("<option value=0>choose a task type</option>").appendTo("#taskTypes");var o=e("task_types",t);o.then(function(e){$("#taskTypes").empty(),a(e,"#taskTypes","<option value=0>choose a task type</option>"),i>0&&$("#taskTypes").val(i),reveal()},function(){console.log("fail @ task types")})},chooseProjects:function(t,i){"undefined"==typeof t&&(t=0),"undefined"==typeof i&&(i=0);var o=$("#timeAccounts").val();isProject?($("#timeProjects").on("change",function(){var e=$("#timeProjects").val();O.getTaskTypes({account:o,project:e},i)}),$("#timeProjects").empty(),$("<option value=0>choose a project</option>").appendTo("#timeProjects"),"0"!==o?($("#loading").fadeIn(),e("accounts/"+o,{is_with_statistics:!1}).then(function(e){a(e.projects,"#timeProjects"),$("#timeProjects").val(t),O.getTaskTypes({account:o,project:t},i),reveal()},function(){console.log("fail @ time accounts"),reveal()})):$("#timeProjects").parent().show()):O.getTaskTypes({account:o},i)},inputTime:function(t){{var i=localStorage.getItem("ticketNumber"),a=!0;(new Date).toJSON().slice(0,10)}if($("#submitTicketTime").click(function(){var t=$("#addTimeTicket").val(),o=htmlEscape($("#noteTimeTicket").val().trim()),n=localStorage.getItem("techId"),s=$("#ticketTaskTypes").val();if(o.length<1)return void J.showMessage(!1,"Please enter note");if(o.length>5e3)return void J.showMessage(!1,"Note cannot be more than 5000 chars!");a=$(".innerCircle").hasClass("billFill")?!0:!1;var c,l=jQuery("#date_start").val();l&&(c=JSON.stringify(new Date(l)));var r,u=jQuery("#date_end").val();u&&(r=JSON.stringify(new Date(u))),e("time",{ticket_key:i,note_text:o,task_type_id:s,hours:t,is_billable:a,date:l?c:"",start_date:l?c:"",stop_date:u?r:"",tech_id:n},"POST").then(function(e){localStorage.setItem("isMessage","truePos"),localStorage.setItem("userMessage",'Time was successfully added <i class="fa fa-thumbs-o-up"></i>'),window.location.replace("ticket_detail.html")},function(e,t,i){alert(t)})}),$("#submitTicketTime").length)O.getTaskTypes({ticket:i},0);else{var o,n=localStorage.getItem("timeNumber");if(t&&n&&(o=JSON.parse(n),o.billable||$(".innerCircle").removeClass("billFill"),$("#noteTime").val(o.note),$("#addTimeTicket").val(o.hours),$(".title").html("Time #"+o.time_id+" by "+o.user_name+" @ "+new Date(o.date).dateFormat("Y/m/d H:i")),o.start_time&&$("#date_start").val(new Date(o.start_time).dateFormat("Y/m/d H:i")),o.stop_time&&$("#date_end").val(new Date(o.stop_time).dateFormat("Y/m/d H:i"))),isProject){var s="<option value=0>choose a project</option>";$(s).appendTo("#timeProjects")}else $("#timeProjects").parent().hide();$("#taskTypes").empty(),$("<option value=0>choose a task type</option>").appendTo("#taskTypes"),isAccount?e("accounts?limit=300",{is_with_statistics:!1}).then(function(e){$("#timeAccounts").empty();var t="<option value=0>choose an account</option>";

$(t).appendTo("#timeAccounts");for(var i=0;i<e.length;i++){var a=e[i].id,n=e[i].name,s="<option value="+a+">"+n+"</option>";$(s).appendTo("#timeAccounts")}var c=localStorage.DetailedAccount?localStorage.DetailedAccount:-1,l=0,r=0;o&&(c=o.account_id,l=o.project_id,r=o.task_type_id),$("#timeAccounts").val(c),O.chooseProjects(l,r),reveal()},function(){console.log("fail @ time accounts")}):($("#timeAccounts").parent().hide(),reveal()),$("#timeAccounts").on("change",function(){O.chooseProjects(0,o?o.task_type_id:0)}),$("#submitTime").click(function(){var n=$("#addTimeTicket").val(),s=htmlEscape($("#noteTime").val().trim()),c=localStorage.getItem("userId"),l=$("#timeAccounts").val(),r=$("#timeProjects").val(),u=$("#taskTypes").val();a=$(".innerCircle").hasClass("billFill")?!0:!1;var d,m=jQuery("#date_start").val();m&&(d=JSON.stringify(new Date(m)));var g,h=jQuery("#date_end").val();return h&&(g=JSON.stringify(new Date(h))),0===n?void J.showMessage(!1,"Oops not enough time"):"0"==l?void J.showMessage(!1,"choose an account"):(i=parseInt(t?o.ticket_id:i),void e("time"+(t?"/"+o.time_id:""),{tech_id:t?o.user_id:c,project_id:r,is_project_log:!i,ticket_id:i,account_id:l,note_text:s,task_type_id:u,hours:n,is_billable:a,date:m?d:"",start_date:m?d:"",stop_date:h?g:""},t?"PUT":"POST").then(function(e){localStorage.setItem("isMessage","truePos"),localStorage.setItem("userMessage",'Time was successfully added <i class="fa fa-thumbs-o-up"></i>'),window.history.back()},function(e,t,i){alert(t)}))})}}},P={init:function(){isTech?$("#closeu").hide():($(".tabs").hide(),$("#closeu").show()),isExpenses||$(".expense").hide(),this.showTicket()},showTicket:function(){"truePos"==localStorage.getItem("isMessage")&&J.showMessage(!0),$("html,body").css("scrollTop","0"),e("tickets/"+localStorage.getItem("ticketNumber")).then(function(t){var i=t.daysold_in_minutes/-60;localStorage.setItem("techId",t.tech_id),localStorage.setItem("ticketId",t.id),$(".expense").attr("href","addExpence.html?ticket="+t.id),i>24?(i/=24,i=parseInt(i),i+=" days ago"):i=parseInt(i)+" hours ago","Closed"==t.status?($("#closeIt").hide(),$("#closeu").hide()):$("#openIt").hide();var n=t.total_hours;$("#ticketNumber").html(t.status+" | "+t.number),$("#ticketSubject").html(t.subject),$("#ticketClass").html(t.class_name),$("#ticketTech").html(t.tech_firstname),$("#lastUpdate").html(i),t.misc_cost?$("#expenses").html("Expenses: "+localStorage.currency+Number(t.misc_cost).toFixed(2).toString()):$("#expenses").hide(),0!==n?$("#ticketHours").html(n+" Hours"):$("#ticketHours").hide(),null===t.sla_complete_date?$("#ticketSLA").hide():$("#ticketSLA").html("SLA: "+t.sla_complete_date.toString().substring(0,10));var s=t.tech_email;s==localStorage.getItem("userName")&&$("#pickUp").hide();var l=e("classes"),r=e("priorities");if($("#ticketLevel").empty(),isLevel){var u=e("levels");u.done(function(e){a(e,"#ticketLevel","","Level: ")>0&&$("#ticketLevel").val(t.level)})}else $("#ticketLevel").parent().hide();$("#classOptions").empty(),l.done(function(e){c=t.class_id,o(e,"#classOptions","<option data-classId="+t.class_id+" value="+t.class_id+">Class: "+t.class_name+"</option>")}),$("#ticketPriority").empty(),r.done(function(e){for(var i="",a=0;a<e.length;a++)i+="<option value="+e[a].id+">Priority: "+e[a].priority_level+" - "+e[a].name+"</option>";$(i).appendTo("#ticketPriority"),$("#ticketPriority").val(t.priority_id)}),$("#ticketTechs").empty();for(var d=0;d<t.technicians.length;d++){var m=t.technicians[d].user_fullname,g=t.technicians[d].user_id,h="<option value="+g+">"+m+"</option>";$(h).appendTo("#ticketTechs")}if($("#location").remove(),isProject){var p=e("projects");p.done(function(e){a(e,"#ticketProject",""==t.project_name?"<option value='null' disabled selected>Project</option>":"")>0&&""!=t.project_name&&$("#ticketProject").val(t.project_id)})}else $("#project").hide();$(".updateButton").click(function(){var t=c,i=$("#ticketLevel").val(),a=$("#ticketPriority").val(),o=$("#ticketProject").val(),n={class_id:t,level_id:i,priority_id:a,project_id:o},s="tickets/"+localStorage.getItem("ticketId"),l=e(s,n,"PUT");l.then(function(e){console.log("Then Complete"),J.setMessage(!0,"Ticket was successfully updated <i class='fa fa-thumbs-o-up'></i>"),window.location="ticket_detail.html",J.showMessage(!0)})}),$("#comments").empty();for(var f=1;f<t.ticketlogs.length;f++){var v=$.md5(t.ticketlogs[f].user_email),k=t.ticketlogs[f].log_type,S=t.ticketlogs[f].user_firstname+" "+t.ticketlogs[f].user_lastname,T=t.ticketlogs[f].note,w=t.ticketlogs[f].record_date.toString().substring(0,10);w=_(w);var I=[];if(null!=t.attachments)for(var y=0;y<t.attachments.length;y++)T.indexOf(t.attachments[y].name)>=0&&I.push(t.attachments[y].url);var h="<ul class='commentBlock'><li><img src='http://www.gravatar.com/avatar/"+v+"?d=mm&s=80' class='commentImg'></li><li class='commentText'><h3>"+S+"</h3></li><li><span>"+w+"</span></li><li class='commentText'><p>"+$("<span />",{html:T.replace(/<br\s*[\/]?>/gi,"\n")}).text().replace(/\n/g,"<p></p>")+"</p></li><li>"+k+"</li></ul>";$(h).appendTo("#comments");for(var b=0;b<I.length;b++){h="";var L;L=checkURL(I[b])?'<img class="attachment" src="'+I[b]+'">':"<img style='float:none;' src='img/file.png'>&nbsp;"+I[b].split("/").slice(-1)+"<p></p>",h=isPhonegap?'<a class="comment_image_link" href=# onclick=\'openURL("'+I[b]+"\")'>"+L+"</a>":'<a class="comment_image_link" target="_blank" href="'+I[b]+'">'+L+"</a>",$(h).appendTo("#comments")}I.length>0&&(borderInsert="<div class='attachmentBorder'></div>",$(borderInsert).appendTo("#comments"))}$(".orginalMessageContainer").empty();var x=$.md5(t.ticketlogs[0].user_email),O=t.ticketlogs[0].record_date.toString().substring(0,10);O=_(O);var T=t.ticketlogs[0].note,I=[];if(null!=t.attachments)for(var y=0;y<t.attachments.length;y++)if(T.indexOf(t.attachments[y].name)>=0){var L;L=checkURL(t.attachments[y].url)?'<img class="attachment" src="'+t.attachments[y].url+'">':"<img style='float:none;' src='img/file.png'>&nbsp;"+t.attachments[y].name+"<p></p>",isPhonegap?I[y]='<a class="comment_image_link" href=# onclick=\'openURL("'+t.attachments[y].url+"\")'>"+L+"</a>":I[y]='<a class="comment_image_link" target="_blank" href="'+t.attachments[y].url+'">'+L+"</a>",$(I[y]).error(function(){I[y]="0"})}var P="<ul class='commentBlock'><li><img src='http://www.gravatar.com/avatar/"+x+"?d=mm&s=80' class='commentImg'></li><li class='commentText'><h3>"+t.ticketlogs[0].user_firstname+" "+t.ticketlogs[0].user_lastname+"</h3></li><li><span>"+O+"</span></li><li class='commentText'><p>"+$("<span />",{html:t.ticketlogs[0].note.replace(/<br\s*[\/]?>/gi,"\n")}).text().replace(/\n/g,"<p></p>")+"</p></li><li>"+t.ticketlogs[0].log_type+"</li></ul></div>";if($(P).appendTo(".orginalMessageContainer"),null!=t.attachments)for(var b=0;b<I.length;b++){var A=I[b];$(A).appendTo(".orginalMessageContainer")}reveal()},function(){console.log("fail @ Ticket Detail"),localStorage.setItem("ticketId",""),window.location="ticket_list.html"})}},A={init:function(){this.specifics()},specifics:function(){$(document).on("click",".invoiceRows",function(){localStorage.setItem("invoiceNumber",$(this).attr("data-id")),window.location="invoice.html"}),e("invoices/"+localStorage.getItem("invoiceNumber")).then(function(e){localStorage.setItem("invoiceAccountId",e.account_id),localStorage.setItem("invoiceProjectId",e.project_id),$("#invoiceNumber").html("Invoice  #"+e.id);var t=e.customer;t=createElipse(t,.7,12),$("#customerName").html(t);var i=e.date.substring(0,10);i=_(i),$("#invoiceDate").html(i),$("#invoiceHours").html(e.total_hours+"<span class='detail3Small'>hrs</span>");var a=0,o=".00",n=e.amount.toString().length;if(e.amount.toString().indexOf(".")>=0?(a=e.amount.toString().substring(0,n-3),o="."+e.amount.toString().substring(n-2,n),o.indexOf("..")>=0&&(o="."+e.total_cost.toString().substring(n-1,n)+"0")):a=e.amount,$("#invoiceAmount").html(localStorage.getItem("currency")+a+"<span class='detail3Small'>"+o+"</span>"),isTravelCosts?$("#invoiceTravel").html(localStorage.getItem("currency")+e.travel_cost+"<span class='detail3Small'>.00</span>"):$("#invoiceTravel").parent().parent().hide(),isExpenses){var s=0;if(null!=e.expenses)for(var c=0;c<e.expenses.length;c++)s+=e.expenses[c].total;$("#invoiceExpenses").html(localStorage.getItem("currency")+s+"<span class='detail3Small'>.00</span>")}else $("#invoiceExpenses").parent().parent().hide();if($("#invoiceAdjustments").html(localStorage.getItem("currency")+"0<span class='detail3Small'>.00</span>"),a=Number(e.total_cost).toFixed(2).toString(),o=a.substring(a.length-3,a.length),a=a.substring(0,a.length-3),$(".invoiceTotal").html(localStorage.getItem("currency")+a+"<span class='detail3Small'>"+o+"</span>"),$("#recipientList").empty(),null!=e.recipients&&e.recipients.length>0)for(var l=0;l<e.recipients.length;l++){var r=$.md5(e.recipients[l].email),u="<li><ul class='recipientDetail'><li><img src='http://www.gravatar.com/avatar/"+r+"?d=mm&s=80'></li><li><div class='recipient'><p>"+e.recipients[l].email+"</p>"+(e.recipients[l].is_accounting_contact?"<img class='closeIcon' id=\""+e.recipients[l].email+"\"  src='img/close_icon.png'>":'<img class=plusIcon id="'+e.recipients[l].email+"\" src='img/plus_icon.png'>")+"</div></li></ul></li>";$(u).appendTo("#recipientList")}else{var u="<li><h3 class=noDataMessage>No accounting contacts found.<p>&nbsp;</p></h3></li>";$(u).appendTo("#recipientList"),$("#sendInvoiceButton").remove()}if(createSpan("#recipientList"),$("#invoiceLogs").empty(),null!=e.time_logs)for(var d=0;d<e.time_logs.length;d++){var m=e.time_logs[d].name,g=e.time_logs[d].total,i=_(e.time_logs[d].date.substring(0,10)),h=e.time_logs[d].id,u="<li><ul id='invoiceTimelog' data-id='"+h+"' data-info='"+JSON.stringify(e.time_logs[d]).replace(/'/g,"")+"'  class='timelog'><li><div class='billable timeLogAddButton' data-id='"+h+"'><div class='innerCircle billFill'></div></div></li><li><h2 class='feedName'>"+m+"</h2><p class='taskDescription'>"+i+"</p></li><li><img class='feedClock' src='img/clock_icon_small.png'><h3 class='feedTime'><span>"+g+"</span></h3></li></ul></li>";$(u).appendTo("#invoiceLogs")}if(null!=e.recipients){$("#expensesList").empty();for(var p=0;p<e.expenses.length;p++){var m=e.expenses[p].name,g=e.expenses[p].total,i=_(e.expenses[p].date.substring(0,10)),h=e.expenses[p].id,u="<li><ul id='invoiceExpense' class='timelog1'><li><div class='billable timeLogAddButton' data-id='"+h+"'><div class='innerCircle billFill'></div></div></li><li><h2 class='feedName'>"+m+"</h2><p class='taskDescription'>"+i+"</p></li><li><h3 class='feedTime expenceCost'><span>$"+g+"</span></h3></li></ul></li>";$(u).appendTo("#expensesList")}}reveal()},function(){console.log("fail @ Invoice details")})}},N={init:function(e){this.listInvoices(e)},listInvoices:function(t){var i=[];$("#invoiceOption").click(function(){window.location="Invoice_List.html"}),$("#allInvoice, #invoiceFooter").click(function(){window.location="allInvoice_List.html"}),e("invoices",{account:t}).then(function(e){if($("#invoiceList").empty(),0==e.length)return $('<h3 class="noDataMessage">no invoices at this time</h3>').prependTo("#invoiceList"),createSpan("#invoiceList"),void reveal();"undefined"==typeof e.length&&(e=[e]);for(var a=0;a<e.length;a++){var o=e[a].customer,n=e[a].date.substring(0,10);n=_(n),o=createElipse(o,.33,12);var s="<ul data-id="+e[a].id+" class='invoiceRows item'><li class=user_name>"+o+"</li><li class=responseText>"+n+"</li><li>$"+Number(e[a].total_cost).toFixed(2)+"</li></ul>";$(s).appendTo("#invoiceList"),t||i.push(s)}t||localStorage.setItem("storageInvoices",JSON.stringify(i)),createSpan("#invoiceList"),reveal(),filterList("tabpageContainer")},function(){console.log("fail @ Invoice List")})}},C={init:function(){$(".title").html("Tickets @ "+localStorage.getItem("currentQueueName")+" Queue"),this.queueTickets(),$("#ticketCreate").click(function(){localStorage.setItem("add_user_techid",localStorage.getItem("currentQueue")),localStorage.setItem("add_user_accountid",account),window.location.replace("add_tickets.html".addUrlParam("page",getPage()[2]))})},queueTickets:function(){var t=localStorage.getItem("currentQueue");t||(console.log("fail @ Queues tickets"),window.history.back()),e("queues/"+t).then(function(e){console.log(e),j.createTicketsList(e,"#queueTickets"),filterList("queueTickets"),reveal();var i,a=localStorage.getItem("storageQueues");a&&(match=new RegExp('"'+t+",(\\d+)").exec(a),match&&(a=JSON.parse(a),i=a[Number(match[1])],i&&(a[Number(match[1])].tickets_count=e.length,localStorage.setItem("storageQueues",JSON.stringify(a)))))},function(){console.log("fail @ Queues tickets")})}},M={init:function(e,t){cacheName="storageQueues",M.queues(t,e)},queues:function(t,i){var a=localStorage.getItem("storageQueues"),o=cacheTime;a&&(a=JSON.parse(a)),void 0==a||null==a||0==a.length?(console.log("could not load local data"),o=10):(M.createQueuesList(i,a,t),t||createSpan(i)),setTimeout(function(){e("queues",{sort_by:"tickets_count"}).then(function(e){M.createQueuesList(i,e,t),localStorage.setItem("storageQueues",JSON.stringify(e)),reveal(),t||(createSpan(i),filterList("OptionsList"))},function(){console.log("fail @ Queues List")})},o)},createQueuesList:function(e,t,i){for(var a=0,o=0,n=[],s=t.length,c=$(e),l=0;s>l;l+=1)0==t[l].fullname.toLowerCase().indexOf("new ticket")&&(a=t[l].tickets_count),t[l].index=t[l].id+","+l,i&&t[l].tickets_count<1||i&&o>=i||(n.push("<li class=item><div id='queue' data-id="+t[l].id+" class='OptionWrapper'><h3 class='OptionTitle user_name'>"+t[l].fullname+"</h3></div><div class='NotificationWrapper'><h2>"+t[l].tickets_count+"</h2></div></li>"),s>10&&10==l&&c.html(n.join("")),o+=1);c.html(n.join("")),localStorage.badge=a}},j={init:function(){isTech?(this.userTickets(),this.techTickets(),this.altTickets(),this.allTickets()):(this.userTickets(),$("#userContainer").css("padding-top","20px"),$("#tabpage_reply").fadeIn())},createTicketsList:function(e,t,i){var a=$(t);if(a.empty(),!e||e.length<1)a.html('<h1 class="noTicketMessage">No Tickets</h1>');else{for(var o=[],n=e.length,s=0;n>s;s+=1){var c=$.md5(e[s].user_email),l=e[s].initial_post,r=e[s].subject;e[s].index=e[s].key+","+s;var u=e[s].key;r=createElipse(r,.7,12);var d=e[s].is_new_tech_post&&e[s].technician_email!=localStorage.userName||e[s].is_new_user_post&&e[s].user_email!=localStorage.userName?"<i class='fa fa-envelope-o' style='color: #25B0E6;'></i> ":"";l.length>150&&(l=l.substring(0,150)+"..."),l=$("<span />",{html:l.replace(/<br\s*[\/]?>/gi,"\n")}).text(),o.push("<ul class='responseBlock item' id='thisBlock' data-id="+u+"><li><p class='blockNumber numberStyle'>#"+e[s].number+"</p><img src='http://www.gravatar.com/avatar/"+c+"?d=mm&s=80' class='TicketBlockFace'><span class=user_name>"+e[s].user_firstname+"</span></li><li class='responseText'><h4>"+d+r+"</h4><p class ='initailPost'>"+l+"</p></li><li><p class='TicketBlockNumber'>"+e[s].class_name+"</p></li></ul>"),n>10&&10==s&&(a.html(o.join("")),o=[])}a.append(o.join("")),createSpan(t),void 0!==i&&i&&localStorage.setItem(i+"tickets",JSON.stringify(e))}},techTickets:function(){var t="tech",i=localStorage.getItem(t+"tickets"),a=cacheTime;i&&(i=JSON.parse(i)),void 0==i||null==i||0==i.length?(console.log("could not load local data"),a=10):(j.createTicketsList(i,"#techContainer"),featureList2=filterList("techContainer","",localStorage.getItem("searchItem"))),setTimeout(function(){e("tickets?status=open&limit=100&role=tech").then(function(e){j.createTicketsList(e,"#techContainer",t),featureList2=filterList("techContainer","",localStorage.getItem("searchItem"))},function(){console.log("fail @ tech ticket List")})},a)},allTickets:function(){var t="all",i=localStorage.getItem(t+"tickets"),a=cacheTime;i&&(i=JSON.parse(i)),void 0==i||null==i||0==i.length?(console.log("could not load local data"),a=10):(j.createTicketsList(i,"#allContainer"),featureList3=filterList("allContainer","",localStorage.getItem("searchItem"))),setTimeout(function(){e("tickets?status=allopen&limit=100&query=all").then(function(e){j.createTicketsList(e,"#allContainer",t),featureList3=filterList("allContainer","",localStorage.getItem("searchItem")),localStorage.setItem("searchItem",""),reveal()},function(){console.log("fail @ all ticket List")})},a)},altTickets:function(){var t="alt",i=localStorage.getItem(t+"tickets"),a=cacheTime;i&&(i=JSON.parse(i)),void 0==i||null==i||0==i.length?(console.log("could not load local data"),a=10):(j.createTicketsList(i,"#altContainer"),featureList4=filterList("altContainer","",localStorage.getItem("searchItem"))),setTimeout(function(){e("tickets?status=open&limit=100&role=alt_tech").then(function(e){j.createTicketsList(e,"#altContainer",t),featureList4=filterList("altContainer","",localStorage.getItem("searchItem"))},function(){console.log("fail @ alt ticket List")})},a)},userTickets:function(){$("maxSize").hide();var t="user",i=localStorage.getItem(t+"tickets"),a=cacheTime;i&&(i=JSON.parse(i)),void 0==i||null==i||0==i.length?(console.log("could not load local data"),a=10):(j.createTicketsList(i,"#userContainer"),featureList5=filterList("userContainer","",localStorage.getItem("searchItem"))),setTimeout(function(){e("tickets?status=open,onhold&limit=100&role=user").then(function(e){j.createTicketsList(e,"#userContainer",t),featureList5=filterList("userContainer","",localStorage.getItem("searchItem"))},function(){console.log("fail @ user ticket List")})},a)}};String.format=function(e){var t=Array.prototype.slice.call(arguments,1);return e.replace(/{(\d+)}/,function(e,i){return"undefined"!=typeof t[i]?t[i]:e})};var D={init:function(e,t){cacheName="storageAccountList",D.listAccounts(e,t)},listAccounts:function(t,i){var a=cacheTime,o=localStorage.getItem("storageAccountList");o&&(o=JSON.parse(o)),void 0==o||null==o||0==o.length?(console.log("could not load local data"),a=10):(i?(cacheName="dash",D.createDashAccountsList(t,o)):D.createAccountsList(t,o),reveal()),setTimeout(function(){e("accounts?limit=300").then(function(e){i?D.createDashAccountsList(t,e):D.createAccountsList(t,e),localStorage.setItem("storageAccountList",JSON.stringify(e)),reveal()},function(){console.log("fail @ listAccounts")})},a)},createAccountsList:function(e,t){if(t.length<1){var i='<h1 class="noTicketMessage">No Accounts</h1>';$(i).html(e)}else{for(var a=[],o=t.length,n=$(e),s=0;o>s;s+=1){t[s].index=t[s].id+","+s;var c=t[s].account_statistics.ticket_counts.open,l=t[s].name;l=createElipse(l,.75,12),a.push("<ul class='listedAccount item' data-id="+t[s].id+"><li class=user_name>"+l+"</li><li><div class='tks' "+(c>99?"style='height: 42px;'>99<sup>+</sup>":">"+c)+"</div></li></ul>"),o>10&&10==s&&n.html(a.join(""))}n.html(a.join("")),createSpan(e),filterList("ActiveAccountsContainer")}},createDashAccountsList:function(e,t){for(var i=["<ul class='tableHeader'><li></li><li>Hours</li><li>Expenses</li><li>Tkts</li></ul>"],a=t.length,o=$(e),n=0;a>n;n+=1){t[n].index=t[n].id+","+n;var s=t[n].account_statistics.ticket_counts.open;if(!(1>s)){var c=t[n].name;c=createElipse(c,.3,12);var l=t[n].account_statistics.hours;l>999&&(l=999),i.push("<ul class='tableRows clickme' data-id="+t[n].id+"><li>"+c+"</li><li>"+l+"</li><li>"+localStorage.getItem("currency")+Number(t[n].account_statistics.expenses).toFixed(2)+"</li><li><div class='tks1 "+(s>99?"overflowTickets' style='height: 42px;'>99<sup>+</sup>":"'>"+s)+"</div></li></ul>"),a>10&&10==n&&o.html(i.join(""))}}o.html(i.join(""))}};$(document).on("click",".timelog",function(){localStorage.setItem("timeNumber",$(this).attr("data-info")),window.location="edit_time.html"});var E={init:function(){this.getLogs()},getLogs:function(){e("time",{limit:200}).then(function(e){if($("#timelogs").empty(),e.length<1){var t='<h1 class="noTicketMessage">No Timelogs</h1>';$(t).appendTo("#timelogs")}else for(var i=0;i<e.length;i++){var a=$.md5(e[i].user_email),o=e[i].note,n=e[i].time_id,s=e[i].hours;s=s.toString();var c=e[i].user_name;o=createElipse(o,.5,8),s.indexOf(".")>=0||(s+=".00"),c=createElipse(c,.5,12);var l="<li class=item><ul class='timelog' data-id="+n+" data-info='"+JSON.stringify(e[i]).replace(/'/g,"")+"'> <li><img class='timelogProfile' src='http://www.gravatar.com/avatar/"+a+"?d=mm&s=80'></li><li><h2 class='feedName user_name'>"+c+"</h2><p class='taskDescription responseText'>"+o+"</p></li><li><img class='feedClock'src='img/clock_icon_small.png'><h3 class='feedTime'><span>"+s+"</span></h3></li></ul></li>";$(l).appendTo("#timelogs"),9==i&&reveal()}createSpan("#timelogs"),reveal(),e.length>1&&filterList("timelogs")},function(){console.log("fail @ timelogs")})}},B={init:function(){var e=localStorage.getItem("DetailedAccount");localStorage.setItem("addAccountTicket",e),this.pageSetup()},createAccDetails:function(e){var t=e.account_statistics.hours,i=e.account_statistics.ticket_counts.open,a=e.account_statistics.invoices;$("#AD").html(e.name),$("#ticketsOptionTicker").html(i>999?999:i),$("#invoiceOptionTicker").html(a>999?999:a),$("#timesOptionTicker").html(t>999?999:t)},pageSetup:function(){var t,i,a=localStorage.getItem("DetailedAccount"),o=localStorage.getItem("account"+a+"tickets"),n=cacheTime,s=cacheTime,c=localStorage.getItem("storageAccountList");c&&(i=new RegExp('"'+a+",(\\d+)").exec(c),i&&(c=JSON.parse(c),t=c[Number(i[1])])),o?(o=JSON.parse(o),j.createTicketsList(o,".AccountDetailsTicketsContainer"),filterList("AccountDetailsTicketsContainer")):(s=10,console.log("could not load local account tickets data")),void 0==t||null==t||0==t.length?(console.log("could not load local account details data"),n=10):(B.createAccDetails(t),reveal()),setTimeout(function(){e("accounts/"+a).then(function(e){B.createAccDetails(e),t&&(c[Number(i[1])].account_statistics=e.account_statistics,localStorage.setItem("storageAccountList",JSON.stringify(c)))},function(){console.log("fail @ accounts")})},n),setTimeout(function(){e("tickets?status=open&account="+a).then(function(e){j.createTicketsList(e,".AccountDetailsTicketsContainer","account"+a),filterList("AccountDetailsTicketsContainer")},function(){console.log("fail @ accounts")})},s)}},U={init:function(){$("#addTimeAccount").click(function(){window.location="add_time.html"}),this.getTimeLogs()},getTimeLogs:function(){var t=localStorage.getItem("DetailedAccount");t||(t=-1),e("time?account="+t).then(function(e){$("#accountLogs").empty();for(var t=0;t<e.length;t++){var i=$.md5(e[t].user_email),a=e[t].note,o=e[t].hours;o=o.toString(),o.indexOf(".")<0&&(o+=".00"),a=createElipse(a,.5,8);var n=e[t].user_name;n=createElipse(n,.5,12);var s="<li><ul class='timelog' data-info='"+JSON.stringify(e[t]).replace(/'/g,"")+"'> <li><img class='timelogProfile' src='http://www.gravatar.com/avatar/"+i+"?d=mm&s=80'></li><li><h2 class='feedName'>"+n+"</h2><p class='taskDescription'>"+a+"</p></li><li><img class='feedClock'src='img/clock_icon_small.png'><h3 class='feedTime'><span>"+o+"</span></h3></li></ul></li>";$(s).appendTo("#accountLogs")}},function(){console.log("fail @ timelogs")})}},K={init:function(){$("html,body").css("scrollTop","0");var t=10,i=localStorage.ticketsStat;i&&(i=JSON.parse(i)),i?K.setTicketCounts(i):console.log("no cache TicketsCounts"),setTimeout(function(){e("tickets/counts").then(function(e){K.setTicketCounts(e),reveal(),localStorage.setItem("ticketsStat",JSON.stringify(e))},function(){console.log("fail @ get TicketsCounts")})},t)},setTicketCounts:function(e){var t=e.open_all;t>100?t="99<sup>+</sup>":$("#all").removeClass("headerOverflowTickets"),$("#all").html(t),$("#userStat").html(e.open_as_user),$("#techStat").html(e.open_as_tech),$("#altStat").html(e.open_as_alttech)}},F=function(t,i,a,o){"undefined"==typeof a&&(a=!0),t&&i||(t=localStorage.getItem("userOrgKey"),i=localStorage.getItem("userInstanceKey")),t&&i&&e("config").then(function(e){localStorage.setItem("userRole",e.user.is_techoradmin?"tech":"user"),isTech=e.user.is_techoradmin,localStorage.setItem("projectTracking",e.is_project_tracking),localStorage.setItem("timeTracking",e.is_time_tracking),localStorage.setItem("accountManager",e.is_account_manager),localStorage.setItem("ticketLevels",e.is_ticket_levels),localStorage.setItem("classTracking",e.is_class_tracking),localStorage.setItem("locationTracking",e.is_location_tracking),localStorage.setItem("freshbooks",e.is_freshbooks),localStorage.setItem("is_invoice",e.is_invoice),localStorage.setItem("is_expenses",e.is_expenses),localStorage.setItem("is_travel_costs",e.is_travel_costs),localStorage.setItem("currency",e.currency),localStorage.setItem("userFullName",e.user.firstname+" "+e.user.lastname),localStorage.setItem("userId",e.user.user_id),o&&"function"==typeof o?o():getInfo4Extension(),a&&(isTech?window.location="dashboard.html":window.location="ticket_list.html")},function(e,t,i){console.log("fail @ config")})},R={init:function(){return location.pathname.indexOf("org.html")<0?void 0:($(".instSelect").hide(),(d=localStorage.getItem("userKey"))?(l=localStorage.getItem("userOrgKey"),u=localStorage.getItem("userInstanceKey"),localStorage.setItem("userRole","user"),l&&u?void F(l,u):void this.getOrg()):void(window.location="index.html"))},getOrg:function(){$(".page").show(),$("#loading").show(),d=localStorage.getItem("userKey"),$.ajax({type:"GET",beforeSend:function(e){e.withCredentials=!0,e.setRequestHeader("Authorization","Basic "+btoa("x:"+d))},url:ApiSite+"organizations/",async:!0,cache:!1,dataType:"json",success:function(e){if(e.length>1){localStorage.setItem("sd_is_MultipleOrgInst","true");for(var t=e,i=0;i<t.length;i++){var a="<li class=item><div id='org' data-id="+i+" class='OptionWrapper1'><h3 class='OptionTitle user_name'>"+t[i].name+"</h3></div></li>";$("#orgsPage").append(a)}$(document).on("click","#org",function(){var t=$(this).attr("data-id");l=e[t].key,r=e[t].name;var i=e[t].instances;if(localStorage.setItem("userOrgKey",l),localStorage.setItem("userOrg",r),0==i.length)return void J.showMessage(!1,"You are not associated with any Instance in the Organization or your account is inactivated in the Instances.");if(1==i.length)u=i[0].key,localStorage.setItem("userInstanceKey",u),F(l,u);else{$("div.OptionWrapper1[data-id!='"+t+"']").parent().remove();for(var a=0;a<i.length;a++){var o="<li class=item><div id='inst' data-id="+a+" class='OptionWrapper2'><h3 class='OptionTitle user_name'>"+i[a].name+"</h3></div></li>";$("#instsPage").append(o)}$(".instSelect").show(),$(document).on("click","#inst",function(){var e=i[$(this).attr("data-id")].key;localStorage.setItem("userInstanceKey",e),localStorage.setItem("sd_is_MultipleOrgInst","true"),$("#loading").show(),F(l,e)})}})}if(1==e.length){l=e[0].key,r=e[0].name,localStorage.setItem("userOrgKey",l),localStorage.setItem("sd_is_MultipleOrgInst","false"),localStorage.setItem("userOrg",r);var a="<li class=item><div id='org' data-id=0 class='OptionWrapper1'><h3 class='OptionTitle user_name'>"+e[0].name+"</h3></div></li>";$("#orgsPage").append(a);var o=e[0].instances;if(1==o.length)u=o[0].key,localStorage.setItem("userInstanceKey",u),F(l,u);else{for(var i=0;i<o.length;i++){var a="<li class=item><div id='inst' data-id="+i+" class='OptionWrapper2'><h3 class='OptionTitle user_name'>"+o[i].name+"</h3></div></li>";$("#instsPage").append(a)}$(".instSelect").show(),$(document).on("click","#inst",function(){var e=o[$(this).attr("data-id")].key;localStorage.setItem("userInstanceKey",e),localStorage.setItem("sd_is_MultipleOrgInst","true"),$("#loading").show(),F(l,e)})}}},complete:function(){l=localStorage.getItem("userOrgKey"),u=localStorage.getItem("userInstanceKey"),l&&u||reveal()},error:function(){console.log("fail @ getOrg"),logout()}})}},W={init:function(){this.justClicked()},justClicked:function(){$createButton=$("#ticketCreate"),$createButton&&$createButton.click(function(){window.location.replace("add_tickets.html".addUrlParam("page",getPage()[2]))}),$("#invoiceOption").click(function(){window.location="Invoice_List.html"}),$("#allInvoice, #invoiceFooter").click(function(){window.location="allInvoice_List.html"}),$(document).on("click",".invoiceRows",function(){localStorage.setItem("invoiceNumber",$(this).attr("data-id")),window.location="invoice.html"}),$(document).on("click",".tableRows, .listedAccount",function(){localStorage.setItem("DetailedAccount",$(this).attr("data-id")),window.location="account_details.html"}),$(document).on("click",".responseBlock",function(){localStorage.setItem("ticketNumber",$(this).attr("data-id")),window.location="ticket_detail.html"}),$(document).on("click","#queue",function(){localStorage.setItem("currentQueue",$(this).attr("data-id")),localStorage.setItem("currentQueueName",$(this).find(".OptionTitle").text()),window.location="queueTickets.html"}),$(document).on("click","#asUserStat",function(){localStorage.setItem("ticketPage","asUser"),window.location="ticket_list.html"}),$(document).on("click","#techStat",function(){localStorage.setItem("ticketPage","asTech"),window.location="ticket_list.html"}),$(document).on("click","#asAltTechStat",function(){localStorage.setItem("ticketPage","asAltTech"),window.location="ticket_list.html"}),$(document).on("click","#allTicketsStat",function(){localStorage.setItem("ticketPage","allTickets"),window.location="ticket_list.html"})},menuFunctions:function(){var e=localStorage.getItem("techStat");null==e?$(".menuTicketsStat").hide():(e>100&&(e=99),$(".menuTicketStatNumber").html(e))}},J={init:function(){this.showMessage()},setMessage:function(e,t,i){localStorage.setItem("userMessage",t),localStorage.setItem("isMessage",e?"truePos":"trueNeg")},showMessage:function(e,t,i){if("undefined"==typeof e){var a=localStorage.getItem("isMessage");if("truePos"==a)e=!0,localStorage.setItem("isMessage","false");else{if("trueNeg"!=a)return;e=!1,localStorage.setItem("isMessage","false")}}"undefined"==typeof t&&(t=localStorage.getItem("userMessage"));var o=e?".errorMessagePos":".errorMessageNeg";$(o).html(t),$(o).slideDown(100),setTimeout(function(){$(o).slideUp(100),"function"==typeof i&&i()},3500)}};!function(){if(J.init(),m.init(),R.init(),g.init(),w.init(),location.pathname.indexOf("index.html")<0&&"/"!=location.pathname&&location.pathname.indexOf("org.html")<0){var e=navigator.userAgent.match(/iphone|ipad|ipod/i)&&parseInt(navigator.appVersion.match(/OS (\d)/)[1],10)>=7;if(e){var t=document.getElementsByTagName("header")[0];t&&(t.style.paddingTop="10px",t.style.height="63px",$("body").css("margin-top",function(e,t){return parseInt(t,10)+10+"px"})),t=document.getElementById("ptr"),t&&(t.style.marginTop="10px")}if(T.init(),W.init(),localStorage.lastclick){if(((new Date).valueOf()-Date.parse(localStorage.lastclick).valueOf())/60>1200)return localStorage.lastclick=new Date,void F("","",!1,n)}else localStorage.lastclick=new Date;n()}}()});